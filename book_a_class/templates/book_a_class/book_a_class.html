{% extends "base.html" %}
{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='styles_class_ingred.css') }}">
{% endblock %}

{% block content %}
<div class="container" style="margin-top: 32px; margin-left: auto; margin-right: auto; max-width: 1200px;">
  <h1 class="mb-4" style="font-weight: bold; text-align: left;">Book a Class</h1>
  <div class="row">
    <!-- Left Column: Booking Form & Calculated Ingredients -->
    <div class="col-md-5">
      <div class="card mb-4 p-3">
        <form id="bookingForm">
          <div class="mb-3">
            <label for="staff" class="form-label">Staff</label>
            <select id="staff" name="staff" class="form-select">{# staff options #}</select>
          </div>
          <div class="mb-3">
            <label for="classcode" class="form-label">Class</label>
            <select id="classcode" name="classcode" class="form-select">{# class options #}</select>
          </div>
          <div class="mb-3">
            <label for="recipeSelect" class="form-label">Choose recipe</label>
            <select id="recipeSelect" name="recipe" class="form-select">{# recipe options #}</select>
          </div>
          <div class="mb-3">
            <label for="date" class="form-label">Date required</label>
            <input type="date" id="date" name="date" class="form-control" value="{{ pre_date_required or '' }}" />
          </div>
          <div class="mb-3">
            <label for="period" class="form-label">Class slot (period)</label>
            <select id="period" name="period" class="form-select">
              <option value="1"{% if pre_period == '1' %} selected{% endif %}>Period 1</option>
              <option value="2"{% if pre_period == '2' %} selected{% endif %}>Period 2</option>
              <option value="3"{% if pre_period == '3' %} selected{% endif %}>Period 3</option>
              <option value="4"{% if pre_period == '4' %} selected{% endif %}>Period 4</option>
              <option value="5"{% if pre_period == '5' %} selected{% endif %}>Period 5</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="desiredServings" class="form-label">Servings</label>
            <input type="number" id="desiredServings" name="desiredServings" class="form-control" value="{{ pre_servings or 24 }}" min="1" />
          </div>
          <button id="saveBtn" class="btn btn-success mb-2">Save booking</button>
        </form>
        <hr />
        <h5>Calculated Ingredients</h5>
        <div class="text-muted small">Single serving amounts multiplied by desired servings</div>
        <ul id="calcList" class="mb-0"></ul>
      </div>
    </div>
    <!-- Right Column: Scheduled Bookings Table -->
    <div class="col-md-7">
      <div class="card p-3">
        <h3 class="mb-3">Scheduled Bookings</h3>
        <div class="text-muted small mb-3">Click any booking to edit its details</div>
        {% if bookings and bookings|length > 0 %}
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Period</th>
                  <th>Staff</th>
                  <th>Class</th>
                  <th>Recipe</th>
                  <th>Servings</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for booking in bookings %}
                <tr class="booking-row" data-booking-id="{{ booking.id }}" 
                    data-staff="{{ booking.staff_code }}" 
                    data-class="{{ booking.class_code }}" 
                    data-date="{{ booking.date_required }}" 
                    data-period="{{ booking.period }}" 
                    data-recipe="{{ booking.recipe_id }}" 
                    data-servings="{{ booking.desired_servings }}">
                  <td>{{ booking.date_required }}</td>
                  <td>{{ booking.period }}</td>
                  <td>{{ booking.staff_code }}{% if booking.first_name %} - {{ booking.last_name }}, {{ booking.first_name }}{% endif %}</td>
                  <td>{{ booking.class_code }}</td>
                  <td>{{ booking.recipe_name or 'N/A' }}</td>
                  <td>{{ booking.desired_servings }}</td>
                  <td>
                    <button class="btn btn-primary btn-sm btn-edit-booking" type="button" onclick="editBooking(this); event.stopPropagation();">Edit</button>
                    <button class="btn btn-danger btn-sm btn-delete-booking" data-booking-id="{{ booking.id }}" onclick="deleteBooking({{ booking.id }}); event.stopPropagation();">Delete</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted small">No bookings found. Create a booking using the form above.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
  {% endblock %}
{% block scripts %}
<script>
const recipes = {{ recipes|tojson | safe }};
const preRecipeId = {{ pre_recipe_id|tojson if pre_recipe_id is defined else 'null' }};
const preServings = {{ pre_servings|tojson if pre_servings is defined else 'null' }};

function editBooking(btn) {
  // Find the row
  const row = btn.closest('tr');
  if (!row) return;
  // Extract data attributes
  const staff = row.getAttribute('data-staff');
  const classcode = row.getAttribute('data-class');
  const date = row.getAttribute('data-date');
  const period = row.getAttribute('data-period');
  const recipeId = row.getAttribute('data-recipe');
  const servings = row.getAttribute('data-servings');
  // Populate form fields
  document.getElementById('staff').value = staff;
  document.getElementById('classcode').value = classcode;
  document.getElementById('date').value = date;
  document.getElementById('period').value = period;
  document.getElementById('recipeSelect').value = recipeId;
  document.getElementById('desiredServings').value = servings;
  // Set editing mode for Save button
  const saveBtn = document.getElementById('saveBtn');
  if(saveBtn) {
    saveBtn.dataset.editingBookingId = row.getAttribute('data-booking-id');
    saveBtn.textContent = 'Update booking';
    saveBtn.classList.add('btn-update');
  }
  // Render ingredients and calculated list
  const rec = findRecipe(parseInt(recipeId));
  renderOriginalIngredients(rec);
  calculate();
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
  // Highlight the row
  document.querySelectorAll('.booking-row').forEach(r => r.classList.remove('selected'));
  row.classList.add('selected');
}

function findRecipe(id){
  if(!recipes) return null;
  return recipes.find(r=> String(r.id) == String(id));
}

function renderOriginalIngredients(recipe){
  const ul = document.getElementById('origList');
  if(!ul) return;
  ul.innerHTML = '';
  if(!recipe) return;
  if(!recipe.ingredients || recipe.ingredients.length === 0){
    ul.innerHTML = '<li>No structured ingredients available.</li>';
    return;
  }
  recipe.ingredients.forEach(it => {
    const li = document.createElement('li');
    if(typeof it === 'object'){
      let q = it.quantity || '';
      let u = it.unit || '';
      let name = it.ingredient || '';
      if((!u || u==='') && name){
        const parsed = extractFromText(name);
        if(parsed.unit && !u) u = parsed.unit;
        if((!q || q==='') && parsed.quantity !== null) q = parsed.quantity;
        if(parsed.name) name = parsed.name;
      }
      li.textContent = ((q || u) ? ((q !== '' ? q + ' ' : '') + (u ? u + ' ' : '')) : '') + name;
    } else {
      const parsed = extractFromText(String(it));
      const display = ((parsed.quantity !== null) ? (parsed.quantity + ' ' + (parsed.unit || '')) : '') + (parsed.name ? ' ' + parsed.name : '');
      li.textContent = display.trim();
    }
    ul.appendChild(li);
  });
}

function parseNumber(s){
  if(s === null || s === undefined) return null;
  s = String(s).trim();
  if(!s) return null;
  const n = parseFloat(s.replace(',', '.'));
  if(!isNaN(n)) return n;
  const m = s.match(/(\d+[\.,]?\d*)/);
  if(m) return parseFloat(m[1].replace(',', '.'));
  return null;
}

function extractFromText(text){
  if(!text) return {quantity:null, unit:'', name:text};
  const unitsList = ['kg','g','grams','gram','ml','l','tbsp','tablespoon','tablespoons','tsp','teaspoon','teaspoons','cup','cups','oz','lb','gms','gm'];
  const m = String(text).trim().match(/^(\d+[\.,]?\d*)\s*([a-zA-Z]+)?\s*(.*)$/);
  if(m){
    let q = parseNumber(m[1]);
    let u = (m[2] || '').toLowerCase();
    let rest = (m[3] || '').trim();
    if(u === 'grams') u = 'g';
    if(u === 'gram') u = 'g';
    if(u === 'gms') u = 'g';
    if(u === 'gm') u = 'g';
    if(u === 'tablespoon' || u === 'tablespoons') u = 'tbsp';
    if(u === 'teaspoon' || u === 'teaspoons') u = 'tsp';
    return {quantity: q, unit: u, name: rest};
  }
  return {quantity:null, unit:'', name:text};
}

function calculate(){
  const sel = document.getElementById('recipeSelect');
  const rid = sel ? sel.value : null;
  const desiredEl = document.getElementById('desiredServings');
  const desired = desiredEl ? (parseFloat(desiredEl.value) || 24) : 24;
  const rec = findRecipe(parseInt(rid));
  const out = document.getElementById('calcList');
  if(!out) return;
  out.innerHTML = '';
  if(!rec){
    out.innerHTML = '<li>Select a recipe first.</li>';
    return;
  }
  const origServ = parseInt(rec.serving_size) || 1;
  rec.ingredients.forEach(it => {
    let name = '';
    let qty = null;
    let unit = '';
    if(typeof it === 'object'){
      name = it.ingredient || '';
      qty = parseNumber(it.quantity);
      unit = it.unit || '';
      if((qty === null || !unit) && name){
        const parsed = extractFromText(name);
        if(qty === null && parsed.quantity !== null) qty = parsed.quantity;
        if((!unit || unit==='') && parsed.unit) unit = parsed.unit;
        if(parsed.name) name = parsed.name;
      }
    } else {
      const parsed = extractFromText(String(it));
      name = parsed.name || String(it);
      qty = parsed.quantity;
      unit = parsed.unit || '';
    }
    let perSingle = null;
    if(qty !== null && origServ > 0){
      perSingle = qty / origServ;
    }
    const scaled = (perSingle !== null) ? (perSingle * desired) : null;
    const li = document.createElement('li');
    if(scaled !== null){
      let display = Math.round((scaled + Number.EPSILON) * 100) / 100;
      if(Number.isInteger(display)) display = parseInt(display);
      li.textContent = display + (unit ? (' ' + unit) : '') + ' ' + name;
    } else {
      li.textContent = name;
    }
    out.appendChild(li);
  });
}

document.addEventListener('DOMContentLoaded', function() {
  const recipeSelect = document.getElementById('recipeSelect');
  if(recipeSelect){
    recipeSelect.addEventListener('change', function(){
      const rec = findRecipe(parseInt(this.value));
      renderOriginalIngredients(rec);
    });
  }
  const calcBtn = document.getElementById('calcBtn');
  if(calcBtn) calcBtn.addEventListener('click', calculate);

  const saveBtn = document.getElementById('saveBtn');
  if(saveBtn) saveBtn.addEventListener('click', function(){
    const staff = document.getElementById('staff') ? document.getElementById('staff').value : '';
    const classcode = document.getElementById('classcode') ? document.getElementById('classcode').value : '';
    const date = document.getElementById('date') ? document.getElementById('date').value : '';
    const period = document.getElementById('period') ? document.getElementById('period').value : '';
    const rid = document.getElementById('recipeSelect') ? document.getElementById('recipeSelect').value : null;
    const desired = document.getElementById('desiredServings') ? (parseFloat(document.getElementById('desiredServings').value) || 24) : 24;
    if(!rid) { alert('Select a recipe first'); return; }
    const bookingId = saveBtn.dataset.editingBookingId || null;
    fetch('/class_ingredients/save', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        booking_id: bookingId,
        staff: staff, 
        classcode: classcode, 
        date: date, 
        period: period, 
        recipe_id: rid, 
        desired_servings: desired
      })
    }).then(r=>r.json()).then(j=>{
      if(j.success){ 
        alert(bookingId ? 'Booking updated!' : 'Booking saved (id: ' + j.booking_id + ')');
        location.reload();
      } else { 
        alert('Save failed'); 
      }
    }).catch(e=> alert('Error: ' + e.message));
  });

  (function(){
    const dateEl = document.getElementById('date');
    if(dateEl && !dateEl.value){
      const d = new Date();
      const iso = d.toISOString().slice(0,10);
      dateEl.value = iso;
    }
  })();

  if(preRecipeId){
    const recipeSelect = document.getElementById('recipeSelect');
    if(recipeSelect){
      recipeSelect.value = preRecipeId;
    }
    const rec = findRecipe(preRecipeId);
    renderOriginalIngredients(rec);
    setTimeout(calculate, 100);
  }

  const bookingRows = document.querySelectorAll('.booking-row');
  bookingRows.forEach(row => {
    row.addEventListener('click', function() {
      const bookingId = this.dataset.bookingId;
      const staff = this.dataset.staff;
      const classCode = this.dataset.class;
      const date = this.dataset.date;
      const period = this.dataset.period;
      const recipeId = this.dataset.recipe;
      const servings = this.dataset.servings;
      document.getElementById('staff').value = staff;
      document.getElementById('classcode').value = classCode;
      document.getElementById('date').value = date;
      document.getElementById('period').value = period;
      document.getElementById('recipeSelect').value = recipeId;
      document.getElementById('desiredServings').value = servings;
      const saveBtn = document.getElementById('saveBtn');
      if(saveBtn) {
        saveBtn.dataset.editingBookingId = bookingId;
        saveBtn.textContent = 'Update booking';
        saveBtn.classList.add('btn-update');
      }
      const rec = findRecipe(parseInt(recipeId));
      renderOriginalIngredients(rec);
      calculate();
      window.scrollTo({ top: 0, behavior: 'smooth' });
      bookingRows.forEach(r => r.classList.remove('selected'));
      this.classList.add('selected');
    });
  });
});

function deleteBooking(bookingId) {
  if(!confirm('Are you sure you want to delete this booking?')) return;
  fetch('/class_ingredients/delete/' + bookingId, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'}
  }).then(r => r.json()).then(j => {
    if(j.success) {
      alert('Booking deleted');
      location.reload();
    } else {
      alert('Delete failed');
    }
  }).catch(e => alert('Error: ' + e.message));
}




  function parseNumber(s){
    if(s === null || s === undefined) return null;
    s = String(s).trim();
    if(!s) return null;
    const n = parseFloat(s.replace(',', '.'));
    if(!isNaN(n)) return n;
    const m = s.match(/(\d+[\.,]?\d*)/);
    if(m) return parseFloat(m[1].replace(',', '.'));
    return null;
  }

  // Try to extract quantity, unit and name from free-text like '40g oats' or '40 g oats'
  function extractFromText(text){
    if(!text) return {quantity:null, unit:'', name:text};
    const unitsList = ['kg','g','grams','gram','ml','l','tbsp','tablespoon','tablespoons','tsp','teaspoon','teaspoons','cup','cups','oz','lb','gms','gm'];
    const m = String(text).trim().match(/^(\d+[\.,]?\d*)\s*([a-zA-Z]+)?\s*(.*)$/);
    if(m){
      let q = parseNumber(m[1]);
      let u = (m[2] || '').toLowerCase();
      let rest = (m[3] || '').trim();
      if(u === 'grams') u = 'g';
      if(u === 'gram') u = 'g';
      if(u === 'gms') u = 'g';
      if(u === 'gm') u = 'g';
      if(u === 'tablespoon' || u === 'tablespoons') u = 'tbsp';
      if(u === 'teaspoon' || u === 'teaspoons') u = 'tsp';
      return {quantity: q, unit: u, name: rest};
    }
    return {quantity:null, unit:'', name:text};
  }

  function calculate(){
    const sel = document.getElementById('recipeSelect');
    const rid = sel ? sel.value : null;
    const desiredEl = document.getElementById('desiredServings');
    const desired = desiredEl ? (parseFloat(desiredEl.value) || 24) : 24;
    const rec = findRecipe(parseInt(rid));
    const out = document.getElementById('calcList');
    if(!out) return;
    out.innerHTML = '';
    if(!rec){
      out.innerHTML = '<li>Select a recipe first.</li>';
      return;
    }
    const origServ = parseInt(rec.serving_size) || 1;
    rec.ingredients.forEach(it => {
      let name = '';
      let qty = null;
      let unit = '';
      if(typeof it === 'object'){
        name = it.ingredient || '';
        qty = parseNumber(it.quantity);
        unit = it.unit || '';
        // try to extract missing info from name
        if((qty === null || !unit) && name){
          const parsed = extractFromText(name);
          if(qty === null && parsed.quantity !== null) qty = parsed.quantity;
          if((!unit || unit==='') && parsed.unit) unit = parsed.unit;
          if(parsed.name) name = parsed.name;
        }
      } else {
        const parsed = extractFromText(String(it));
        name = parsed.name || String(it);
        qty = parsed.quantity;
        unit = parsed.unit || '';
      }
      let perSingle = null;
      if(qty !== null && origServ > 0){
        perSingle = qty / origServ;
      }
      const scaled = (perSingle !== null) ? (perSingle * desired) : null;
      const li = document.createElement('li');
      if(scaled !== null){
        let display = Math.round((scaled + Number.EPSILON) * 100) / 100;
        if(Number.isInteger(display)) display = parseInt(display);
        li.textContent = display + (unit ? (' ' + unit) : '') + ' ' + name;
      } else {
        li.textContent = name;
      }
      out.appendChild(li);
    });
  }

  const recipeSelect = document.getElementById('recipeSelect');
  if(recipeSelect){
    recipeSelect.addEventListener('change', function(){
      const rec = findRecipe(parseInt(this.value));
      renderOriginalIngredients(rec);
    });
  }
  const calcBtn = document.getElementById('calcBtn');
  if(calcBtn) calcBtn.addEventListener('click', calculate);

  const saveBtn = document.getElementById('saveBtn');
  if(saveBtn) saveBtn.addEventListener('click', function(){
    const staff = document.getElementById('staff') ? document.getElementById('staff').value : '';
    const classcode = document.getElementById('classcode') ? document.getElementById('classcode').value : '';
    const date = document.getElementById('date') ? document.getElementById('date').value : '';
    const period = document.getElementById('period') ? document.getElementById('period').value : '';
    const rid = document.getElementById('recipeSelect') ? document.getElementById('recipeSelect').value : null;
    const desired = document.getElementById('desiredServings') ? (parseFloat(document.getElementById('desiredServings').value) || 24) : 24;
    if(!rid) { alert('Select a recipe first'); return; }
    
    // Check if we're editing an existing booking
    const bookingId = saveBtn.dataset.editingBookingId || null;
    
    fetch('/class_ingredients/save', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        booking_id: bookingId,
        staff: staff, 
        classcode: classcode, 
        date: date, 
        period: period, 
        recipe_id: rid, 
        desired_servings: desired
      })
    }).then(r=>r.json()).then(j=>{
      if(j.success){ 
        alert(bookingId ? 'Booking updated!' : 'Booking saved (id: ' + j.booking_id + ')');
        // Reload page to show updated bookings
        location.reload();
      } else { 
        alert('Save failed'); 
      }
    }).catch(e=> alert('Error: ' + e.message));
  });

  // set default date to today's date (unless pre-populated)
  (function(){
    const dateEl = document.getElementById('date');
    if(dateEl && !dateEl.value){
      const d = new Date();
      const iso = d.toISOString().slice(0,10);
      dateEl.value = iso;
    }
  })();

  // If pre-populated from booking, auto-render the recipe and calculate
  if(preRecipeId){
    const recipeSelect = document.getElementById('recipeSelect');
    if(recipeSelect){
      recipeSelect.value = preRecipeId;
    }
    const rec = findRecipe(preRecipeId);
    renderOriginalIngredients(rec);
    // Schedule calculate to run after a slight delay to ensure DOM is ready
    setTimeout(calculate, 100);
  }

  // Add click handlers for booking rows to load them for editing
  const bookingRows = document.querySelectorAll('.booking-row');
  bookingRows.forEach(row => {
    row.addEventListener('click', function() {
      const bookingId = this.dataset.bookingId;
      const staff = this.dataset.staff;
      const classCode = this.dataset.class;
      const date = this.dataset.date;
      const period = this.dataset.period;
      const recipeId = this.dataset.recipe;
      const servings = this.dataset.servings;
      
      // Populate form fields
      document.getElementById('staff').value = staff;
      document.getElementById('classcode').value = classCode;
      document.getElementById('date').value = date;
      document.getElementById('period').value = period;
      document.getElementById('recipeSelect').value = recipeId;
      document.getElementById('desiredServings').value = servings;
      
      // Store booking ID for update
      const saveBtn = document.getElementById('saveBtn');
      if(saveBtn) {
        saveBtn.dataset.editingBookingId = bookingId;
        saveBtn.textContent = 'Update booking';
        saveBtn.classList.add('btn-update');
      }
      
      // Render the recipe and calculate
      const rec = findRecipe(parseInt(recipeId));
      renderOriginalIngredients(rec);
      calculate();
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      // Highlight the row
      bookingRows.forEach(r => r.classList.remove('selected'));
      this.classList.add('selected');
    });
  });
});

// Delete booking function
function deleteBooking(bookingId) {
  if(!confirm('Are you sure you want to delete this booking?')) return;
  
  fetch('/class_ingredients/delete/' + bookingId, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'}
  }).then(r => r.json()).then(j => {
    if(j.success) {
      alert('Booking deleted');
      location.reload();
    } else {
      alert('Delete failed');
    }
  }).catch(e => alert('Error: ' + e.message));
}
</script>
{% endblock %}
