{% extends "base.html" %}
{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='styles_class_ingred.css') }}">
{% endblock %}
{% block content %}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div style="margin-bottom: 18px;">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}" style="padding: 10px 18px; border-radius: 6px; background: #e6f7ea; color: #256029; border: 1px solid #b7e4c7; margin-bottom: 6px;">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
<div class="container" style="max-width: 900px; margin: 0 auto; padding: 24px 0;">
  <h1 style="font-size: 2.2em; font-weight: bold; margin-bottom: 18px;">Book a Class</h1>
  <style>
        .sort-active {
          color: #007bff !important;
          font-weight: bold;
        }
    .container { margin-left: 24px; margin-right: 24px; }
  </style>
  <form id="bookingForm" method="post" style="background: #f8fafc; border-radius: 10px; box-shadow: 0 2px 8px #e0e4ea; padding: 18px 24px 12px 24px; margin-bottom: 28px;">
    {% set edit_id = request.args.get('edit_booking_id') or request.form.get('edit_booking_id') or pre_edit_booking_id %}
    {% if edit_id %}
      <input type="hidden" name="edit_booking_id" value="{{ edit_id }}">
    {% endif %}
    <div style="display: flex; flex-wrap: wrap; gap: 18px 32px; align-items: flex-end;">
      <div>
        <label for="staff">Staff</label><br>
        <select id="staff" name="staff" required style="min-width: 160px;">
          <option value="">-- Choose staff --</option>
          {% for s in staff %}
            <option value="{{ s.code }}" {% if pre_staff_code == s.code %}selected{% endif %}>{{ s.last_name }}, {{ s.first_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="classcode">Class</label><br>
        <select id="classcode" name="classcode" required style="min-width: 120px;">
          <option value="">-- Choose class --</option>
          {% for c in classes %}
            <option value="{{ c.classcode }}" {% if pre_class_code == c.classcode %}selected{% endif %}>{{ c.classcode }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="date">Date</label><br>
        <input type="date" id="date" name="date" required style="min-width: 130px;" value="{{ pre_date_required|default('') }}">
      </div>
      <div>
        <label for="period">Period</label><br>
        <select id="period" name="period" required style="min-width: 80px;">
          <option value="">--</option>
          <option value="1" {% if pre_period == '1' %}selected{% endif %}>1</option>
          <option value="2" {% if pre_period == '2' %}selected{% endif %}>2</option>
          <option value="3" {% if pre_period == '3' %}selected{% endif %}>3</option>
          <option value="4" {% if pre_period == '4' %}selected{% endif %}>4</option>
          <option value="5" {% if pre_period == '5' %}selected{% endif %}>5</option>
        </select>
      </div>
      <div>
        <label for="recipeSelect">Recipe</label><br>
        <select id="recipeSelect" name="recipe" required style="min-width: 180px;">
          <option value="">-- Choose recipe --</option>
          {% for r in recipes %}
            <option value="{{ r.id }}" {% if pre_recipe_id == r.id %}selected{% endif %}>{{ r.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="classSize">Class Size</label><br>
        <input type="number" id="classSize" name="class_size" min="1" value="{{ pre_class_size|default(24) }}" style="min-width: 80px;">
      </div>
      <!-- Desired Servings field removed as requested -->
      <div style="flex: 1 1 100px; text-align: right;">
        <button type="submit" id="saveBtn" class="btn btn-primary" style="margin-right: 8px;">Save booking</button>
        <button type="button" class="btn btn-secondary" id="reset-btn">RESET</button>
      </div>
    </div>
    <div style="display: flex; gap: 32px; margin-top: 18px;">
      <div style="flex: 1 1 220px;">
        <ul id="origList" style="margin-bottom: 0;"></ul>
      </div>
      <div style="flex: 1 1 220px;">
        <ul id="calcList" style="margin-bottom: 0;"></ul>
      </div>
    </div>
  </form>

  <h2 style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px;">Scheduled Bookings</h2>
    <form method="get" style="margin-bottom: 12px; display: flex; gap: 12px; align-items: center;">
      <input type="text" name="search" value="{{ request.args.get('search', '') }}" class="form-control" style="max-width: 220px; display: inline-block;" placeholder="Search bookings...">
      <select name="sort" class="form-control" style="max-width: 120px;">
        <option value="date_required" {% if request.args.get('sort', 'date_required') == 'date_required' %}selected{% endif %}>Date</option>
        <option value="period" {% if request.args.get('sort') == 'period' %}selected{% endif %}>Period</option>
        <option value="staff" {% if request.args.get('sort') == 'staff' %}selected{% endif %}>Staff</option>
        <option value="class" {% if request.args.get('sort') == 'class' %}selected{% endif %}>Class</option>
        <option value="class_size" {% if request.args.get('sort') == 'class_size' %}selected{% endif %}>Class Size</option>
        <option value="recipe" {% if request.args.get('sort') == 'recipe' %}selected{% endif %}>Recipe</option>
      </select>
      <select name="dir" class="form-control" style="max-width: 90px;">
        <option value="desc" {% if request.args.get('dir', 'desc') == 'desc' %}selected{% endif %}>Desc</option>
        <option value="asc" {% if request.args.get('dir') == 'asc' %}selected{% endif %}>Asc</option>
      </select>
      <button type="submit" class="btn btn-primary">Apply</button>
    </form>
    <div style="overflow-x: auto;">
      <table class="table table-striped" id="bookingsTable" style="min-width: 700px; background: #fff; border-radius: 8px; box-shadow: 0 1px 2px #e0e4ea;">
        <thead>
          <tr style="background: #f3f6fa;">
            <th>Date</th>
            <th>Period</th>
            <th>Staff</th>
            <th>Class</th>
            <th>Class Size</th>
            <th>Recipe</th>
            <th> </th>
          </tr>
        </thead>
        <tbody>
          {% for booking in bookings %}
          <tr class="booking-row"
            data-booking-id="{{ booking.id }}"
            data-staff="{{ booking.staff_code }}"
            data-class="{{ booking.class_code }}"
            data-date="{{ booking.date_required }}"
            data-period="{{ booking.period }}"
            data-recipe="{{ booking.recipe_id }}"
            data-class-size="{{ booking.class_size or 24 }}"
            >
            <td>{{ booking.date_required }}</td>
            <td>{{ booking.period }}</td>
            <td>{{ booking.first_name }} {{ booking.last_name }}</td>
            <td>{{ booking.class_code }}</td>
            <td>{{ booking.class_size or 24 }}</td>
            <td>{{ booking.recipe_name }}</td>
            <td>
              <form method="get" action="/book_a_class" style="display:inline;">
                <input type="hidden" name="edit_booking_id" value="{{ booking.id }}">
                <button type="submit" class="btn btn-sm btn-outline-primary edit-booking-btn">Edit</button>
              </form>
              <form method="post" action="/class_ingredients/delete/{{ booking.id }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this booking?');">
                {% if csrf_token %}{{ csrf_token() }}{% endif %}
                <button type="submit" class="btn btn-sm btn-outline-danger delete-booking-btn">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>

  {% endblock %}

<script>
// Combined DOMContentLoaded for search and reset
document.addEventListener('DOMContentLoaded', function() {
  // Search/filter for Scheduled Bookings table
  var searchInput = document.getElementById('bookingSearch');
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      var filter = searchInput.value.toLowerCase().replace(/\s+/g, ' ').trim();
      var table = document.getElementById('bookingsTable');
      var rows = table.tBodies[0].rows;
      for (var i = 0; i < rows.length; i++) {
        var rowText = rows[i].innerText.toLowerCase().replace(/\s+/g, ' ').trim();
        rows[i].style.display = rowText.indexOf(filter) > -1 ? '' : 'none';
      }
    });
  }
  // RESET button functionality for Book a Class form
  setTimeout(function() {
    const resetBtn = document.getElementById('reset-btn');
    if (resetBtn) {
      resetBtn.addEventListener('click', function() {
        const form = resetBtn.closest('form');
        if (form) {
          // Set staff to pre_staff_code
          const staffSelect = document.getElementById('staff');
          if (staffSelect) {
            const preStaff = '{{ pre_staff_code|escapejs }}';
            staffSelect.value = preStaff;
          }
          // Reset class, date, period, recipe, class size
          document.getElementById('classcode').selectedIndex = 0;
          document.getElementById('date').value = '';
          document.getElementById('period').selectedIndex = 0;
          document.getElementById('recipeSelect').selectedIndex = 0;
          document.getElementById('classSize').value = 24;
        }
      });
    }
  }, 0);
});

// Simple table sorting for Scheduled Bookings (global scope)
var sortDirections = {};
// Track the last sorted column for highlighting
var lastSortedCol = null;

function sortTable(col, type) {
  var table = document.getElementById('bookingsTable');
  var tbody = table.tBodies[0];
  var rows = Array.from(tbody.rows);
  sortDirections[col] = !sortDirections[col]; // toggle direction
  var dir = sortDirections[col] ? 1 : -1;
  rows.sort(function(a, b) {
    var aText = a.cells[col].innerText.trim();
    var bText = b.cells[col].innerText.trim();
    if(type === 'num') {
      aText = parseFloat(aText) || 0;
      bText = parseFloat(bText) || 0;
    } else if(type === 'date') {
      aText = Date.parse(aText) || 0;
      bText = Date.parse(bText) || 0;
    } else {
      aText = aText.toLowerCase();
      bText = bText.toLowerCase();
    }
    if(aText < bText) return -1 * dir;
    if(aText > bText) return 1 * dir;
    return 0;
  });
  rows.forEach(function(row) { tbody.appendChild(row); });

  // Highlight the active column header
  var ths = table.tHead.rows[0].cells;
  for (var i = 0; i < ths.length; i++) {
    ths[i].classList.remove('sort-active');
  }
  if (ths[col]) {
    ths[col].classList.add('sort-active');
  }
  lastSortedCol = col;
}





// Edit booking function
function editBooking(btn) {
  const row = btn.closest('tr');
  if (!row) return;
  // Extract data attributes
  const staff = row.getAttribute('data-staff');
  const classcode = row.getAttribute('data-class');
  const date = row.getAttribute('data-date');
  const period = row.getAttribute('data-period');
  const recipeId = row.getAttribute('data-recipe');
  const servings = row.getAttribute('data-servings');
  const classSize = row.getAttribute('data-class-size');
  // Populate form fields
  document.getElementById('staff').value = staff;
  document.getElementById('classcode').value = classcode;
  document.getElementById('date').value = date;
  document.getElementById('period').value = period;
  document.getElementById('recipeSelect').value = recipeId;
  document.getElementById('desiredServings').value = servings;
  document.getElementById('classSize').value = classSize;
  // Set editing mode for Save button
  const saveBtn = document.getElementById('saveBtn');
  if(saveBtn) {
    saveBtn.dataset.editingBookingId = row.getAttribute('data-booking-id');
    saveBtn.textContent = 'Update booking';
    saveBtn.classList.add('btn-update');
  }
  // Render ingredients and calculated list
  const rec = findRecipe(parseInt(recipeId));
  renderOriginalIngredients(rec);
  calculate();
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
  // Highlight the row
  document.querySelectorAll('.booking-row').forEach(r => r.classList.remove('selected'));
  row.classList.add('selected');
}

function findRecipe(id){
  if(!recipes) return null;
  return recipes.find(r=> String(r.id) == String(id));
}

function renderOriginalIngredients(recipe){
  const ul = document.getElementById('origList');
  if(!ul) return;
  ul.innerHTML = '';
  if(!recipe) return;
  if(!recipe.ingredients || recipe.ingredients.length === 0){
    ul.innerHTML = '<li>No structured ingredients available.</li>';
    return;
  }
  recipe.ingredients.forEach(it => {
    const li = document.createElement('li');
    if(typeof it === 'object'){
      let q = it.quantity || '';
      let u = it.unit || '';
      let name = it.ingredient || '';
      if((!u || u==='') && name){
        const parsed = extractFromText(name);
        if(parsed.unit && !u) u = parsed.unit;
        if((!q || q==='') && parsed.quantity !== null) q = parsed.quantity;
        if(parsed.name) name = parsed.name;
      }
      li.textContent = ((q || u) ? ((q !== '' ? q + ' ' : '') + (u ? u + ' ' : '')) : '') + name;
    } else {
      const parsed = extractFromText(String(it));
      const display = ((parsed.quantity !== null) ? (parsed.quantity + ' ' + (parsed.unit || '')) : '') + (parsed.name ? ' ' + parsed.name : '');
      li.textContent = display.trim();
    }
    ul.appendChild(li);
  });
}

function parseNumber(s){
  if(s === null || s === undefined) return null;
  s = String(s).trim();
  if(!s) return null;
  const n = parseFloat(s.replace(',', '.'));
  if(!isNaN(n)) return n;
  const m = s.match(/(\d+[\.,]?\d*)/);
  if(m) return parseFloat(m[1].replace(',', '.'));
  return null;
}

function extractFromText(text){
  if(!text) return {quantity:null, unit:'', name:text};
  const unitsList = ['kg','g','grams','gram','ml','l','tbsp','tablespoon','tablespoons','tsp','teaspoon','teaspoons','cup','cups','oz','lb','gms','gm'];
  const m = String(text).trim().match(/^(\d+[\.,]?\d*)\s*([a-zA-Z]+)?\s*(.*)$/);
  if(m){
    let q = parseNumber(m[1]);
    let u = (m[2] || '').toLowerCase();
    let rest = (m[3] || '').trim();
    if(u === 'grams') u = 'g';
    if(u === 'gram') u = 'g';
    if(u === 'gms') u = 'g';
    if(u === 'gm') u = 'g';
    if(u === 'tablespoon' || u === 'tablespoons') u = 'tbsp';
    if(u === 'teaspoon' || u === 'teaspoons') u = 'tsp';
    return {quantity: q, unit: u, name: rest};
  }
  return {quantity:null, unit:'', name:text};
}

function calculate(){
  const sel = document.getElementById('recipeSelect');
  const rid = sel ? sel.value : null;
  const desiredEl = document.getElementById('desiredServings');
  const desired = desiredEl ? (parseFloat(desiredEl.value) || 24) : 24;
  const rec = findRecipe(parseInt(rid));
  const out = document.getElementById('calcList');
  if(!out) return;
  out.innerHTML = '';
  if(!rec){
    out.innerHTML = '<li>Select a recipe first.</li>';
    return;
  }
  const origServ = parseInt(rec.serving_size) || 1;
  rec.ingredients.forEach(it => {
    let name = '';
    let qty = null;
    let unit = '';
    if(typeof it === 'object'){
      name = it.ingredient || '';
      qty = parseNumber(it.quantity);
      unit = it.unit || '';
      if((qty === null || !unit) && name){
        const parsed = extractFromText(name);
        if(qty === null && parsed.quantity !== null) qty = parsed.quantity;
        if((!unit || unit==='') && parsed.unit) unit = parsed.unit;
        if(parsed.name) name = parsed.name;
      }
    } else {
      const parsed = extractFromText(String(it));
      name = parsed.name || String(it);
      qty = parsed.quantity;
      unit = parsed.unit || '';
    }
    let perSingle = null;
    if(qty !== null && origServ > 0){
      perSingle = qty / origServ;
    }
    const scaled = (perSingle !== null) ? (perSingle * desired) : null;
    const li = document.createElement('li');
    if(scaled !== null){
      let display = Math.round((scaled + Number.EPSILON) * 100) / 100;
      if(Number.isInteger(display)) display = parseInt(display);
      li.textContent = display + (unit ? (' ' + unit) : '') + ' ' + name;
    } else {
      li.textContent = name;
    }
    out.appendChild(li);
  });
}




document.addEventListener('DOMContentLoaded', function() {
  populateDropdowns();
  // ...existing code...
});
</script>
 
<!-- Move search and sort JS to end of template for reliability -->
<script>
try {
  console.log('Book a Class: search and sort JS loaded');
  // Combined DOMContentLoaded for search and reset
  document.addEventListener('DOMContentLoaded', function() {
    // Search/filter for Scheduled Bookings table
    var searchInput = document.getElementById('bookingSearch');
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        var filter = searchInput.value.toLowerCase().replace(/\s+/g, ' ').trim();
        var table = document.getElementById('bookingsTable');
        var rows = table.tBodies[0].rows;
        for (var i = 0; i < rows.length; i++) {
          var rowText = rows[i].innerText.toLowerCase().replace(/\s+/g, ' ').trim();
          rows[i].style.display = rowText.indexOf(filter) > -1 ? '' : 'none';
        }
      });
    }
    // RESET button functionality for Book a Class form
    setTimeout(function() {
      const resetBtn = document.getElementById('reset-btn');
      if (resetBtn) {
        resetBtn.addEventListener('click', function() {
          const form = resetBtn.closest('form');
          if (form) {
            // Set staff to pre_staff_code
            const staffSelect = document.getElementById('staff');
            if (staffSelect) {
              const preStaff = '{{ pre_staff_code|escapejs }}';
              staffSelect.value = preStaff;
            }
            // Reset class, date, period, recipe, class size
            document.getElementById('classcode').selectedIndex = 0;
            document.getElementById('date').value = '';
            document.getElementById('period').selectedIndex = 0;
            document.getElementById('recipeSelect').selectedIndex = 0;
            document.getElementById('classSize').value = 24;
          }
        });
      }
    }, 0);
  });

  // Simple table sorting for Scheduled Bookings (global scope)
  var sortDirections = {};
  // Track the last sorted column for highlighting
  var lastSortedCol = null;
  window.sortTable = function(col, type) {
    var table = document.getElementById('bookingsTable');
    var tbody = table.tBodies[0];
    var rows = Array.from(tbody.rows);
    sortDirections[col] = !sortDirections[col]; // toggle direction
    var dir = sortDirections[col] ? 1 : -1;
    rows.sort(function(a, b) {
      var aText = a.cells[col].innerText.trim();
      var bText = b.cells[col].innerText.trim();
      if(type === 'num') {
        aText = parseFloat(aText) || 0;
        bText = parseFloat(bText) || 0;
      } else if(type === 'date') {
        aText = Date.parse(aText) || 0;
        bText = Date.parse(bText) || 0;
      } else {
        aText = aText.toLowerCase();
        bText = bText.toLowerCase();
      }
      if(aText < bText) return -1 * dir;
      if(aText > bText) return 1 * dir;
      return 0;
    });
    rows.forEach(function(row) { tbody.appendChild(row); });

    // Highlight the active column header
    var ths = table.tHead.rows[0].cells;
    for (var i = 0; i < ths.length; i++) {
      ths[i].classList.remove('sort-active');
    }
    if (ths[col]) {
      ths[col].classList.add('sort-active');
    }
    lastSortedCol = col;
  }
} catch (e) {
  console.error('Book a Class: search/sort JS error', e);
}
</script>
