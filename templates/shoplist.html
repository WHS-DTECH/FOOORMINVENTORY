<script>
function switchShoplistView(view) {
  const weekNav = document.getElementById('weekNav');
  const weekBtn = document.getElementById('weekViewBtn');
  const monthBtn = document.getElementById('monthViewBtn');
  if (view === 'week') {
    weekNav.style.display = '';
    weekBtn.classList.add('active');
    monthBtn.classList.remove('active');
    document.getElementById('weekPeriodView').style.display = '';
    document.getElementById('monthCalendarView').style.display = 'none';
  } else {
    weekNav.style.display = 'none';
    weekBtn.classList.remove('active');
    monthBtn.classList.add('active');
    document.getElementById('weekPeriodView').style.display = 'none';
    document.getElementById('monthCalendarView').style.display = '';
  }
}
// Ensure correct initial state on page load
window.addEventListener('DOMContentLoaded', function() {
  if (document.getElementById('monthViewBtn').classList.contains('active')) {
    switchShoplistView('month');
  } else {
    switchShoplistView('week');
  }
});
</script>
  <div id="weekNav" class="week-nav no-print" style="margin: 8px 0 8px 0; font-size: 1.15em; font-weight: bold; display: flex; flex-direction: column; align-items: center;">
    <div id="weekRangeLabel">{{ week_label | format_nz_week }}</div>
    <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 8px; margin-top: 8px;">
      <form method="get" style="margin: 0;">
        <button type="submit" name="nav" value="prev">&#8592; Previous</button>
      </form>
      <form method="get" style="margin: 0;">
        <button type="submit" name="nav" value="today">Today</button>
      </form>
      <form method="get" style="margin: 0;">
        <button type="submit" name="nav" value="next">Next &#8594;</button>
      </form>
    </div>
  </div>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book the Shopping</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="print-header" style="display:none;">
    <img src="{{ url_for('static', filename='images/whs logo circular reo .png') }}" alt="School Logo" style="height: 60px; float: left; margin-right: 18px;">
    <div style="font-size: 2em; font-weight: bold;">Book the Shopping</div>
    <div class="print-date" style="font-size: 1em; color: #444; margin-top: 4px;"><span id="printDate"></span></div>
    <div style="font-size: 1.1em; margin-top: 2px;">{{ week_label }}</div>
    <div style="clear: both;"></div>
    <hr style="margin: 12px 0;">
  </div>
  <nav class="navbar no-print">
    <div class="nav-left">
      <a href="/" class="nav-brand">üç≥ Food Room</a> |
      <a href="/recbk">Recipe Book</a> |
      <a href="/class_ingredients">Class Ingredients</a> |
      <!-- Booking Calendar link removed -->
      <a href="/shoplist">Shopping List</a>
      {% if current_user.is_admin() %}
        | <a href="/admin">Admin</a>
      {% endif %}
    </div>
    <div class="nav-right">
      {% if current_user.is_authenticated %}
        <span class="user-info">{{ current_user.name }}<span class="badge badge-{{ current_user.role }}">{{ current_user.role }}</span></span> | <a href="/logout" class="logout-link">Logout</a>
      {% else %}
        <a href="/login" class="login-link">Login</a>
      {% endif %}
    </div>
  </nav>


  <!-- Removed duplicate weekly dates above navigation -->
  <div style="display: flex; flex-direction: column; align-items: center; margin-top: 18px;">
    <h1 class="no-print" style="font-size: 2.3em; margin-bottom: 0;">Book the Shopping</h1>
  </div>
  <!-- Week navigation moved below view toggle and above period grid as per user request -->
    <!-- Selected Bookings panel moved up under the title -->
    <div id="selected-bookings-panel" class="popout-panel" style="margin-top: 18px; margin-bottom: 16px;">
      <div style="font-weight: bold; margin-bottom: 4px;">Selected Bookings</div>
      <div style="font-size: 0.95em; color: #444; margin-bottom: 8px;">Tap bookings in the grid to select them for the shopping list. Click Generate Shopping List.</div>
      <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
            <button onclick="saveShoppingList()" style="display:none;">üíæ Save List</button>
            <button onclick="loadShoppingList()" style="display:none;">üìÇ Load Saved</button>
            <button onclick="exportShoppingListCsv()" style="display:none;">üìÑ Export CSV</button>
            <button class="primary" onclick="window.print()" style="display:none;">üñ®Ô∏è Print</button>
            <!-- Print Shopping List Only button moved below the grid -->
            <button onclick="selectAllWeek()">Select All</button>
            <button onclick="clearAllSelections()">Clear</button>
            <button class="primary" id="autoGenerateBtn" style="background: #ff851b; color: #fff; border: 1px solid #ff851b;" onclick="autoGenerateWeek()">Auto Generate</button>
            <span style="flex: 1 1 auto;"></span>
            <button class="primary" id="generateShoppingListBtn" style="background: #0074d9; color: #fff; border: 1px solid #0074d9;" onclick="generateShoppingList()">Generate Shopping List</button>
            <button class="primary" id="addToGoogleCalendarBtn" style="background: #34a853; color: #fff; border: 1px solid #34a853;" onclick="addToGoogleCalendar()">Add to Google Calendar</button>
            <button class="primary" id="showScheduledBookingsBtn" style="background: #1976d2; color: #fff; border: 1px solid #1976d2; margin-left: 8px;" onclick="showScheduledBookingsModal()">Scheduled Bookings</button>
          </div>

          <!-- Scheduled Bookings Modal -->
          <div id="scheduledBookingsModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; overflow:auto; background:rgba(0,0,0,0.4);">
            <div class="modal-content" style="background:#f9f9f9; margin:60px auto; padding:30px 24px 18px 24px; border-radius:8px; max-width:900px; box-shadow:0 8px 32px rgba(0,0,0,0.18); position:relative;">
              <span id="closeScheduledBookingsModal" style="position:absolute; top:12px; right:18px; font-size:28px; color:#888; cursor:pointer;">&times;</span>
              <h2 style="margin-top:0; color:#1976d2;">Scheduled Bookings</h2>
              <div id="scheduledBookingsTableContainer">
                <div style="text-align:center; color:#888;">Loading...</div>
              </div>
            </div>
          </div>

          <script>
          function showScheduledBookingsModal() {
            document.getElementById('scheduledBookingsModal').style.display = 'block';
            loadScheduledBookings();
          }
          document.getElementById('closeScheduledBookingsModal').onclick = function() {
            document.getElementById('scheduledBookingsModal').style.display = 'none';
          }
          window.onclick = function(event) {
            if (event.target === document.getElementById('scheduledBookingsModal')) {
              document.getElementById('scheduledBookingsModal').style.display = 'none';
            }
          }
          function loadScheduledBookings() {
            fetch('/api/scheduled_bookings').then(r => r.json()).then(data => {
              if (!data.success) {
                document.getElementById('scheduledBookingsTableContainer').innerHTML = '<div style="color:#a94442;">Failed to load bookings.</div>';
                return;
              }
              const bookings = data.bookings;
              if (!bookings.length) {
                document.getElementById('scheduledBookingsTableContainer').innerHTML = '<div style="color:#888;">No bookings found.</div>';
                return;
              }
              let html = '<div style="overflow-x:auto;"><table style="width:100%; border-collapse:collapse; background:#fff;"><thead><tr style="background:#1976d2; color:#fff;"><th>Date</th><th>Period</th><th>Staff</th><th>Class</th><th>Recipe</th><th>Servings</th></tr></thead><tbody>';
              for (const b of bookings) {
                html += `<tr><td>${b.date_required}</td><td>${b.period}</td><td>${b.staff_display}</td><td>${b.class_code}</td><td>${b.recipe_name}</td><td>${b.servings}</td></tr>`;
              }
              html += '</tbody></table></div>';
              document.getElementById('scheduledBookingsTableContainer').innerHTML = html;
            });
          }
          </script>
          <script>
          function addToGoogleCalendar() {
            fetch('/shoplist/add_to_gcal', { method: 'POST' })
              .then(async response => {
                let data;
                try {
                  data = await response.json();
                } catch (err) {
                  // If response is not JSON, show a generic error
                  alert('Error: Unexpected response from server. Please ensure you are logged in with Google.');
                  return;
                }
                if (data.success) {
                  alert('Bookings added to your Google Calendar!');
                } else {
                  alert('Error: ' + (data.error || 'Could not add to Google Calendar.'));
                }
              })
              .catch(err => alert('Error: ' + err));
          }
          </script>
      </div>
      <div id="selected-bookings-list" style="font-size: 0.97em;"></div>
    </div>
    <style>
              @media print {
                @page {
                  size: A4 portrait;
                  margin: 18mm 12mm 18mm 12mm;
                  @bottom-right {
                    content: "Page " counter(page);
                    font-size: 12px;
                    color: #444;
                  }
                }
              }
          @media print {
            .grid, .week-nav, .navbar, #shoplist-actions-fixed, .no-print { display: none !important; }
            .selection-panel { display: flex !important; flex-direction: row !important; gap: 32px !important; }
            #printMasterList, #shoppingList { background: white !important; box-shadow: none !important; color: black !important; }
            #printMasterList, #shoppingList { border-radius: 0 !important; padding: 0 12px 0 0 !important; }
            #printMasterList { min-width: 260px !important; max-width: 400px !important; }
            #shoppingList { min-width: 320px !important; }
            body, html { background: white !important; color: black !important; }
            .print-date { display: block !important; }
            .print-list-section { box-shadow: none !important; }
            h1, h2, h3, h4 { color: black !important; }
            ul, li { color: black !important; }
          }
      body, html {
        font-family: Arial, Helvetica, sans-serif;
      }
      @media print {
        @page {
          size: A4 portrait;
          margin: 18mm 12mm 18mm 12mm;
        }
        html, body {
          margin: 0 !important;
          padding: 0 !important;
          font-family: Arial, Helvetica, sans-serif !important;
        }
        body.print-list-only * {
          visibility: hidden !important;
        }
        body.print-list-only .print-list-section, 
        body.print-list-only .print-list-section * {
          visibility: visible !important;
          display: block !important;
          position: static !important;
          width: 100% !important;
          min-width: 0 !important;
          margin: 0 !important;
          padding: 0 !important;
          background: white !important;
          color: black !important;
        }
        /* Stack columns vertically for print to avoid page breaks in the middle of a flex row */
        body.print-list-only .print-list-section > div {
          display: block !important;
        }
        /* Hide checkboxes for print */
        body.print-list-only input[type="checkbox"] {
          display: none !important;
        }
        /* Print-only header */
        .print-header {
          display: block !important;
          text-align: center;
          margin-bottom: 18px;
        }
        /* Print date */
        .print-date {
          display: block !important;
          text-align: right;
          font-size: 12px;
          color: #444;
          margin-bottom: 8px;
        }
        /* Page numbers */
        body.print-list-only::after {
          content: "Page " counter(page);
          position: fixed;
          bottom: 8mm;
          right: 12mm;
          font-size: 12px;
          color: #444;
        }
        /* Table styling for print */
        .print-category-table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 18px;
        }
        .print-category-table th, .print-category-table td {
          border: 1px solid #bbb;
          padding: 4px 8px;
          font-size: 15px;
        }
        .print-category-table th {
          background: #f0f0f0;
        }
        .print-section-sep {
          border-top: 2px solid #333;
          margin: 18px 0 12px 0;
        }
      }
      /* Hide print-only header on screen */
      .print-header, .print-date { display: none; }
    </style>
  <script>
    // Injected from backend context for JS interactivity
    const bookings = {{ bookings|tojson|safe }};
    let recipes = {{ recipes|tojson|safe }};
    const dates = {{ dates|tojson|safe }};
    // Ensure recipes is an array for .find to work
    if (recipes && !Array.isArray(recipes)) {
      recipes = Object.values(recipes);
    }
    let selection = new Set();
    if (Array.isArray(bookings)) {
      bookings.forEach(b => { b.id = Number(b.id); });
    }
    // --- BEGIN ALL JS FUNCTIONS ---
    // Full JavaScript logic restored

    // Utility and helper functions
    function normalizeName(name) {
      if (!name) return '';
      let clean = name.toLowerCase().trim();
      clean = clean.replace(/\([^)]*\)/g, '');
      clean = clean.replace(/\s+/g, ' ');
      return clean;
    }
    function formatQtyUnit(qty, unit) {
      if (qty == null) return '';
      if (unit === 'g' && qty >= 1000) return (qty / 1000) + ' kg';
      if (unit === 'ml' && qty >= 1000) return (qty / 1000) + ' L';
      return unit ? qty + ' ' + unit : qty;
    }

    // Main selection and booking logic
    function updateSelectionDisplay() {
      const listEl = document.getElementById('selectedList');
      const notice = document.getElementById('selectionNotice');
      listEl.innerHTML = '';
      if (selection.size === 0) {
        notice.style.display = 'block';
        return;
      }
      notice.style.display = 'none';
      const selectedBookings = bookings.filter(b => selection.has(b.id));
      selectedBookings.forEach(b => {
        const li = document.createElement('li');
        li.textContent = `${b.class_code || ''} | ${b.recipe_name || ''} | P${b.period} | ${b.date_required}`;
        listEl.appendChild(li);
      });
    }

    function toggleBooking(id) {
      if (selection.has(id)) {
        selection.delete(id);
      } else {
        selection.add(id);
      }
      document.querySelectorAll(`[data-booking-id]`).forEach(el => {
        const bid = parseInt(el.dataset.bookingId, 10);
        if (selection.has(bid)) {
          el.classList.add('selected');
        } else {
          el.classList.remove('selected');
        }
      });
      updateSelectionDisplay();
    }
    window.toggleBooking = toggleBooking;

    function selectAllWeek() {
      bookings.forEach(b => selection.add(b.id));
      document.querySelectorAll('[data-booking-id]').forEach(el => el.classList.add('selected'));
      updateSelectionDisplay();
    }
    window.selectAllWeek = selectAllWeek;

    function clearAllSelections() {
      selection.clear();
      document.querySelectorAll('[data-booking-id]').forEach(el => el.classList.remove('selected'));
      updateSelectionDisplay();
      document.getElementById('listContent').textContent = 'Generate the shopping list to see items here.';
    }
    window.clearAllSelections = clearAllSelections;

    function generateShoppingList() {
        // Always scroll to Selected Bookings panel, even if no selection
        const selectedPanel = document.getElementById('selected-bookings-panel');
        if (selectedPanel) {
            selectedPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        // --- Master Shopping List (all selected bookings, grouped by category, alphabetically) ---
        const masterTarget = document.getElementById('masterListContent');
        masterTarget.innerHTML = '';
        let masterIngredientMap = {};
        bookings.filter(b => selection.has(b.id)).forEach(b => {
          let recipe = null;
          if (Array.isArray(recipes)) {
            recipe = recipes.find(r => (r.name||'').trim().toLowerCase() === (b.recipe_name||'').trim().toLowerCase());
            if (!recipe) {
              recipe = recipes.find(r => (r.name||'').trim().toLowerCase().includes((b.recipe_name||'').trim().toLowerCase()));
            }
          }
          if (recipe && recipe.ingredients) {
            recipe.ingredients.forEach(ing => {
              const name = ing.ingredient || ing.name || '';
              const unit = ing.unit || '';
              let qty = parseFloat(ing.quantity || ing.qty || 0);
              if (isNaN(qty)) qty = ing.quantity || ing.qty || '';
              const key = name + '|' + unit;
              if (!masterIngredientMap[key]) {
                masterIngredientMap[key] = { name, unit, qty, category: ing.category || 'Other' };
              } else {
                if (typeof masterIngredientMap[key].qty === 'number' && typeof qty === 'number') {
                  masterIngredientMap[key].qty += qty;
                }
              }
            });
          }
        });
        let masterCategories = {};
        Object.values(masterIngredientMap).forEach(ing => {
          const cat = ing.category || 'Other';
          if (!masterCategories[cat]) masterCategories[cat] = [];
          masterCategories[cat].push(ing);
        });
        if (Object.keys(masterCategories).length === 0) {
          masterTarget.textContent = 'Generate the shopping list to see items here.';
        } else {
          Object.keys(masterCategories).sort().forEach(cat => {
            const catDiv = document.createElement('div');
            catDiv.style.marginBottom = '10px';
            const catTitle = document.createElement('strong');
            catTitle.textContent = cat;
            catDiv.appendChild(catTitle);
            const ul = document.createElement('ul');
            masterCategories[cat]
              .sort((a, b) => (a.name || '').localeCompare(b.name || ''))
              .forEach(ing => {
                const li = document.createElement('li');
                li.textContent = `${ing.name} ‚Äî ${formatQtyUnit(ing.qty, ing.unit)}`;
                ul.appendChild(li);
              });
            catDiv.appendChild(ul);
            masterTarget.appendChild(catDiv);
          });
        }
      const target = document.getElementById('listContent');
      target.innerHTML = '';
      if (selection.size === 0) {
        target.textContent = 'Select bookings then generate the shopping list.';
        return;
      }
      // Group bookings by teacher
      let teacherMap = {};
      bookings.filter(b => selection.has(b.id)).forEach(b => {
        const teacher = b.last_name || b.staff_code || 'Unknown';
        if (!teacherMap[teacher]) teacherMap[teacher] = [];
        teacherMap[teacher].push(b);
      });
      // For each teacher, show their bookings and a categorized ingredient list
      Object.keys(teacherMap).forEach(teacher => {
        const teacherDiv = document.createElement('div');
        teacherDiv.style.marginBottom = '18px';
        const teacherTitle = document.createElement('h2');
        teacherTitle.textContent = 'Teacher: ' + teacher;
        teacherTitle.style.fontSize = '18px';
        teacherTitle.style.margin = '8px 0 4px 0';
        teacherDiv.appendChild(teacherTitle);
        // List bookings for this teacher
        const bookingsList = document.createElement('ul');
        teacherMap[teacher].forEach(b => {
          const li = document.createElement('li');
          li.textContent = `${b.class_code || ''} | ${b.recipe_name || ''} | P${b.period} | ${b.date_required}`;
          bookingsList.appendChild(li);
        });
        teacherDiv.appendChild(bookingsList);
        // Aggregate ingredients for this teacher's bookings
        let ingredientMap = {};
        let foundAny = false;
        teacherMap[teacher].forEach(b => {
          let recipe = null;
          if (Array.isArray(recipes)) {
            recipe = recipes.find(r => (r.name||'').trim().toLowerCase() === (b.recipe_name||'').trim().toLowerCase());
            if (!recipe) {
              recipe = recipes.find(r => (r.name||'').trim().toLowerCase().includes((b.recipe_name||'').trim().toLowerCase()));
            }
          }
          if (recipe && recipe.ingredients) {
            recipe.ingredients.forEach(ing => {
              foundAny = true;
              const name = ing.ingredient || ing.name || '';
              const unit = ing.unit || '';
              let qty = parseFloat(ing.quantity || ing.qty || 0);
              if (isNaN(qty)) qty = ing.quantity || ing.qty || '';
              const key = name + '|' + unit;
              if (!ingredientMap[key]) {
                ingredientMap[key] = { name, unit, qty, category: ing.category || 'Other' };
              } else {
                if (typeof ingredientMap[key].qty === 'number' && typeof qty === 'number') {
                  ingredientMap[key].qty += qty;
                }
              }
            });
          }
        });
        if (!foundAny) {
          const none = document.createElement('div');
          none.textContent = 'No ingredients found for this teacher.';
          teacherDiv.appendChild(none);
        } else {
          // Group by category
          let categories = {};
          Object.values(ingredientMap).forEach(ing => {
            const cat = ing.category || 'Other';
            if (!categories[cat]) categories[cat] = [];
            categories[cat].push(ing);
          });
          // Render grouped shopping list
          Object.keys(categories).sort().forEach(cat => {
            const catDiv = document.createElement('div');
            catDiv.style.marginBottom = '12px';
            const catTitle = document.createElement('h3');
            catTitle.textContent = cat;
            catTitle.style.fontSize = '17px';
            catTitle.style.margin = '8px 0 4px 0';
            catDiv.appendChild(catTitle);
            const ul = document.createElement('ul');
            categories[cat]
              .sort((a, b) => (a.name || '').localeCompare(b.name || ''))
              .forEach(ing => {
                const li = document.createElement('li');
                li.textContent = `${ing.name} ‚Äî ${formatQtyUnit(ing.qty, ing.unit)}`;
                ul.appendChild(li);
              });
            catDiv.appendChild(ul);
            teacherDiv.appendChild(catDiv);
          });
        }
        target.appendChild(teacherDiv);
      });
    }
    window.generateShoppingList = generateShoppingList;

    function autoGenerateWeek() {
      selectAllWeek();
      generateShoppingList();
      document.getElementById('shoppingList').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    window.autoGenerateWeek = autoGenerateWeek;

    function exportShoppingListCsv() {
      alert('Export CSV not implemented in this demo.');
    }
    window.exportShoppingListCsv = exportShoppingListCsv;

    function saveShoppingList() {
      alert('Save List not implemented in this demo.');
    }
    window.saveShoppingList = saveShoppingList;

    function loadShoppingList() {
      alert('Load Saved not implemented in this demo.');
    }
    window.loadShoppingList = loadShoppingList;

    function loadListById(listId) {
      alert('Load List by ID not implemented in this demo.');
    }
    window.loadListById = loadListById;

    function printShoppingListOnly() {
      window.print();
    }
    window.printShoppingListOnly = printShoppingListOnly;
    // --- END ALL JS FUNCTIONS ---
  </script>
  <div class="export-options" style="margin-top: 18px; margin-bottom: 8px;">
    <strong>Export Options:</strong>
    <a href="/shoplist/export/ical" class="google-cal-btn" download>üìÖ Download iCal (.ics)</a>
    <button onclick="syncGoogleCalendar()" class="google-cal-btn">üîÑ Add to Google Calendar</button>
    <p style="margin-top:10px;font-size:0.9em;color:#666;">
      Download the iCal file to import into Google Calendar, Outlook, or Apple Calendar
    </p>
  </div>
  <div class="legend" id="shoplist-legend">
    <strong>Legend:</strong>
    <!-- Legend will be generated by JS -->
  </div>
  <div class="view-toggle" style="margin: 20px 0; display: flex; gap: 10px; align-items: center;">
    <span style="font-weight: 600; color: #666;">View:</span>
    <button id="weekViewBtn" class="active" onclick="switchShoplistView('week')">Week/Period View</button>
    <button id="monthViewBtn" onclick="switchShoplistView('month')">Month View</button>
  </div>
  <!-- Duplicate week-nav removed; only the top date line remains -->
  <div class="week-nav no-print" style="margin: 8px 0 8px 0; font-size: 1.15em; font-weight: bold; display: flex; flex-direction: column; align-items: center;">
    <div id="weekRangeLabel">{{ week_label }}</div>
    <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 8px; margin-top: 8px;">
      <form method="get" style="margin: 0;">
        <button type="submit" name="nav" value="prev">&#8592; Previous</button>
      </form>
      <form method="get" style="margin: 0;">
        <button type="submit" name="nav" value="today">Today</button>
      </form>
      <form method="get" style="margin: 0;">
        <button type="submit" name="nav" value="next">Next &#8594;</button>
      </form>
    </div>
  </div>

  <div id="weekPeriodView">
    <table class="grid no-print">
      <thead>
        <tr>
          <th></th>
          {% for d in dates %}
            <th style="text-align:center;">
              {{ d.day_name[:3] if d.day_name else '' }}<br>
              <span class="small-muted">{{ d.nz_date }}</span>
            </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for period in range(1,6) %}
          <tr>
            <td><span class="period">P{{ period }}</span></td>
            {% for d in dates %}
              {% set key = d.date + '_P' + period|string %}
              {% set booking = grid.get(key) %}
              <td>
                {% if booking %}
                  <div class="booking" data-booking-id="{{ booking.id }}" onclick="toggleBooking({{ booking.id }})">
                    <div class="booking-title">{{ booking.recipe_name or '‚Äî' }}</div>
                    <div class="booking-meta">Class: {{ booking.class_code or '‚Äî' }}</div>
                    <div class="booking-meta">Teacher: {{ booking.last_name or booking.staff_code or '‚Äî' }}{% if booking.first_name %}, {{ booking.first_name }}{% endif %}</div>
                    <div class="booking-meta">Servings: {{ booking.desired_servings or '‚Äî' }}</div>
                    <div class="booking-meta">{{ d.nz_date }}</div>
                    <div class="booking-meta">Tap to select</div>
                  </div>
                {% else %}
                  <div class="empty">‚Äî</div>
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="selection-panel no-print" style="margin-top: 24px; display: flex; gap: 32px; align-items: flex-start;">
      <div id="printMasterList" style="flex: 1 1 320px; min-width: 280px; max-width: 420px;">
        <h2 style="margin-bottom: 8px;">Selected Bookings</h2>
        <div id="selectionNotice" style="color: #888; font-size: 15px; margin-bottom: 8px;">Tap bookings in the grid to select them for the shopping list.</div>
        <ul id="selectedList" style="margin: 0 0 12px 0; padding-left: 18px;"></ul>
        <!-- Selection grid follows below -->
        <div style="margin: 18px 0 8px 0; display: flex; gap: 8px; justify-content: flex-start;">
          <button class="primary no-print" id="generateShoppingListBtn" style="background: #0074d9; color: #fff; border: 1px solid #0074d9;" onclick="generateShoppingList()">Generate Shopping List</button>
          <button class="primary no-print" id="printListOnlyBtn" style="background: #28a745;" onclick="printShoppingListOnly()">üñ®Ô∏è Print Shopping List Only</button>
        </div>
        <div id="masterList" style="margin-top: 24px; background: #f7f7f7; border-radius: 8px; padding: 12px;">
          <h3 style="margin-top: 0;">Master Shopping List</h3>
          <div id="masterListContent">Generate the shopping list to see items here.</div>
        </div>
      </div>
      <div id="shoppingList" class="print-list-section" style="flex: 2 1 480px; min-width: 320px; background: #f9f9f9; border-radius: 8px; padding: 18px 18px 18px 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <h2 style="margin-top: 0;">Shopping List</h2>
        <div id="listContent">Generate the shopping list to see items here.</div>
      </div>
    </div>
  </div>
  <div id="monthCalendarView" class="hidden">
    <div class="calendar-container">
      <div style="display: flex; flex-direction: column; align-items: center; margin-top: 18px;">
        <div id="shoplist-calendar-date-label" style="margin: 8px 0 8px 0; font-size: 1.15em; font-weight: bold;"></div>
      </div>
      <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 18px; margin-top: 8px;">
        <button onclick="shoplistPreviousMonth()">&#8592; Previous</button>
        <button onclick="shoplistToday()">Today</button>
        <button onclick="shoplistNextMonth()">Next &#8594;</button>
      </div>
      <div class="calendar-grid" id="shoplist-calendar">
        <!-- Month calendar will be generated by JavaScript -->
      </div>
    </div>
  </div>

<script>
function switchShoplistView(view) {
  document.getElementById('weekViewBtn').classList.remove('active');
  document.getElementById('monthViewBtn').classList.remove('active');
  if (view === 'week') {
    document.getElementById('weekPeriodView').style.display = '';
    document.getElementById('monthCalendarView').style.display = 'none';
    document.getElementById('weekViewBtn').classList.add('active');
    document.getElementById('weekNav').style.display = '';
  } else {
    document.getElementById('weekPeriodView').style.display = 'none';
    document.getElementById('monthCalendarView').style.display = '';
    document.getElementById('monthViewBtn').classList.add('active');
    document.getElementById('weekNav').style.display = 'none';
    renderShoplistMonthCalendar();
  }
}
function getUserTimezone() {
  try {
    return Intl.DateTimeFormat().resolvedOptions().timeZone;
  } catch (e) {
    return 'Pacific/Auckland'; // fallback
  }
}
function formatDateToUserTZ(dateStr) {
  // dateStr in yyyy-mm-dd
  const [y, m, d] = dateStr.split('-');
  const date = new Date(Date.UTC(y, m - 1, d));
  return date.toLocaleDateString(undefined, { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', timeZone: getUserTimezone() });
}
// Update week grid to show day names in the top row
function renderWeekGridHeadings() {
  const thead = document.querySelector('#weekPeriodView table thead');
  if (!thead) return;
  const dates = Array.from(thead.querySelectorAll('tr:nth-child(1) th')).slice(1);
  dates.forEach((th, idx) => {
    const date = th.textContent.match(/\d{4}-\d{2}-\d{2}/);
    if (date) {
      const formatted = formatDateToUserTZ(date[0]);
      th.innerHTML = formatted;
    }
  });
}
// Update month calendar to show day names and class code
// Persistent state for month/year
let shoplistMonthView = {
  year: (new Date()).getFullYear(),
  month: (new Date()).getMonth()
};
function renderShoplistMonthCalendar() {
  const bookings = window.bookings || [];
  const year = shoplistMonthView.year;
  const month = shoplistMonthView.month;
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  document.getElementById('shoplist-calendar-date-label').textContent = `${monthNames[month]} ${year}`;
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  let html = '';
  const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  dayHeaders.forEach(day => {
    html += `<div class='calendar-day-header'>${day}</div>`;
  });
  for (let i = firstDay - 1; i >= 0; i--) {
    html += `<div class='calendar-day other-month'><div class='day-number'></div></div>`;
  }
  const today = new Date();
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const normalizeDate = d => {
      if (!d) return '';
      if (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
      if (typeof d === 'object' && d.year && d.month && d.day) {
        return `${d.year}-${String(d.month).padStart(2, '0')}-${String(d.day).padStart(2, '0')}`;
      }
      // fallback: try to parse as date
      try {
        const dt = new Date(d);
        return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2, '0')}-${String(dt.getDate()).padStart(2, '0')}`;
      } catch { return String(d); }
    };
    const dayBookings = bookings.filter(b => normalizeDate(b.date_required) === dateStr);
    const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
    html += `<div class='calendar-day ${isToday ? 'today' : ''}'><div class='day-number'>${day}</div>`;
    dayBookings.forEach(booking => {
      html += `<div class='booking-item' title='${booking.recipe_name} (P${booking.period})'><strong>${booking.class_code}</strong><br>P${booking.period}: ${booking.recipe_name}</div>`;
    });
    html += '</div>';
  }
  const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;
  const remainingCells = totalCells - (firstDay + daysInMonth);
  for (let i = 1; i <= remainingCells; i++) {
    html += `<div class='calendar-day other-month'><div class='day-number'></div></div>`;
  }
  document.getElementById('shoplist-calendar').innerHTML = html;
}
function shoplistPreviousMonth() {
  shoplistMonthView.month--;
  if (shoplistMonthView.month < 0) {
    shoplistMonthView.month = 11;
    shoplistMonthView.year--;
  }
  renderShoplistMonthCalendar();
}
function shoplistNextMonth() {
  shoplistMonthView.month++;
  if (shoplistMonthView.month > 11) {
    shoplistMonthView.month = 0;
    shoplistMonthView.year++;
  }
  renderShoplistMonthCalendar();
}
function shoplistToday() {
  const now = new Date();
  shoplistMonthView.year = now.getFullYear();
  shoplistMonthView.month = now.getMonth();
  renderShoplistMonthCalendar();
}
document.addEventListener('DOMContentLoaded', function() {
  renderShoplistLegend();
  applyTeacherColors();
  renderWeekGridHeadings();
});
document.addEventListener('click', function() {
  // Re-apply colors after DOM updates
  setTimeout(applyTeacherColors, 100);
});
</script>
<script>
// Jinja filter will handle NZ week label formatting
</script>
</body>
</html>

