<script>
// Unified and robust switchShoplistView
function switchShoplistView(view) {
  const weekNav = document.getElementById('weekNav');
  const weekBtn = document.getElementById('weekViewBtn');
  const monthBtn = document.getElementById('monthViewBtn');
  const weekPeriodView = document.getElementById('weekPeriodView');
  const monthCalendarView = document.getElementById('monthCalendarView');
  if (view === 'week') {
    if (weekNav) weekNav.style.display = '';
    if (weekBtn) weekBtn.classList.add('active');
    if (monthBtn) monthBtn.classList.remove('active');
    if (weekPeriodView) weekPeriodView.style.display = '';
    if (monthCalendarView) monthCalendarView.style.display = 'none';
  } else {
    if (weekNav) weekNav.style.display = 'none';
    if (weekBtn) weekBtn.classList.remove('active');
    if (monthBtn) monthBtn.classList.add('active');
    if (weekPeriodView) weekPeriodView.style.display = 'none';
    if (monthCalendarView) monthCalendarView.style.display = '';
    // Always load bookings and render calendar
    window.loadMonthBookings();
  }
}
window.switchShoplistView = switchShoplistView;

// Ensure correct initial state on page load
window.addEventListener('DOMContentLoaded', function() {
  const monthBtn = document.getElementById('monthViewBtn');
  const monthView = document.getElementById('monthCalendarView');
  // If Month View is active or visible, always show and render it
  if ((monthBtn && monthBtn.classList.contains('active')) || (monthView && monthView.style.display !== 'none' && monthView.style.display !== '')) {
    window.switchShoplistView('month');
  } else {
    window.switchShoplistView('week');
  }
  // Defensive: if Month View is visible, always load bookings and render calendar
  if (monthView && monthView.style.display !== 'none') {
    window.loadMonthBookings();
    monthView.style.display = '';
  }
});
</script>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book the Shopping</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
  <body style="background: #f6f8fa;">
  <div class="print-header" style="display:none;">
    <img src="{{ url_for('static', filename='images/whs logo circular reo .png') }}" alt="School Logo" style="height: 60px; float: left; margin-right: 18px;">
    <div style="font-size: 2em; font-weight: bold;">Book the Shopping</div>
    <div class="print-date" style="font-size: 1em; color: #444; margin-top: 4px;"><span id="printDate"></span></div>
    <div style="font-size: 1.1em; margin-top: 2px;">{{ week_label }}</div>
    <div style="clear: both;"></div>
    <hr style="margin: 12px 0;">
  </div>

  <!-- Bootstrap 5 Navbar (from class_ingred.html) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 no-print">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">üç≥ Food Room</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="/recbk">Recipe Book</a></li>
          <li class="nav-item"><a class="nav-link" href="/class_ingredients">Class Ingredients</a></li>
          <li class="nav-item"><a class="nav-link active" href="/shoplist">Shopping List</a></li>
          {% if current_user.is_admin() %}
            <li class="nav-item"><a class="nav-link" href="/admin">Admin</a></li>
          {% endif %}
        </ul>
        <div class="d-flex">
          {% if current_user.is_authenticated %}
            <span class="me-2">{{ current_user.name }} <span class="badge bg-secondary">{{ current_user.role }}</span></span>
            <a href="/logout" class="btn btn-outline-danger btn-sm">Logout</a>
          {% else %}
            <a href="/login" class="btn btn-outline-primary btn-sm">Login</a>
          {% endif %}
        </div>
      </div>
    </div>
  </nav>


  <!-- Removed duplicate weekly dates above navigation -->
  <div style="display: flex; flex-direction: column; align-items: center; margin-top: 32px; margin-bottom: 24px;">
    <h1 class="no-print" style="font-size: 2.3em; margin-bottom: 0;">Book the Shopping</h1>
  </div>
  <!-- Week navigation moved below view toggle and above period grid as per user request -->
    <!-- Selected Bookings panel moved up under the title -->
    <div id="selected-bookings-panel" class="popout-panel card shadow-sm" style="margin-top: 0; margin-bottom: 28px; padding: 18px 20px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(66,133,244,0.07); display:none;">
      <div style="font-weight: bold; margin-bottom: 4px;">Selected Bookings</div>
      <div style="font-size: 0.95em; color: #444; margin-bottom: 8px;">Tap bookings in the grid to select them for the shopping list. Click Generate Shopping List.</div>
      <div id="selected-bookings-buttons" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;">
        <button onclick="selectAllWeek()" aria-label="Select all bookings" tabindex="0">Select All</button>
        <button onclick="clearAllSelections()" aria-label="Clear all selections" tabindex="0">Clear</button>
        <button class="primary" id="autoGenerateBtn" style="background: #ff851b; color: #fff; border: 1px solid #ff851b;" onclick="autoGenerateWeek()" aria-label="Auto generate shopping list" tabindex="0">Auto Generate</button>
        <span style="flex: 1 1 auto;"></span>
        <button class="primary" id="showScheduledBookingsBtn" style="background: #1976d2; color: #fff; border: 1px solid #1976d2; margin-left: 8px;" onclick="showScheduledBookingsModal()" aria-label="Show scheduled bookings" tabindex="0">Scheduled Bookings</button>
          </div>

          <!-- Scheduled Bookings Modal -->
          <script>
          // Hide/show selected bookings panel based on view
          function updateSelectedBookingsPanel() {
            var panel = document.getElementById('selected-bookings-panel');
            var buttons = document.getElementById('selected-bookings-buttons');
            var weekViewBtn = document.getElementById('weekViewBtn');
            var weekGrid = document.getElementById('weekPeriodView');
            var monthGrid = document.getElementById('monthCalendarView');
            if (!panel || !buttons) return;
            // Hide panel and buttons if Month View is active or week grid is hidden
            if ((weekViewBtn && weekViewBtn.classList.contains('active')) && weekGrid && weekGrid.style.display !== 'none') {
              panel.style.display = '';
              buttons.style.display = 'flex';
            } else {
              panel.style.display = 'none';
              buttons.style.display = 'none';
            }
          }
          window.addEventListener('DOMContentLoaded', function() {
            setTimeout(updateSelectedBookingsPanel, 0);
          });
          // Patch switchShoplistView to also update panel
          const origSwitchShoplistView = window.switchShoplistView;
          window.switchShoplistView = function(view) {
            origSwitchShoplistView(view);
            setTimeout(updateSelectedBookingsPanel, 0);
          };
          </script>
          <div id="scheduledBookingsModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; overflow:auto; background:rgba(0,0,0,0.4);">
            <div class="modal-content" style="background:#f9f9f9; margin:60px auto; padding:30px 24px 18px 24px; border-radius:8px; max-width:900px; box-shadow:0 8px 32px rgba(0,0,0,0.18); position:relative;">
              <span id="closeScheduledBookingsModal" style="position:absolute; top:12px; right:18px; font-size:28px; color:#888; cursor:pointer;">&times;</span>
              <h2 style="margin-top:0; color:#1976d2;">Scheduled Bookings</h2>
              <div id="scheduledBookingsTableContainer">
                <div style="text-align:center; color:#888;">Loading...</div>
              </div>
            </div>
          </div>

          <script>
          function showScheduledBookingsModal() {
            document.getElementById('scheduledBookingsModal').style.display = 'block';
            loadScheduledBookings();
          }
          document.getElementById('closeScheduledBookingsModal').onclick = function() {
            document.getElementById('scheduledBookingsModal').style.display = 'none';
          }
          window.onclick = function(event) {
            if (event.target === document.getElementById('scheduledBookingsModal')) {
              document.getElementById('scheduledBookingsModal').style.display = 'none';
            }
          }
          function loadScheduledBookings() {
            fetch('/api/scheduled_bookings').then(r => r.json()).then(data => {
              if (!data.success) {
                document.getElementById('scheduledBookingsTableContainer').innerHTML = '<div style="color:#a94442;">Failed to load bookings.</div>';
                return;
              }
              const bookings = data.bookings;
              if (!bookings.length) {
                document.getElementById('scheduledBookingsTableContainer').innerHTML = '<div style="color:#888;">No bookings found.</div>';
                return;
              }
              let html = '<div style="overflow-x:auto;"><table style="width:100%; border-collapse:collapse; background:#fff;"><thead><tr style="background:#1976d2; color:#fff;"><th>Date</th><th>Period</th><th>Staff</th><th>Class</th><th>Recipe</th><th>Servings</th></tr></thead><tbody>';
              for (const b of bookings) {
                html += `<tr><td>${b.date_required}</td><td>${b.period}</td><td>${b.staff_display}</td><td>${b.class_code}</td><td>${b.recipe_name}</td><td>${b.servings}</td></tr>`;
              }
              html += '</tbody></table></div>';
              document.getElementById('scheduledBookingsTableContainer').innerHTML = html;
            });
          }
          </script>
          <script>
          function addToGoogleCalendar() {
            fetch('/shoplist/add_to_gcal', { method: 'POST' })
              .then(async response => {
                let data;
                try {
                  data = await response.json();
                } catch (err) {
                  // If response is not JSON, show a generic error
                  alert('Error: Unexpected response from server. Please ensure you are logged in with Google.');
                  return;
                }
                if (data.success) {
                  alert('Bookings added to your Google Calendar!');
                } else {
                  alert('Error: ' + (data.error || 'Could not add to Google Calendar.'));
                }
              })
              .catch(err => alert('Error: ' + err));
          }
          </script>
      </div>
      <div id="selected-bookings-list" style="font-size: 0.97em; margin-bottom: 12px;"></div>
    </div>
    <style>
              @media print {
                @page {
                  size: A4 portrait;
                  margin: 18mm 12mm 18mm 12mm;
                  @bottom-right {
                    content: "Page " counter(page);
                    font-size: 12px;
                    color: #444;
                  }
                }
              }
          @media print {
            .grid, .week-nav, .navbar, #shoplist-actions-fixed, .no-print { display: none !important; }
            .selection-panel { display: flex !important; flex-direction: row !important; gap: 32px !important; }
            #printMasterList, #shoppingList { background: white !important; box-shadow: none !important; color: black !important; }
            #printMasterList, #shoppingList { border-radius: 0 !important; padding: 0 12px 0 0 !important; }
            #printMasterList { min-width: 260px !important; max-width: 400px !important; }
            #shoppingList { min-width: 320px !important; }
            body, html { background: white !important; color: black !important; }
            .print-date { display: block !important; }
            .print-list-section { box-shadow: none !important; }
            h1, h2, h3, h4 { color: black !important; }
            ul, li { color: black !important; }
          }
      body, html {
        font-family: Arial, Helvetica, sans-serif;
      }
      @media print {
        @page {
          size: A4 portrait;
          margin: 18mm 12mm 18mm 12mm;
        }
        html, body {
          margin: 0 !important;
          padding: 0 !important;
          font-family: Arial, Helvetica, sans-serif !important;
        }
        body.print-list-only * {
          visibility: hidden !important;
        }
        body.print-list-only .print-list-section, 
        body.print-list-only .print-list-section * {
          visibility: visible !important;
          display: block !important;
          position: static !important;
          width: 100% !important;
          min-width: 0 !important;
          margin: 0 !important;
          padding: 0 !important;
          background: white !important;
          color: black !important;
        }
        /* Stack columns vertically for print to avoid page breaks in the middle of a flex row */
        body.print-list-only .print-list-section > div {
          display: block !important;
        }
        /* Hide checkboxes for print */
        body.print-list-only input[type="checkbox"] {
          display: none !important;
        }
        /* Print-only header */
        .print-header {
          display: block !important;
          text-align: center;
          margin-bottom: 18px;
        }
        /* Print date */
        .print-date {
          display: block !important;
          text-align: right;
          font-size: 12px;
          color: #444;
          margin-bottom: 8px;
        }
        /* Page numbers */
        body.print-list-only::after {
          content: "Page " counter(page);
          position: fixed;
          bottom: 8mm;
          right: 12mm;
          font-size: 12px;
          color: #444;
        }
        /* Table styling for print */
        .print-category-table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 18px;
        }
        .print-category-table th, .print-category-table td {
          border: 1px solid #bbb;
          padding: 4px 8px;
          font-size: 15px;
        }
        .print-category-table th {
          background: #f0f0f0;
        }
        .print-section-sep {
          border-top: 2px solid #333;
          margin: 18px 0 12px 0;
        }
      }
      /* Hide print-only header on screen */
      .print-header, .print-date { display: none; }
    </style>
  <script>
    // Injected from backend context for JS interactivity
    const bookings = {{ bookings|tojson|safe }};
    let recipes = {{ recipes|tojson|safe }};
    const dates = {{ dates|tojson|safe }};
    // Ensure recipes is an array for .find to work
    if (recipes && !Array.isArray(recipes)) {
      recipes = Object.values(recipes);
    }
    let selection = new Set();
    if (Array.isArray(bookings)) {
      bookings.forEach(b => { b.id = Number(b.id); });
    }
    // --- BEGIN ALL JS FUNCTIONS ---
    // Full JavaScript logic restored

    // Utility and helper functions
    function normalizeName(name) {
      if (!name) return '';
      let clean = name.toLowerCase().trim();
      clean = clean.replace(/\([^)]*\)/g, '');
      clean = clean.replace(/\s+/g, ' ');
      return clean;
    }
    function formatQtyUnit(qty, unit) {
      if (qty == null) return '';
      if (unit === 'g' && qty >= 1000) return (qty / 1000) + ' kg';
      if (unit === 'ml' && qty >= 1000) return (qty / 1000) + ' L';
      return unit ? qty + ' ' + unit : qty;
    }

    // Main selection and booking logic
    function updateSelectionDisplay() {
      const listEl = document.getElementById('selectedList');
      const notice = document.getElementById('selectionNotice');
      listEl.innerHTML = '';
      if (selection.size === 0) {
        notice.style.display = 'block';
        return;
      }
      notice.style.display = 'none';
      const selectedBookings = bookings.filter(b => selection.has(b.id));
      selectedBookings.forEach(b => {
        const li = document.createElement('li');
        li.textContent = `${b.class_code || ''} | ${b.recipe_name || ''} | P${b.period} | ${b.date_required}`;
        listEl.appendChild(li);
      });
    }

    function toggleBooking(id) {
      if (selection.has(id)) {
        selection.delete(id);
      } else {
        selection.add(id);
      }
      document.querySelectorAll(`[data-booking-id]`).forEach(el => {
        const bid = parseInt(el.dataset.bookingId, 10);
        if (selection.has(bid)) {
          el.classList.add('selected');
        } else {
          el.classList.remove('selected');
        }
      });
      updateSelectionDisplay();
    }
    window.toggleBooking = toggleBooking;

    function selectAllWeek() {
      bookings.forEach(b => selection.add(b.id));
      document.querySelectorAll('[data-booking-id]').forEach(el => el.classList.add('selected'));
      updateSelectionDisplay();
    }
    window.selectAllWeek = selectAllWeek;

    function clearAllSelections() {
      selection.clear();
      document.querySelectorAll('[data-booking-id]').forEach(el => el.classList.remove('selected'));
      updateSelectionDisplay();
      document.getElementById('listContent').textContent = 'Generate the shopping list to see items here.';
    }
    window.clearAllSelections = clearAllSelections;

    function generateShoppingList() {
        // Always scroll to Selected Bookings panel, even if no selection
        const selectedPanel = document.getElementById('selected-bookings-panel');
        if (selectedPanel) {
            selectedPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        // --- Master Shopping List (all selected bookings, grouped by category, alphabetically) ---
        const masterTarget = document.getElementById('masterListContent');
        masterTarget.innerHTML = '';
        let masterIngredientMap = {};
        bookings.filter(b => selection.has(b.id)).forEach(b => {
          let recipe = null;
          if (Array.isArray(recipes)) {
            recipe = recipes.find(r => (r.name||'').trim().toLowerCase() === (b.recipe_name||'').trim().toLowerCase());
            if (!recipe) {
              recipe = recipes.find(r => (r.name||'').trim().toLowerCase().includes((b.recipe_name||'').trim().toLowerCase()));
            }
          }
          if (recipe && recipe.ingredients) {
            recipe.ingredients.forEach(ing => {
              const name = ing.ingredient || ing.name || '';
              const unit = ing.unit || '';
              let qty = parseFloat(ing.quantity || ing.qty || 0);
              if (isNaN(qty)) qty = ing.quantity || ing.qty || '';
              const key = name + '|' + unit;
              if (!masterIngredientMap[key]) {
                masterIngredientMap[key] = { name, unit, qty, category: ing.category || 'Other' };
              } else {
                if (typeof masterIngredientMap[key].qty === 'number' && typeof qty === 'number') {
                  masterIngredientMap[key].qty += qty;
                }
              }
            });
          }
        });
        let masterCategories = {};
        Object.values(masterIngredientMap).forEach(ing => {
          const cat = ing.category || 'Other';
          if (!masterCategories[cat]) masterCategories[cat] = [];
          masterCategories[cat].push(ing);
        });
        if (Object.keys(masterCategories).length === 0) {
          masterTarget.textContent = 'Generate the shopping list to see items here.';
        } else {
          Object.keys(masterCategories).sort().forEach(cat => {
            const catDiv = document.createElement('div');
            catDiv.style.marginBottom = '10px';
            const catTitle = document.createElement('strong');
            catTitle.textContent = cat;
            catDiv.appendChild(catTitle);
            const ul = document.createElement('ul');
            masterCategories[cat]
              .sort((a, b) => (a.name || '').localeCompare(b.name || ''))
              .forEach(ing => {
                const li = document.createElement('li');
                li.textContent = `${ing.name} ‚Äî ${formatQtyUnit(ing.qty, ing.unit)}`;
                ul.appendChild(li);
              });
            catDiv.appendChild(ul);
            masterTarget.appendChild(catDiv);
          });
        }
      const target = document.getElementById('listContent');
      target.innerHTML = '';
      if (selection.size === 0) {
        target.textContent = 'Select bookings then generate the shopping list.';
        return;
      }
      // Group bookings by teacher
      let teacherMap = {};
      bookings.filter(b => selection.has(b.id)).forEach(b => {
        const teacher = b.last_name || b.staff_code || 'Unknown';
        if (!teacherMap[teacher]) teacherMap[teacher] = [];
        teacherMap[teacher].push(b);
      });
      // For each teacher, show their bookings and a categorized ingredient list
      Object.keys(teacherMap).forEach(teacher => {
        const teacherDiv = document.createElement('div');
        teacherDiv.style.marginBottom = '18px';
        const teacherTitle = document.createElement('h2');
        teacherTitle.textContent = 'Teacher: ' + teacher;
        teacherTitle.style.fontSize = '18px';
        teacherTitle.style.margin = '8px 0 4px 0';
        teacherDiv.appendChild(teacherTitle);
        // List bookings for this teacher
        const bookingsList = document.createElement('ul');
        teacherMap[teacher].forEach(b => {
          const li = document.createElement('li');
          li.textContent = `${b.class_code || ''} | ${b.recipe_name || ''} | P${b.period} | ${b.date_required}`;
          bookingsList.appendChild(li);
        });
        teacherDiv.appendChild(bookingsList);
        // Aggregate ingredients for this teacher's bookings
        let ingredientMap = {};
        let foundAny = false;
        teacherMap[teacher].forEach(b => {
          let recipe = null;
          if (Array.isArray(recipes)) {
            recipe = recipes.find(r => (r.name||'').trim().toLowerCase() === (b.recipe_name||'').trim().toLowerCase());
            if (!recipe) {
              recipe = recipes.find(r => (r.name||'').trim().toLowerCase().includes((b.recipe_name||'').trim().toLowerCase()));
            }
          }
          if (recipe && recipe.ingredients) {
            recipe.ingredients.forEach(ing => {
              foundAny = true;
              const name = ing.ingredient || ing.name || '';
              const unit = ing.unit || '';
              let qty = parseFloat(ing.quantity || ing.qty || 0);
              if (isNaN(qty)) qty = ing.quantity || ing.qty || '';
              const key = name + '|' + unit;
              if (!ingredientMap[key]) {
                ingredientMap[key] = { name, unit, qty, category: ing.category || 'Other' };
              } else {
                if (typeof ingredientMap[key].qty === 'number' && typeof qty === 'number') {
                  ingredientMap[key].qty += qty;
                }
              }
            });
          }
        });
        if (!foundAny) {
          const none = document.createElement('div');
          none.textContent = 'No ingredients found for this teacher.';
          teacherDiv.appendChild(none);
        } else {
          // Group by category
          let categories = {};
          Object.values(ingredientMap).forEach(ing => {
            const cat = ing.category || 'Other';
            if (!categories[cat]) categories[cat] = [];
            categories[cat].push(ing);
          });
          // Render grouped shopping list
          Object.keys(categories).sort().forEach(cat => {
            const catDiv = document.createElement('div');
            catDiv.style.marginBottom = '12px';
            const catTitle = document.createElement('h3');
            catTitle.textContent = cat;
            catTitle.style.fontSize = '17px';
            catTitle.style.margin = '8px 0 4px 0';
            catDiv.appendChild(catTitle);
            const ul = document.createElement('ul');
            categories[cat]
              .sort((a, b) => (a.name || '').localeCompare(b.name || ''))
              .forEach(ing => {
                const li = document.createElement('li');
                li.textContent = `${ing.name} ‚Äî ${formatQtyUnit(ing.qty, ing.unit)}`;
                ul.appendChild(li);
              });
            catDiv.appendChild(ul);
            teacherDiv.appendChild(catDiv);
          });
        }
        target.appendChild(teacherDiv);
      });
    }
    window.generateShoppingList = generateShoppingList;

    function autoGenerateWeek() {
      selectAllWeek();
      generateShoppingList();
      document.getElementById('shoppingList').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    window.autoGenerateWeek = autoGenerateWeek;

    function exportShoppingListCsv() {
      alert('Export CSV not implemented in this demo.');
    }
    window.exportShoppingListCsv = exportShoppingListCsv;

    function saveShoppingList() {
      alert('Save List not implemented in this demo.');
    }
    window.saveShoppingList = saveShoppingList;

    function loadShoppingList() {
      alert('Load Saved not implemented in this demo.');
    }
    window.loadShoppingList = loadShoppingList;

    function loadListById(listId) {
      alert('Load List by ID not implemented in this demo.');
    }
    window.loadListById = loadListById;

    function printShoppingListOnly() {
      window.print();
    }
    window.printShoppingListOnly = printShoppingListOnly;
    // --- END ALL JS FUNCTIONS ---
  </script>

  <div class="row g-2 flex-wrap align-items-stretch mb-3" style="display: flex; flex-wrap: wrap; gap: 18px;">
    <!-- Removed duplicated Week View Date Label and Controls (only one set remains below) -->
    <!-- Legend removed: teacher shading now provides context visually -->
    <script>
    // Teacher color mapping (should match the one used in applyTeacherColors)
    function getTeacherColor(name) {
      // Simple hash to color
      const colors = [
        '#4285f4', // blue
        '#ea4335', // red
        '#fbbc04', // yellow
        '#34a853', // green
        '#a142f4', // purple
        '#ff6d01', // orange
        '#46bdc6', // teal
        '#b32851', // magenta
        '#5f6368', // gray
        '#00897b'  // cyan
      ];
      let hash = 0;
      for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
      return colors[Math.abs(hash) % colors.length];
    }
    function renderTeacherLegend() {
      // Collect unique teacher names from bookings (always combine last_name and first_name if present)
      const teacherSet = new Set();
      (window.bookings || []).forEach(b => {
        let name = '';
        if (b.last_name && b.first_name) {
          name = b.last_name + ', ' + b.first_name;
        } else if (b.teacher) {
          name = b.teacher;
        } else if (b.teacher_display) {
          name = b.teacher_display;
        } else if (b.teacher_name) {
          name = b.teacher_name;
        } else if (b.last_name) {
          name = b.last_name;
        } else if (b.staff_code) {
          name = b.staff_code;
        }
        if (name && name !== ', ') teacherSet.add(name);
      });
      const legendDiv = document.getElementById('teacher-legend');
      legendDiv.innerHTML = '';
      if (teacherSet.size === 0) {
        legendDiv.innerHTML = '<span class="text-muted">No teachers with bookings this week.</span>';
        return;
      }
      teacherSet.forEach(name => {
        if (!name) return;
        const swatch = document.createElement('span');
        swatch.className = 'legend-color';
        swatch.style.background = getTeacherColor(name);
        swatch.style.display = 'inline-block';
        swatch.style.width = '20px';
        swatch.style.height = '20px';
        swatch.style.marginRight = '6px';
        swatch.style.borderRadius = '4px';
        swatch.style.border = '1px solid #bbb';
        const label = document.createElement('span');
        label.textContent = name;
        label.style.marginRight = '12px';
        label.style.fontWeight = '500';
        label.style.color = '#222';
        legendDiv.appendChild(swatch);
        legendDiv.appendChild(label);
      });
    }
    function ensureLegendUpdates() {
      renderTeacherLegend();
      // Try to re-render after AJAX or view switches
      if (window.MutationObserver) {
        const legendDiv = document.getElementById('teacher-legend');
        const observer = new MutationObserver(renderTeacherLegend);
        observer.observe(legendDiv, { childList: true, subtree: true });
      }
    }
    document.addEventListener('DOMContentLoaded', ensureLegendUpdates);
    window.renderTeacherLegend = renderTeacherLegend;
    </script>
    <!-- View Toggle -->
    <div class="col-12 col-md-8 d-flex align-items-center" style="min-width:200px; flex: 2 1 320px;">
      <span class="fw-semibold text-secondary me-2">View:</span>
      <div class="btn-group flex-wrap" role="group" aria-label="View toggle">
        <button id="weekViewBtn" type="button" class="btn btn-outline-primary active" onclick="switchShoplistView('week')" aria-label="Week/Period View">Week/Period View</button>
        <button id="monthViewBtn" type="button" class="btn btn-outline-primary" onclick="switchShoplistView('month')" aria-label="Month View">Month View</button>
      </div>
    </div>
  </div>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <div id="weekNav" class="week-nav no-print" style="margin: 0 0 18px 0; display: flex; flex-direction: column; align-items: center; width: 100%;">
    <div id="weekRangeLabel" style="text-align: center; font-size: 2.2em; font-weight: 700; margin-bottom: 8px;">{{ week_label | format_nz_week }}</div>
    <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 8px; margin-top: 8px;">
      <form method="get" style="margin: 0;">
        <button type="submit" name="week" value="{{ prev_week }}">&#8592; Previous</button>
      </form>
      <form method="get" style="margin: 0;">
        <button type="submit" name="week" value="0">Today</button>
      </form>
      <form method="get" style="margin: 0;">
        <button type="submit" name="week" value="{{ next_week }}">Next &#8594;</button>
      </form>
    </div>
  </div>
  <div id="weekPeriodView">
    <div style="overflow-x:auto; width:100%;">
    <table class="grid no-print" role="table" aria-label="Booking week grid">
      <thead>
        <tr>
          <th scope="col"></th>
          {% for d in dates %}
            <th style="text-align:center;" scope="col">
              <div style="font-weight:600; font-size:1.08em;">{{ d.day_name[:3] if d.day_name else '' }}</div>
              <div style="font-size:0.98em; color:#444;">{{ d.nz_date }}</div>
            </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for period in range(1,6) %}
          <tr role="row">
            <td><span class="period" aria-label="Period {{ period }}">P{{ period }}</span></td>
            {% for d in dates %}
              {% set key = (d.date, period|string) %}
              {% set booking = grid.get(key) %}
              <td role="cell">
                {% if booking %}
                  {% set teacher_name = booking.last_name and booking.first_name and (booking.last_name + ', ' + booking.first_name) or booking.last_name or booking.staff_code or '' %}
                  <div class="booking" data-booking-id="{{ booking.id }}" onclick="toggleBooking({{ booking.id }})" tabindex="0" role="button" aria-pressed="false" aria-label="Booking for {{ booking.class_code or 'class' }}, {{ booking.recipe_name or 'no recipe' }}, period {{ period }}, teacher {{ teacher_name or 'unknown' }} on {{ d.nz_date }}" onkeydown="if(event.key==='Enter'||event.key===' '){toggleBooking({{ booking.id }})}"
                    style="background: #4285f4; color: #111; border-radius: 8px; border: 2px solid #4285f4; box-shadow: 0 2px 8px rgba(66,133,244,0.10); padding: 6px 8px 6px 10px; margin-bottom: 2px;">
                    <div class="booking-title" style="font-weight:bold; color:#111;">{{ booking.recipe_name or '‚Äî' }}</div>
                    <div class="booking-meta">Class: {{ booking.class_code or '‚Äî' }}</div>
                    <div class="booking-meta">Teacher: {{ booking.last_name and booking.first_name and (booking.last_name + ', ' + booking.first_name) or booking.last_name or booking.staff_code or booking.staff_display or '‚Äî' }}</div>
                    <div class="booking-meta">Servings: {{ booking.desired_servings or booking.servings or '‚Äî' }}</div>
                    <div class="booking-meta">{{ d.nz_date }}</div>
                    <div class="booking-meta">Tap to select</div>
                  </div>
                {% else %}
                  <div class="empty" aria-label="No booking">‚Äî</div>
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>

    <div class="selection-panel no-print row g-2 flex-wrap align-items-stretch shadow-sm shoplist-responsive-panel" style="margin-top: 32px; margin-bottom: 32px; display: flex; gap: 24px; align-items: flex-start; border-radius: 16px; background: #f8fafc; box-shadow: 0 4px 16px rgba(66,133,244,0.07); padding: 24px 0;">
      <div id="printMasterList" class="col-12 col-md-5 mb-2 shadow-sm card shoplist-responsive-card" style="flex: 1 1 320px; min-width: 260px; max-width: 420px; background: #fff; border-radius: 14px; box-shadow: 0 2px 8px rgba(66,133,244,0.07); padding: 24px 20px; margin-bottom: 0;">
        <h2 style="margin-bottom: 8px;">Selected Bookings</h2>
        <div id="selectionNotice" style="color: #888; font-size: 15px; margin-bottom: 8px;">Tap bookings in the grid to select them for the shopping list.</div>
        <ul id="selectedList" style="margin: 0 0 12px 0; padding-left: 18px;"></ul>
        <!-- Selection grid follows below -->
        <div class="card shadow-sm shoplist-responsive-actions" style="margin: 24px 0 8px 0; padding: 18px 16px; background: #f5faff; border-radius: 12px; display: flex; gap: 16px; justify-content: flex-start; align-items: center;">
          <button class="primary no-print" id="generateShoppingListBtn" style="background: linear-gradient(90deg, #0074d9 60%, #00c6ff 100%); color: #fff; border: none; font-size: 1.15em; font-weight: bold; padding: 12px 28px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.07);" onclick="generateShoppingList()" aria-label="Generate shopping list" tabindex="0">Generate Shopping List</button>
          <button class="primary no-print" id="printListOnlyBtn" style="background: linear-gradient(90deg, #28a745 60%, #a8e063 100%); color: #fff; border: none; font-size: 1.15em; font-weight: bold; padding: 12px 28px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.07);" onclick="printShoppingListOnly()" aria-label="Print shopping list only" tabindex="0">üñ®Ô∏è Print Shopping List Only</button>
        </div>
        <div id="masterList" style="margin-top: 24px; background: #f7f7f7; border-radius: 8px; padding: 12px;">
          <h3 style="margin-top: 0;">Master Shopping List</h3>
          <div id="masterListContent">Generate the shopping list to see items here.</div>
        </div>
      </div>
      <div id="shoppingList" class="print-list-section col-12 col-md-7 mb-2 shadow-sm card shoplist-responsive-card" style="flex: 2 1 480px; min-width: 280px; background: #fff; border-radius: 14px; box-shadow: 0 2px 8px rgba(66,133,244,0.07); padding: 24px 20px; margin-bottom: 0;">
        <h2 style="margin-top: 0;">Shopping List</h2>
        <div id="listContent">Generate the shopping list to see items here.</div>
      </div>
    </div>
  </div>
  <div id="monthCalendarView" class="hidden">
    <div class="calendar-container">
      <div style="display: flex; flex-direction: column; align-items: center; margin-top: 18px;">
        <div id="shoplist-calendar-date-label" style="margin: 8px 0 8px 0; font-size: 1.15em; font-weight: bold;"></div>
        <div class="export-options" style="margin-top: 18px; margin-bottom: 8px;">
          <strong>Export Options:</strong>
          <button id="monthGoogleCalBtn" class="google-cal-btn" style="background: #34a853; color: #fff; border: 1px solid #34a853;">Add to Google Calendar</button>
        </div>
      </div>
      <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 18px; margin-top: 8px;">
        <button onclick="shoplistPreviousMonth()">&#8592; Previous</button>
        <button onclick="shoplistToday()">Today</button>
        <button onclick="shoplistNextMonth()">Next &#8594;</button>
      </div>
      <div class="calendar-grid" id="shoplist-calendar">
        <!-- Month calendar will be generated by JavaScript -->
      </div>
    </div>
  </div>
<script>
// Update export links for month view
function updateMonthExportLinks(year, month) {
  // Set the iCal export link to include the month and year as query params
  document.getElementById('monthIcalExport').href = `/shoplist/export/ical?year=${year}&month=${month}`;
}
// Add event for Google Calendar export for month
document.getElementById('monthGoogleCalBtn')?.addEventListener('click', function() {
  const label = document.getElementById('shoplist-calendar-date-label').textContent;
  // Extract year and month from label if possible, fallback to current
  let d = new Date();
  let year = d.getFullYear();
  let month = d.getMonth() + 1;
  // If label is like 'January 2026', parse it
  const match = label.match(/([A-Za-z]+)\s+(\d{4})/);
  if (match) {
    const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    month = months.indexOf(match[1]) + 1;
    year = parseInt(match[2]);
  }
  fetch(`/shoplist/add_to_gcal?year=${year}&month=${month}`, { method: 'POST' })
    .then(async response => {
      let data;
      try {
        data = await response.json();
      } catch (err) {
        alert('Error: Unexpected response from server. Please ensure you are logged in with Google.');
        return;
      }
      if (data.success) {
        alert('Bookings added to your Google Calendar!');
      } else {
        alert('Error: ' + (data.error || 'Could not add to Google Calendar.'));
      }
    })
    .catch(err => alert('Error: ' + err));
});
</script>

<script>
// Fetch all scheduled bookings for month view
async function loadMonthBookings() {
  try {
    const resp = await fetch('/api/scheduled_bookings');
    const data = await resp.json();
    window.bookings = (data && data.success && data.bookings) ? data.bookings : [];
    renderShoplistMonthCalendar();
  } catch (e) {
    window.bookings = [];
    renderShoplistMonthCalendar();
  }
}
window.loadMonthBookings = loadMonthBookings;
function getUserTimezone() {
  try {
    return Intl.DateTimeFormat().resolvedOptions().timeZone;
  } catch (e) {
    return 'Pacific/Auckland'; // fallback
  }
}
function formatDateToUserTZ(dateStr) {
  // dateStr in yyyy-mm-dd
  const [y, m, d] = dateStr.split('-');
  const date = new Date(Date.UTC(y, m - 1, d));
  return date.toLocaleDateString(undefined, { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', timeZone: getUserTimezone() });
}
// Update week grid to show day names in the top row
function renderWeekGridHeadings() {
  const thead = document.querySelector('#weekPeriodView table thead');
  if (!thead) return;
  const dates = Array.from(thead.querySelectorAll('tr:nth-child(1) th')).slice(1);
  dates.forEach((th, idx) => {
    const date = th.textContent.match(/\d{4}-\d{2}-\d{2}/);
    if (date) {
      const formatted = formatDateToUserTZ(date[0]);
      th.innerHTML = formatted;
    }
  });
}
// Update month calendar to show day names and class code
// Persistent state for month/year
let shoplistMonthView = {
  year: (new Date()).getFullYear(),
  month: (new Date()).getMonth()
};
function renderShoplistMonthCalendar() {
  const bookings = window.bookings || [];
  const year = shoplistMonthView.year;
  const month = shoplistMonthView.month;
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  document.getElementById('shoplist-calendar-date-label').textContent = `${monthNames[month]} ${year}`;
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  let html = '';
  const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  dayHeaders.forEach(day => {
    html += `<div class='calendar-day-header'>${day}</div>`;
  });
  for (let i = firstDay - 1; i >= 0; i--) {
    html += `<div class='calendar-day other-month'><div class='day-number'></div></div>`;
  }
  const today = new Date();
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const normalizeDate = d => {
      if (!d) return '';
      if (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
      if (typeof d === 'object' && d.year && d.month && d.day) {
        return `${d.year}-${String(d.month).padStart(2, '0')}-${String(d.day).padStart(2, '0')}`;
      }
      // fallback: try to parse as date
      try {
        const dt = new Date(d);
        return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2, '0')}-${String(dt.getDate()).padStart(2, '0')}`;
      } catch { return String(d); }
    };
    const dayBookings = bookings.filter(b => normalizeDate(b.date_required) === dateStr);
    const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
    html += `<div class='calendar-day ${isToday ? 'today' : ''}'><div class='day-number'>${day}</div>`;
    dayBookings.forEach(booking => {
      html += `<div class='booking-item' tabindex='0' aria-label='Booking: ${booking.recipe_name} for ${booking.class_code} period ${booking.period}' onclick='showBookingDetailsModal(${JSON.stringify(booking)})' onkeypress='if(event.key=="Enter")showBookingDetailsModal(${JSON.stringify(booking)})'><strong>${booking.class_code}</strong><br>P${booking.period}: ${booking.recipe_name}</div>`;
    });
    // Modal for booking details
    function showBookingDetailsModal(booking) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style = 'display:block; position:fixed; z-index:10000; left:0; top:0; width:100vw; height:100vh; overflow:auto; background:rgba(0,0,0,0.4);';
      modal.innerHTML = `<div class='modal-content' style='background:#fff; margin:60px auto; padding:30px 24px 18px 24px; border-radius:8px; max-width:500px; box-shadow:0 8px 32px rgba(0,0,0,0.18); position:relative;'>
        <span style='position:absolute; top:12px; right:18px; font-size:28px; color:#888; cursor:pointer;' onclick='this.parentElement.parentElement.remove()'>&times;</span>
        <h2 style='margin-top:0; color:#1976d2;'>Booking Details</h2>
        <div><strong>Date:</strong> ${booking.date_required}</div>
        <div><strong>Period:</strong> ${booking.period}</div>
        <div><strong>Staff:</strong> ${booking.staff_display}</div>
        <div><strong>Class:</strong> ${booking.class_code}</div>
        <div><strong>Recipe:</strong> ${booking.recipe_name}</div>
        <div><strong>Servings:</strong> ${booking.servings}</div>
      </div>`;
      document.body.appendChild(modal);
    }
    // ...existing code...
    html += '</div>';
  }
  const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;
  const remainingCells = totalCells - (firstDay + daysInMonth);
  for (let i = 1; i <= remainingCells; i++) {
    html += `<div class='calendar-day other-month'><div class='day-number'></div></div>`;
  }
  document.getElementById('shoplist-calendar').innerHTML = html;
}
function shoplistPreviousMonth() {
  shoplistMonthView.month--;
  if (shoplistMonthView.month < 0) {
    shoplistMonthView.month = 11;
    shoplistMonthView.year--;
  }
  renderShoplistMonthCalendar();
}
function shoplistNextMonth() {
  shoplistMonthView.month++;
  if (shoplistMonthView.month > 11) {
    shoplistMonthView.month = 0;
    shoplistMonthView.year++;
  }
  renderShoplistMonthCalendar();
}
function shoplistToday() {
  const now = new Date();
  shoplistMonthView.year = now.getFullYear();
  shoplistMonthView.month = now.getMonth();
  renderShoplistMonthCalendar();
}
<!--//@Grapplinks[#PDF]-->
document.addEventListener('DOMContentLoaded', function() {
  renderShoplistLegend();
  applyTeacherColors();
  renderWeekGridHeadings();
  // Defensive: if Month View is visible, always load and render
  const monthView = document.getElementById('monthCalendarView');
  if (monthView && monthView.style.display !== 'none') {
    loadMonthBookings();
    monthView.style.display = '';
  }
});
<!--//@Grapplinks[#PDF]-->
document.addEventListener('click', function() {
  // Re-apply colors after DOM updates
  setTimeout(applyTeacherColors, 100);
});
</script>
<!-- Legend container for Month View (moved out of JS) -->
<div id="shoplist-legend" style="margin: 18px 0 8px 0;"></div>
</body>
</html>

