<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weekly Shopping List</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="print-header" style="display:none;">
    <img src="{{ url_for('static', filename='images/whs logo circular reo .png') }}" alt="School Logo" style="height: 60px; float: left; margin-right: 18px;">
    <div style="font-size: 2em; font-weight: bold;">Weekly Shopping List</div>
    <div class="print-date" style="font-size: 1em; color: #444; margin-top: 4px;">Printed: <span id="printDate"></span></div>
    <div style="font-size: 1.1em; margin-top: 2px;">{{ week_label }}</div>
    <div style="clear: both;"></div>
    <hr style="margin: 12px 0;">
  </div>
  <nav class="navbar no-print">
    <div class="nav-left">
      <a href="/" class="nav-brand">üç≥ Food Room</a> |
      <a href="/recipes">Recipes</a> |
      <a href="/recbk">Recipe Book</a> |
      <a href="/class_ingredients">Class Ingredients</a> |
      <a href="/booking">Booking Calendar</a> |
      <a href="/shoplist">Shopping List</a>
      {% if current_user.is_admin() %}
        | <a href="/admin">Admin</a>
      {% endif %}
    </div>
    <div class="nav-right">
      {% if current_user.is_authenticated %}
        <span class="user-info">{{ current_user.name }}<span class="badge badge-{{ current_user.role }}">{{ current_user.role }}</span></span> | <a href="/logout" class="logout-link">Logout</a>
      {% else %}
        <a href="/login" class="login-link">Login</a>
      {% endif %}
    </div>
  </nav>

  <div class="week-nav no-print">
    <span class="label">{{ week_label }}</span>
    <a href="/shoplist?week={{ prev_week }}">Previous Week</a>
    {% if week_offset != 0 %}
    <a href="/shoplist?week=0" style="font-weight: bold;">Current Week</a>
    {% endif %}
    <a href="/shoplist?week={{ next_week }}">Next Week</a>
  </div>

  <div id="shoplist-actions-fixed" class="actions no-print shoplist-actions-top" style="margin-bottom: 18px; justify-content: flex-end; display: flex; gap: 8px; flex-wrap: wrap;">
    <button onclick="saveShoppingList()">üíæ Save List</button>
    <button onclick="loadShoppingList()">üìÇ Load Saved</button>
    <button onclick="exportShoppingListCsv()">üìÑ Export CSV</button>
    <button class="primary" onclick="window.print()">üñ®Ô∏è Print</button>
    <span style="flex: 1 1 auto;"></span>
    <button class="primary no-print" id="printListOnlyBtn" style="background: #28a745; margin-left: auto;" onclick="printShoppingListOnly()">üñ®Ô∏è Print Shopping List Only</button>
  </div>
    <style>
      body, html {
        font-family: Arial, Helvetica, sans-serif;
      }
      @media print {
        @page {
          size: A4 portrait;
          margin: 18mm 12mm 18mm 12mm;
        }
        html, body {
          margin: 0 !important;
          padding: 0 !important;
          font-family: Arial, Helvetica, sans-serif !important;
        }
        body.print-list-only * {
          visibility: hidden !important;
        }
        body.print-list-only .print-list-section, 
        body.print-list-only .print-list-section * {
          visibility: visible !important;
          display: block !important;
          position: static !important;
          width: 100% !important;
          min-width: 0 !important;
          margin: 0 !important;
          padding: 0 !important;
          background: white !important;
          color: black !important;
        }
        /* Stack columns vertically for print to avoid page breaks in the middle of a flex row */
        body.print-list-only .print-list-section > div {
          display: block !important;
        }
        /* Hide checkboxes for print */
        body.print-list-only input[type="checkbox"] {
          display: none !important;
        }
        /* Print-only header */
        .print-header {
          display: block !important;
          text-align: center;
          margin-bottom: 18px;
        }
        /* Print date */
        .print-date {
          display: block !important;
          text-align: right;
          font-size: 12px;
          color: #444;
          margin-bottom: 8px;
        }
        /* Page numbers */
        body.print-list-only::after {
          content: "Page " counter(page);
          position: fixed;
          bottom: 8mm;
          right: 12mm;
          font-size: 12px;
          color: #444;
        }
        /* Table styling for print */
        .print-category-table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 18px;
        }
        .print-category-table th, .print-category-table td {
          border: 1px solid #bbb;
          padding: 4px 8px;
          font-size: 15px;
        }
        .print-category-table th {
          background: #f0f0f0;
        }
        .print-section-sep {
          border-top: 2px solid #333;
          margin: 18px 0 12px 0;
        }
      }
      /* Hide print-only header on screen */
      .print-header, .print-date { display: none; }
    </style>
  <script>
    // Injected from backend context for JS interactivity
    const bookings = {{ bookings|tojson|safe }};
    let recipes = {{ recipes|tojson|safe }};
    const dates = {{ dates|tojson|safe }};
    // Ensure recipes is an array for .find to work
    if (recipes && !Array.isArray(recipes)) {
      recipes = Object.values(recipes);
    }
    let selection = new Set();
    if (Array.isArray(bookings)) {
      bookings.forEach(b => { b.id = Number(b.id); });
    }
    // --- BEGIN ALL JS FUNCTIONS ---
    // Full JavaScript logic restored

    // Utility and helper functions
    function normalizeName(name) {
      if (!name) return '';
      let clean = name.toLowerCase().trim();
      clean = clean.replace(/\([^)]*\)/g, '');
      clean = clean.replace(/\s+/g, ' ');
      return clean;
    }
    function formatQtyUnit(qty, unit) {
      if (qty == null) return '';
      if (unit === 'g' && qty >= 1000) return (qty / 1000) + ' kg';
      if (unit === 'ml' && qty >= 1000) return (qty / 1000) + ' L';
      return unit ? qty + ' ' + unit : qty;
    }

    // Main selection and booking logic
    function updateSelectionDisplay() {
      const listEl = document.getElementById('selectedList');
      const notice = document.getElementById('selectionNotice');
      listEl.innerHTML = '';
      if (selection.size === 0) {
        notice.style.display = 'block';
        return;
      }
      notice.style.display = 'none';
      const selectedBookings = bookings.filter(b => selection.has(b.id));
      selectedBookings.forEach(b => {
        const li = document.createElement('li');
        li.textContent = `${b.class_code || ''} | ${b.recipe_name || ''} | P${b.period} | ${b.date_required}`;
        listEl.appendChild(li);
      });
    }

    function toggleBooking(id) {
      if (selection.has(id)) {
        selection.delete(id);
      } else {
        selection.add(id);
      }
      document.querySelectorAll(`[data-booking-id]`).forEach(el => {
        const bid = parseInt(el.dataset.bookingId, 10);
        if (selection.has(bid)) {
          el.classList.add('selected');
        } else {
          el.classList.remove('selected');
        }
      });
      updateSelectionDisplay();
    }
    window.toggleBooking = toggleBooking;

    function selectAllWeek() {
      bookings.forEach(b => selection.add(b.id));
      document.querySelectorAll('[data-booking-id]').forEach(el => el.classList.add('selected'));
      updateSelectionDisplay();
    }
    window.selectAllWeek = selectAllWeek;

    function clearAllSelections() {
      selection.clear();
      document.querySelectorAll('[data-booking-id]').forEach(el => el.classList.remove('selected'));
      updateSelectionDisplay();
      document.getElementById('listContent').textContent = 'Generate the shopping list to see items here.';
    }
    window.clearAllSelections = clearAllSelections;

    function generateShoppingList() {
            // --- Master Shopping List (all selected bookings, grouped by category, alphabetically) ---
            const masterTarget = document.getElementById('masterListContent');
            masterTarget.innerHTML = '';
            let masterIngredientMap = {};
            bookings.filter(b => selection.has(b.id)).forEach(b => {
              let recipe = null;
              if (Array.isArray(recipes)) {
                recipe = recipes.find(r => (r.name||'').trim().toLowerCase() === (b.recipe_name||'').trim().toLowerCase());
                if (!recipe) {
                  recipe = recipes.find(r => (r.name||'').trim().toLowerCase().includes((b.recipe_name||'').trim().toLowerCase()));
                }
              }
              if (recipe && recipe.ingredients) {
                recipe.ingredients.forEach(ing => {
                  const name = ing.ingredient || ing.name || '';
                  const unit = ing.unit || '';
                  let qty = parseFloat(ing.quantity || ing.qty || 0);
                  if (isNaN(qty)) qty = ing.quantity || ing.qty || '';
                  const key = name + '|' + unit;
                  if (!masterIngredientMap[key]) {
                    masterIngredientMap[key] = { name, unit, qty, category: ing.category || 'Other' };
                  } else {
                    if (typeof masterIngredientMap[key].qty === 'number' && typeof qty === 'number') {
                      masterIngredientMap[key].qty += qty;
                    }
                  }
                });
              }
            });
            let masterCategories = {};
            Object.values(masterIngredientMap).forEach(ing => {
              const cat = ing.category || 'Other';
              if (!masterCategories[cat]) masterCategories[cat] = [];
              masterCategories[cat].push(ing);
            });
            if (Object.keys(masterCategories).length === 0) {
              masterTarget.textContent = 'Generate the shopping list to see items here.';
            } else {
              Object.keys(masterCategories).sort().forEach(cat => {
                const catDiv = document.createElement('div');
                catDiv.style.marginBottom = '10px';
                const catTitle = document.createElement('strong');
                catTitle.textContent = cat;
                catDiv.appendChild(catTitle);
                const ul = document.createElement('ul');
                masterCategories[cat]
                  .sort((a, b) => (a.name || '').localeCompare(b.name || ''))
                  .forEach(ing => {
                    const li = document.createElement('li');
                    li.textContent = `${ing.name} ‚Äî ${formatQtyUnit(ing.qty, ing.unit)}`;
                    ul.appendChild(li);
                  });
                catDiv.appendChild(ul);
                masterTarget.appendChild(catDiv);
              });
            }
      const target = document.getElementById('listContent');
      target.innerHTML = '';
      if (selection.size === 0) {
        target.textContent = 'Select bookings then generate the shopping list.';
        return;
      }
      // Group bookings by teacher
      let teacherMap = {};
      bookings.filter(b => selection.has(b.id)).forEach(b => {
        const teacher = b.last_name || b.staff_code || 'Unknown';
        if (!teacherMap[teacher]) teacherMap[teacher] = [];
        teacherMap[teacher].push(b);
      });
      // For each teacher, show their bookings and a categorized ingredient list
      Object.keys(teacherMap).forEach(teacher => {
        const teacherDiv = document.createElement('div');
        teacherDiv.style.marginBottom = '18px';
        const teacherTitle = document.createElement('h2');
        teacherTitle.textContent = 'Teacher: ' + teacher;
        teacherTitle.style.fontSize = '18px';
        teacherTitle.style.margin = '8px 0 4px 0';
        teacherDiv.appendChild(teacherTitle);
        // List bookings for this teacher
        const bookingsList = document.createElement('ul');
        teacherMap[teacher].forEach(b => {
          const li = document.createElement('li');
          li.textContent = `${b.class_code || ''} | ${b.recipe_name || ''} | P${b.period} | ${b.date_required}`;
          bookingsList.appendChild(li);
        });
        teacherDiv.appendChild(bookingsList);
        // Aggregate ingredients for this teacher's bookings
        let ingredientMap = {};
        let foundAny = false;
        teacherMap[teacher].forEach(b => {
          let recipe = null;
          if (Array.isArray(recipes)) {
            recipe = recipes.find(r => (r.name||'').trim().toLowerCase() === (b.recipe_name||'').trim().toLowerCase());
            if (!recipe) {
              recipe = recipes.find(r => (r.name||'').trim().toLowerCase().includes((b.recipe_name||'').trim().toLowerCase()));
            }
          }
          if (recipe && recipe.ingredients) {
            recipe.ingredients.forEach(ing => {
              foundAny = true;
              const name = ing.ingredient || ing.name || '';
              const unit = ing.unit || '';
              let qty = parseFloat(ing.quantity || ing.qty || 0);
              if (isNaN(qty)) qty = ing.quantity || ing.qty || '';
              const key = name + '|' + unit;
              if (!ingredientMap[key]) {
                ingredientMap[key] = { name, unit, qty, category: ing.category || 'Other' };
              } else {
                if (typeof ingredientMap[key].qty === 'number' && typeof qty === 'number') {
                  ingredientMap[key].qty += qty;
                }
              }
            });
          }
        });
        if (!foundAny) {
          const none = document.createElement('div');
          none.textContent = 'No ingredients found for this teacher.';
          teacherDiv.appendChild(none);
        } else {
          // Group by category
          let categories = {};
          Object.values(ingredientMap).forEach(ing => {
            const cat = ing.category || 'Other';
            if (!categories[cat]) categories[cat] = [];
            categories[cat].push(ing);
          });
          // Render grouped shopping list
          Object.keys(categories).sort().forEach(cat => {
            const catDiv = document.createElement('div');
            catDiv.style.marginBottom = '12px';
            const catTitle = document.createElement('h3');
            catTitle.textContent = cat;
            catTitle.style.fontSize = '17px';
            catTitle.style.margin = '8px 0 4px 0';
            catDiv.appendChild(catTitle);
            const ul = document.createElement('ul');
            categories[cat]
              .sort((a, b) => (a.name || '').localeCompare(b.name || ''))
              .forEach(ing => {
                const li = document.createElement('li');
                li.textContent = `${ing.name} ‚Äî ${formatQtyUnit(ing.qty, ing.unit)}`;
                ul.appendChild(li);
              });
            catDiv.appendChild(ul);
            teacherDiv.appendChild(catDiv);
          });
        }
        target.appendChild(teacherDiv);
      });
    }
    window.generateShoppingList = generateShoppingList;

    function autoGenerateWeek() {
      selectAllWeek();
      generateShoppingList();
      document.getElementById('shoppingList').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    window.autoGenerateWeek = autoGenerateWeek;

    function exportShoppingListCsv() {
      alert('Export CSV not implemented in this demo.');
    }
    window.exportShoppingListCsv = exportShoppingListCsv;

    function saveShoppingList() {
      alert('Save List not implemented in this demo.');
    }
    window.saveShoppingList = saveShoppingList;

    function loadShoppingList() {
      alert('Load Saved not implemented in this demo.');
    }
    window.loadShoppingList = loadShoppingList;

    function loadListById(listId) {
      alert('Load List by ID not implemented in this demo.');
    }
    window.loadListById = loadListById;

    function printShoppingListOnly() {
      window.print();
    }
    window.printShoppingListOnly = printShoppingListOnly;
    // --- END ALL JS FUNCTIONS ---
  </script>
  <h1 class="no-print">Weekly Booking Grid</h1>
  <table class="grid no-print">
    <thead>
      <tr>
        <th>Period</th>
        {% for d in dates %}
          <th>{{ d.day_name }}<br><span class="small-muted">{{ d.nz_date }}</span></th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for period in range(1,6) %}
        <tr>
          <td><span class="period">P{{ period }}</span></td>
          {% for d in dates %}
            {% set key = d.date + '_P' + period|string %}
            {% set booking = grid.get(key) %}
            <td>
              {% if booking %}
                <div class="booking" data-booking-id="{{ booking.id }}" onclick="toggleBooking({{ booking.id }})">
                  <div class="booking-title">{{ booking.recipe_name or '‚Äî' }}</div>
                  <div class="booking-meta">Class: {{ booking.class_code or '‚Äî' }}</div>
                  <div class="booking-meta">Teacher: {{ booking.last_name or booking.staff_code or '‚Äî' }}{% if booking.first_name %}, {{ booking.first_name }}{% endif %}</div>
                  <div class="booking-meta">Servings: {{ booking.desired_servings or '‚Äî' }}</div>
                  <div class="booking-meta">{{ d.nz_date }}</div>
                  <div class="booking-meta">Tap to select</div>
                </div>
              {% else %}
                <div class="empty">‚Äî</div>
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="selection-panel no-print" style="margin-top: 24px; display: flex; gap: 32px; align-items: flex-start;">
    <div id="printMasterList" style="flex: 1 1 320px; min-width: 280px; max-width: 420px;">
      <h2 style="margin-bottom: 8px;">Selected Bookings</h2>
      <div id="selectionNotice" style="color: #888; font-size: 15px; margin-bottom: 8px;">Tap bookings in the grid to select them for the shopping list.</div>
      <ul id="selectedList" style="margin: 0 0 12px 0; padding-left: 18px;"></ul>
      <div style="display: flex; gap: 8px;">
        <button onclick="selectAllWeek()">Select All</button>
        <button onclick="clearAllSelections()">Clear</button>
        <button class="primary" onclick="generateShoppingList()">Generate Shopping List</button>
        <button onclick="autoGenerateWeek()">Auto Generate</button>
      </div>
      <div id="masterList" style="margin-top: 24px; background: #f7f7f7; border-radius: 8px; padding: 12px;">
        <h3 style="margin-top: 0;">Master Shopping List</h3>
        <div id="masterListContent">Generate the shopping list to see items here.</div>
      </div>
    </div>
    <div id="shoppingList" class="print-list-section" style="flex: 2 1 480px; min-width: 320px; background: #f9f9f9; border-radius: 8px; padding: 18px 18px 18px 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
      <h2 style="margin-top: 0;">Shopping List</h2>
          @media print {
            .no-print, .no-print * { display: none !important; }
            .print-header { display: block !important; }
            .selection-panel { display: flex !important; flex-direction: row !important; gap: 32px !important; }
            #printMasterList, #shoppingList { background: white !important; box-shadow: none !important; color: black !important; }
            #printMasterList, #shoppingList { border-radius: 0 !important; padding: 0 12px 0 0 !important; }
            #printMasterList { min-width: 260px !important; max-width: 400px !important; }
            #shoppingList { min-width: 320px !important; }
            body, html { background: white !important; color: black !important; }
            .print-date { display: block !important; }
            .print-list-section { box-shadow: none !important; }
            h1, h2, h3, h4 { color: black !important; }
            ul, li { color: black !important; }
          }
          // Print date logic
          function setPrintDate() {
            var d = new Date();
            var ds = d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
            var el = document.getElementById('printDate');
            if (el) el.textContent = ds;
          }
          window.onbeforeprint = setPrintDate;
          // Also set on load in case of print preview
          setPrintDate();
      <div id="listContent">Generate the shopping list to see items here.</div>
    </div>
  </div>

