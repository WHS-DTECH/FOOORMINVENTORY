{% extends "base.html" %}
{% block content %}
<div style="display: flex; flex-direction: row; gap: 32px; align-items: flex-start;">
	<div style="flex: 1; min-width: 400px;">
		<div style="display: flex; justify-content: flex-end; margin-bottom: 1em; gap: 18px;">
			<form method="get" action="/parser_debug_raw/{{ test_recipe_id }}" style="margin:0;">
				<button type="submit" class="btn btn-outline-secondary" style="font-size:1em;">View Raw Data2</button>
			</form>
			<div style="display: flex; gap: 12px;">
				<div style="min-width: 180px;">
					<div id="titleBlockHeader" style="background: #1976d2; color: #fff; font-weight: bold; padding: 8px 12px; border-radius: 6px 6px 0 0; margin-bottom: 0;">Title</div>
					<div id="titleBlockBox" style="border: 1px solid #1976d2; border-top: none; border-radius: 0 0 6px 6px; padding: 10px 12px 10px 12px; margin-bottom: 18px; font-size: 1em; background: #fff; color: #222; min-height: 48px; display: flex; align-items: center;">
						<span id="titleBlockText">{{ best_guess or raw_title or '(No title found)' }}</span>
					</div>
				</div>
				<div style="min-width: 180px;">
					<div style="background: #1976d2; color: #fff; font-weight: bold; padding: 8px 12px; border-radius: 6px 6px 0 0; margin-bottom: 0;">Solution</div>
					<div id="solutionBox" style="border: 1px solid #1976d2; border-top: none; border-radius: 0 0 6px 6px; padding: 10px 12px 10px 12px; margin-bottom: 18px; font-size: 1em; background: #fff; color: #222; min-height: 48px;">
						<textarea id="solutionInput" style="width: 100%; min-height: 40px; resize: vertical; font-size: 1em;"></textarea>
						<button id="sendSolutionBtn" style="margin-top: 10px; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 6px 16px; font-weight: bold; cursor: pointer;">SEND SOLUTION</button>
					</div>
				</div>
			</div>
		</div>
        <h3>Raw Data (HTML/Text)</h3>
        <div style="display: flex;">
            <div id="lineNumbers" style="background: #f0f0f0; color: #888; padding: 1em 0.5em 1em 1em; border: 1px solid #ccc; border-right: none; text-align: right; user-select: none; font-family: monospace;"></div>
            <textarea id="rawDataPreview" readonly rows="30" style="width: 60vw; max-width: 700px; min-width: 350px; min-height: 600px; height: 100%; font-family: monospace; font-size: 14px; background: #fafbfc; border: 1px solid #ddd; padding: 10px; margin-bottom: 20px; resize: both;"></textarea>
        </div>
        <button id="showMoreBtn" style="margin-top: 8px; display: none;">Show More</button>
	</div>
	<div style="flex: 1; min-width: 340px;">
        <div style="margin-bottom: 12px;"><strong>Title Extraction Strategies</strong></div>
        <div id="currentStrategyBox" style="border: 2px solid #1976d2; border-radius: 8px; padding: 18px 18px 12px 18px; margin-bottom: 18px; background: #f7faff; min-height: 80px; display: none;">
            <div id="currentStrategyTitle" style="font-weight: bold; font-size: 1.1em; margin-bottom: 8px;"></div>
            <div id="currentStrategyResult" style="font-family: monospace; color: #1976d2; font-size: 1.05em; margin-bottom: 12px;"></div>
            <div style="display: flex; gap: 18px;">
                <button id="continueBtn" style="width: 60px; height: 60px; font-size: 1.1em; background: #1976d2; color: #fff; border: none; border-radius: 8px; font-weight: bold;">Continue</button>
                <button id="solvedBtn" style="width: 60px; height: 60px; font-size: 1.1em; background: #43a047; color: #fff; border: none; border-radius: 8px; font-weight: bold;">Solved</button>
            </div>
        </div>
        <button id="runStrategiesBtn" style="margin-bottom: 10px; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 6px 16px; font-weight: bold; cursor: pointer;">Run Strategies</button>
        <div id="progressBarContainer" style="width: 100%; height: 18px; background: #e0e0e0; border-radius: 8px; margin-bottom: 10px; display: none;">
            <div id="progressBar" style="height: 100%; width: 0%; background: #1976d2; border-radius: 8px;"></div>
        </div>
        <table id="strategiesTable" style="border-collapse: collapse; width: 100%;">
            <thead>
                <tr style="background: #e3eafc;">
                    <th style="border: 1px solid #b0b0b0; padding: 4px 8px;">Strategy</th>
                    <th style="border: 1px solid #b0b0b0; padding: 4px 8px;">Applied</th>
                    <th style="border: 1px solid #b0b0b0; padding: 4px 8px;">Result</th>
                    <th style="border: 1px solid #b0b0b0; padding: 4px 8px;">Solved</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>Is there matching words from the URL in the Raw Data?</td><td class="applied">—</td><td class="result">—</td><td class="solved"></td></tr>
                <tr><td>Not a section header</td><td class="applied">—</td><td class="result">—</td><td class="solved"></td></tr>
                <tr><td>Not all lowercase</td><td class="applied">—</td><td class="result">—</td><td class="solved"></td></tr>
                <tr><td>Not too short (≥4 chars)</td><td class="applied">—</td><td class="result">—</td><td class="solved"></td></tr>
                <tr><td>Not only digits/symbols</td><td class="applied">—</td><td class="result">—</td><td class="solved"></td></tr>
                <tr><td>Prefers larger/bold lines</td><td class="applied">—</td><td class="result">—</td><td class="solved"></td></tr>
                <tr><td>NLP noun phrase/WORK_OF_ART</td><td class="applied">—</td><td class="result">—</td><td class="solved"></td></tr>
                <tr><td>Fallback: Uppercase start, not junk word</td><td class="applied">—</td><td class="result">—</td><td class="solved"></td></tr>
                <tr><td>Up to 5 lines above first ingredient</td><td class="applied">—</td><td class="result">—</td><td class="solved"></td></tr>
                <tr><td>Prefers food words from ingredient block</td><td class="applied">—</td><td class="result">—</td><td class="solved"></td></tr>
                <tr><td>Closest non-empty line above ingredient block</td><td class="applied">—</td><td class="result">—</td><td class="solved"></td></tr>
                <tr><td>If none, returns "Unknown Recipe"</td><td class="applied">—</td><td class="result">—</td><td class="solved"></td></tr>
            </tbody>
        </table>
    </div>
	</div>
</div>
{% endblock %}
{% block scripts %}
<script>
// Set rawData as a global variable for use in DOMContentLoaded
var rawData = {{ raw_data | tojson | safe }};
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Raw data preview logic for performance ---
    const lines = rawData.split('\n');
    const previewLines = 50;
    const lineNumbersDiv = document.getElementById('lineNumbers');
    const rawDataPreview = document.getElementById('rawDataPreview');
    const showMoreBtn = document.getElementById('showMoreBtn');
    function renderPreview(count) {
        let shownLines = lines.slice(0, count);
        lineNumbersDiv.innerHTML = shownLines.map((_, i) => `<div style='min-width:2.5em;'>${i+1}</div>`).join('');
        rawDataPreview.value = shownLines.join('\n');
    }
    renderPreview(previewLines);
    if (lines.length > previewLines) {
        showMoreBtn.style.display = '';
        showMoreBtn.onclick = function() {
            renderPreview(lines.length);
            showMoreBtn.style.display = 'none';
        };
    }

    // --- Hard refresh logic (like other pages) ---
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
            e.preventDefault();
            window.location.reload(true); // true = hard reload
        }
    });

    // --- Step-by-step strategy runner ---

    var runBtn = document.getElementById('runStrategiesBtn');
    var testRecipeId = '{{ test_recipe_id }}';
    var progressBar = document.getElementById('progressBar');
    var progressBarContainer = document.getElementById('progressBarContainer');
    var solutionInput = document.getElementById('solutionInput');
    var strategiesTable = document.getElementById('strategiesTable');
    const currentStrategyBox = document.getElementById('currentStrategyBox');
    const currentStrategyTitle = document.getElementById('currentStrategyTitle');
    const currentStrategyResult = document.getElementById('currentStrategyResult');
    const continueBtn = document.getElementById('continueBtn');
    const solvedBtn = document.getElementById('solvedBtn');
    let running = false;
    let currentStep = 0;
    let totalStrategies = 13;

    function highlightStrategyRow(idx) {
        Array.from(strategiesTable.querySelectorAll('tbody tr')).forEach((row, i) => {
            row.style.background = (i === idx) ? '#ffe082' : '';
        });
    }

    function setProgress(percent) {
        if (percent >= 100) {
            percent = 100;
            progressBarContainer.style.display = 'none';
        } else {
            progressBarContainer.style.display = 'block';
        }
        progressBar.style.width = percent + '%';
    }

    function showProgressBar(show) {
        if (show) {
            progressBarContainer.style.display = '';
        } else {
            progressBarContainer.style.display = 'none';
        }
    }

    function runStrategyStep(step, action = 'continue', prevResult = '') {
        fetch(`/run_strategy/${testRecipeId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ current_step: step, action: action, result: prevResult })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                running = false;
                return;
            }
            currentStep = data.current_step;
            highlightStrategyRow(currentStep);
            setProgress(((currentStep + 1) / totalStrategies) * 100);
            currentStrategyBox.style.display = data.done ? 'none' : '';
            if (!data.done) {
                currentStrategyTitle.textContent = data.strategy;
                currentStrategyResult.textContent = data.result || '';
                continueBtn.disabled = !data.continue_enabled;
                solvedBtn.disabled = !data.solved_enabled;
                // Mark as applied and show result in table
                const row = strategiesTable.querySelectorAll('tbody tr')[currentStep];
                if (row) {
                    row.querySelector('.applied').innerHTML = '&#10003;';
                    row.querySelector('.result').textContent = data.result || '';
                }
                running = true;
            } else {
                showProgressBar(false);
                highlightStrategyRow(-1);
                running = false;
            }
        });
    }

    if (runBtn) {
        runBtn.addEventListener('click', function() {
            runBtn.disabled = true;
            runBtn.textContent = 'Running...';
            // Reset all rows
            Array.from(strategiesTable.querySelectorAll('tbody tr')).forEach((row) => {
                row.style.background = '';
                let cell = row.querySelector('.solved');
                if (cell) cell.innerHTML = '';
                row.querySelector('.applied').innerHTML = '—';
                row.querySelector('.result').textContent = '—';
            });
            // Start running strategies from the beginning
            currentStep = 0;
            setProgress(0);
            showProgressBar(true);
            runStrategyStep(0);
        });
    }

    continueBtn.addEventListener('click', function() {
        if (!running) return;
        runStrategyStep(currentStep + 1, 'continue', currentStrategyResult.textContent);
    });
    solvedBtn.addEventListener('click', function() {
        if (!running) return;
        solutionInput.value = currentStrategyResult.textContent;
        // Optionally mark as solved in table
        const row = strategiesTable.querySelectorAll('tbody tr')[currentStep];
        if (row) row.querySelector('.solved').innerHTML = '<span style="font-size:1.5em;">✔️</span>';
        runStrategyStep(currentStep, 'solved', currentStrategyResult.textContent);
        running = false;
        currentStrategyBox.style.display = 'none';
    });

    document.body.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('solvedBtn') && !e.target.disabled) {
            e.preventDefault();
            e.target.click();
        }
        if (e.target && e.target.classList.contains('nextBtn') && !e.target.disabled) {
            e.preventDefault();
            e.target.click();
        }
    });

});
</script>
{% endblock %}
