{% extends "base.html" %}
{% block content %}
<div style="width:100%; display:flex; justify-content:flex-end; margin-bottom:1em;">
  <form method="get" action="/parser_debug_raw/{{ test_recipe_id }}" style="margin:0;">
    <button type="submit" class="btn btn-outline-secondary" style="font-size:1em;">View Raw Data</button>
  </form>
</div>
<div style="display: flex; gap: 2em;">
  <div style="flex: 1;">
    <h3>Raw Data (HTML/Text)</h3>
    <div style="display: flex;">
      <div style="background: #f0f0f0; color: #888; padding: 1em 0.5em 1em 1em; border: 1px solid #ccc; border-right: none; text-align: right; user-select: none; font-family: monospace;">
        {% set lines = (raw_data or raw_title or '') .split('\n') %}
        {% for i in range(1, lines|length + 1) %}
          <div style="min-width: 2.5em;">{{ i }}</div>
        {% endfor %}
      </div>
        <div style="display: flex; flex-direction: row; align-items: flex-start; gap: 32px;">
          <textarea readonly rows="30" style="width: 60vw; max-width: 700px; min-width: 350px; min-height: 600px; height: 100%; font-family: monospace; font-size: 14px; background: #fafbfc; border: 1px solid #ddd; padding: 10px; margin-bottom: 20px; resize: both;">{{ raw_data }}</textarea>
          <div style="flex: 1; min-width: 320px; display: flex; flex-direction: row; gap: 18px;">
            <div style="flex: 1 1 0; min-width: 180px;">
              <!-- Title block styled like Parser Debug -->
              <div id="titleBlockHeader" style="background: #1976d2; color: #fff; font-weight: bold; padding: 8px 12px; border-radius: 6px 6px 0 0; margin-bottom: 0;">Title</div>
              <div id="titleBlockBox" style="border: 1px solid #1976d2; border-top: none; border-radius: 0 0 6px 6px; padding: 10px 12px 10px 12px; margin-bottom: 18px; font-size: 1em; background: #fff; color: #222; min-height: 48px; display: flex; align-items: center; justify-content: space-between;">
                <span id="titleBlockText">{{ best_guess or raw_title or '(No title found)' }}</span>
                <button id="confirmTitleBtn" style="display:none; margin-left: 12px; background: #003366; color: #fff; border: none; border-radius: 4px; padding: 6px 16px; font-weight: bold; cursor: pointer;">CONFIRM</button>
              </div>
            </div>
            <div style="flex: 1 1 0; min-width: 180px;">
              <!-- Solution block styled like Title block -->
              <div style="background: #1976d2; color: #fff; font-weight: bold; padding: 8px 12px; border-radius: 6px 6px 0 0; margin-bottom: 0;">Solution</div>
              <div id="solutionBox" style="border: 1px solid #1976d2; border-top: none; border-radius: 0 0 6px 6px; padding: 10px 12px 10px 12px; margin-bottom: 18px; font-size: 1em; background: #fff; color: #222; min-height: 48px;">
                <textarea id="solutionInput" style="width: 100%; min-height: 40px; resize: vertical; font-size: 1em;"></textarea>
                <button id="sendSolutionBtn" style="margin-top: 10px; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 6px 16px; font-weight: bold; cursor: pointer;">SEND SOLUTION</button>
              </div>
            </div>
          </script>
          <script>
          // SEND SOLUTION button logic
          document.addEventListener('DOMContentLoaded', function() {
            const sendBtn = document.getElementById('sendSolutionBtn');
            const solutionInput = document.getElementById('solutionInput');
            const titleBlockBox = document.getElementById('titleBlockBox');
            const titleBlockText = document.getElementById('titleBlockText');
            const titleBlockHeader = document.getElementById('titleBlockHeader');
            const confirmBtn = document.getElementById('confirmTitleBtn');
            if (sendBtn && solutionInput && titleBlockBox && titleBlockText && titleBlockHeader && confirmBtn) {
              sendBtn.onclick = function() {
                // Copy solution to title block
                const solution = solutionInput.value.trim();
                if (solution) {
                  titleBlockText.textContent = solution;
                  titleBlockBox.style.background = '#003366';
                  titleBlockText.style.color = '#fff';
                  titleBlockHeader.style.background = '#003366';
                  // Show confirm button
                  confirmBtn.style.display = '';
                }
              };
              confirmBtn.onclick = function() {
                // Optionally, trigger AJAX or form submit here to save the confirmed title
                // For now, just visually mark as confirmed
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'CONFIRMED';
                titleBlockBox.style.opacity = '0.7';
              };
            }
          });
          </script>
          </div>
          <div style="margin-bottom: 12px; margin-top: 18px;">
            <strong>Title Extraction Strategies</strong>
          </div>
              <div id="title-strategies-box">
                <!-- Existing strategies/results content will be rendered here -->
                <div style="margin-bottom: 8px;">
                  <span style="font-weight: bold;">Strategy</span> <span style="font-weight: bold;">Result</span>
                </div>
                <!-- Jinja2 block for strategies/results if present -->
                {% if strategies %}
                  {% for strat, result in strategies.items() %}
                    <div><span>{{ strat }}</span>: <span>{{ result }}</span></div>
                  {% endfor %}
                {% endif %}
                <div style="margin-top: 16px;"><strong>Best Guess:</strong> {{ best_guess }}</div>
              </div>
            </div>
          </div>
        </div>
    </div>
  </div>
  <div style="flex: 1;">
    <h3>Title Extraction Strategies</h3>
    <table class="table table-bordered">
      <thead><tr><th>Strategy</th><th>Result</th></tr></thead>
      <tbody>
        {% for strat in strategies %}
        <tr{% if strat.best %} style="background: #d0f5d0;"{% endif %}>
          <td>{{ strat.name }}</td>
          <td>{{ strat.value }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <h4>Best Guess:</h4>
    <div style="font-size: 1.2em; font-weight: bold; color: #0074d9;">{{ best_guess }}</div>
  </div>
</div>
{% endblock %}
