{% extends "base.html" %}
{% block content %}
<div style="display: flex; flex-direction: row; gap: 32px; align-items: flex-start;">
  <div style="flex: 1; min-width: 400px;">
    <div style="display: flex; justify-content: flex-end; margin-bottom: 1em; gap: 18px;">
      <form method="get" action="/parser_debug_raw/{{ test_recipe_id }}" style="margin:0;">
        <button type="submit" class="btn btn-outline-secondary" style="font-size:1em;">View Raw Data</button>
      </form>
      <div style="display: flex; gap: 12px;">
        <div style="min-width: 180px;">
          <div id="titleBlockHeader" style="background: #1976d2; color: #fff; font-weight: bold; padding: 8px 12px; border-radius: 6px 6px 0 0; margin-bottom: 0;">Title</div>
          <div id="titleBlockBox" style="border: 1px solid #1976d2; border-top: none; border-radius: 0 0 6px 6px; padding: 10px 12px 10px 12px; margin-bottom: 18px; font-size: 1em; background: #fff; color: #222; min-height: 48px; display: flex; align-items: center; justify-content: space-between;">
            <span id="titleBlockText">{{ best_guess or raw_title or '(No title found)' }}</span>
            <button id="confirmTitleBtn" style="display:none; margin-left: 12px; background: #003366; color: #fff; border: none; border-radius: 4px; padding: 6px 16px; font-weight: bold; cursor: pointer;">CONFIRM</button>
          </div>
        </div>
        <div style="min-width: 180px;">
          <div style="background: #1976d2; color: #fff; font-weight: bold; padding: 8px 12px; border-radius: 6px 6px 0 0; margin-bottom: 0;">Solution</div>
          <div id="solutionBox" style="border: 1px solid #1976d2; border-top: none; border-radius: 0 0 6px 6px; padding: 10px 12px 10px 12px; margin-bottom: 18px; font-size: 1em; background: #fff; color: #222; min-height: 48px;">
            <textarea id="solutionInput" style="width: 100%; min-height: 40px; resize: vertical; font-size: 1em;"></textarea>
            <button id="sendSolutionBtn" style="margin-top: 10px; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 6px 16px; font-weight: bold; cursor: pointer;">SEND SOLUTION</button>
          </div>
        </div>
      </div>
    </div>
    <h3>Raw Data (HTML/Text)</h3>
    <div style="display: flex;">
      <div style="background: #f0f0f0; color: #888; padding: 1em 0.5em 1em 1em; border: 1px solid #ccc; border-right: none; text-align: right; user-select: none; font-family: monospace;">
        {% set lines = (raw_data or raw_title or '') .split('\n') %}
        {% for i in range(1, lines|length + 1) %}
          <div style="min-width: 2.5em;">{{ i }}</div>
        {% endfor %}
      </div>
      <textarea readonly rows="30" style="width: 60vw; max-width: 700px; min-width: 350px; min-height: 600px; height: 100%; font-family: monospace; font-size: 14px; background: #fafbfc; border: 1px solid #ddd; padding: 10px; margin-bottom: 20px; resize: both;">{{ raw_data }}</textarea>
    </div>
    <script>
    // SEND SOLUTION button logic
    document.addEventListener('DOMContentLoaded', function() {
      const sendBtn = document.getElementById('sendSolutionBtn');
      const solutionInput = document.getElementById('solutionInput');
      const titleBlockBox = document.getElementById('titleBlockBox');
      const titleBlockText = document.getElementById('titleBlockText');
      const titleBlockHeader = document.getElementById('titleBlockHeader');
      const confirmBtn = document.getElementById('confirmTitleBtn');
      if (sendBtn && solutionInput && titleBlockBox && titleBlockText && titleBlockHeader && confirmBtn) {
        sendBtn.onclick = function() {
          // Copy solution to title block
          const solution = solutionInput.value.trim();
          if (solution) {
            titleBlockText.textContent = solution;
            titleBlockBox.style.background = '#003366';
            titleBlockText.style.color = '#fff';
            titleBlockHeader.style.background = '#003366';
            // Show confirm button
            confirmBtn.style.display = '';
          }
        };
        confirmBtn.onclick = function() {
          // Optionally, trigger AJAX or form submit here to save the confirmed title
          // For now, just visually mark as confirmed
          confirmBtn.disabled = true;
          confirmBtn.textContent = 'CONFIRMED';
          titleBlockBox.style.opacity = '0.7';
        };
      }
    });
    </script>
  </div>
  <div style="flex: 1; min-width: 340px;">
    <div style="margin-bottom: 12px;"><strong>Title Extraction Strategies</strong></div>
    <div style="margin-bottom: 10px; font-size: 0.98em; color: #333;">
      <button id="runStrategiesBtn" style="margin-bottom: 10px; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 6px 16px; font-weight: bold; cursor: pointer;">Run Strategies</button>
      <div id="progressBarContainer" style="width: 100%; height: 18px; background: #e0e0e0; border-radius: 8px; margin-bottom: 10px; display: none;">
        <div id="progressBar" style="height: 100%; width: 0%; background: #1976d2; border-radius: 8px;"></div>
      </div>
      <table id="strategiesTable" style="border-collapse: collapse; width: 100%;">
        <thead>
          <tr style="background: #e3eafc;">
            <th style="border: 1px solid #b0b0b0; padding: 4px 8px;">Strategy</th>
            <th style="border: 1px solid #b0b0b0; padding: 4px 8px;">Applied</th>
            <th style="border: 1px solid #b0b0b0; padding: 4px 8px;">Result</th>
            <th style="border: 1px solid #b0b0b0; padding: 4px 8px;">Solved</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Is there matching words from the URL in the Raw Data?</td>
            <td class="applied">—</td>
            <td class="result">—</td>
            <td class="solved">
              <button class="solvedBtn" style="display:none; background: #43a047; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">✔️</button>
              <button class="nextBtn" style="display:none; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">➡️</button>
            </td>
          </tr>
          <tr><td>Not a section header</td><td class="applied">—</td><td class="result">—</td><td class="solved"><button class="solvedBtn" style="display:none; background: #43a047; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">✔️</button> <button class="nextBtn" style="display:none; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">➡️</button></td></tr>
          <tr><td>Not all lowercase</td><td class="applied">—</td><td class="result">—</td><td class="solved"><button class="solvedBtn" style="display:none; background: #43a047; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">✔️</button> <button class="nextBtn" style="display:none; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">➡️</button></td></tr>
          <tr><td>Not too short (≥4 chars)</td><td class="applied">—</td><td class="result">—</td><td class="solved"><button class="solvedBtn" style="display:none; background: #43a047; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">✔️</button> <button class="nextBtn" style="display:none; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">➡️</button></td></tr>
          <tr><td>Not only digits/symbols</td><td class="applied">—</td><td class="result">—</td><td class="solved"><button class="solvedBtn" style="display:none; background: #43a047; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">✔️</button> <button class="nextBtn" style="display:none; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">➡️</button></td></tr>
          <tr><td>Prefers larger/bold lines</td><td class="applied">—</td><td class="result">—</td><td class="solved"><button class="solvedBtn" style="display:none; background: #43a047; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">✔️</button> <button class="nextBtn" style="display:none; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">➡️</button></td></tr>
          <tr><td>NLP noun phrase/WORK_OF_ART</td><td class="applied">—</td><td class="result">—</td><td class="solved"><button class="solvedBtn" style="display:none; background: #43a047; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">✔️</button> <button class="nextBtn" style="display:none; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">➡️</button></td></tr>
          <tr><td>Fallback: Uppercase start, not junk word</td><td class="applied">—</td><td class="result">—</td><td class="solved"><button class="solvedBtn" style="display:none; background: #43a047; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">✔️</button> <button class="nextBtn" style="display:none; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">➡️</button></td></tr>
          <tr><td>Up to 5 lines above first ingredient</td><td class="applied">—</td><td class="result">—</td><td class="solved"><button class="solvedBtn" style="display:none; background: #43a047; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">✔️</button> <button class="nextBtn" style="display:none; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">➡️</button></td></tr>
          <tr><td>Prefers food words from ingredient block</td><td class="applied">—</td><td class="result">—</td><td class="solved"><button class="solvedBtn" style="display:none; background: #43a047; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">✔️</button> <button class="nextBtn" style="display:none; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">➡️</button></td></tr>
          <tr><td>Closest non-empty line above ingredient block</td><td class="applied">—</td><td class="result">—</td><td class="solved"><button class="solvedBtn" style="display:none; background: #43a047; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">✔️</button> <button class="nextBtn" style="display:none; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">➡️</button></td></tr>
          <tr><td>If none, returns "Unknown Recipe"</td><td class="applied">—</td><td class="result">—</td><td class="solved"><button class="solvedBtn" style="display:none; background: #43a047; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">✔️</button> <button class="nextBtn" style="display:none; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 2px 10px; font-size: 0.95em; cursor: pointer;">➡️</button></td></tr>
        </tbody>
      </table>
            <script>
            // Frontend-only simulation for progress and user controls
            document.addEventListener('DOMContentLoaded', function() {
              const runBtn = document.getElementById('runStrategiesBtn');
              const progressBarContainer = document.getElementById('progressBarContainer');
              const progressBar = document.getElementById('progressBar');
              const table = document.getElementById('strategiesTable');
              const rows = table.querySelectorAll('tbody tr');
              let current = 0;

              function resetTable() {
                rows.forEach(row => {
                  row.querySelector('.applied').textContent = '—';
                  row.querySelector('.result').textContent = '—';
                  row.querySelector('.solvedBtn').style.display = 'none';
                  row.querySelector('.nextBtn').style.display = 'none';
                });
              }

              function runStrategies() {
                resetTable();
                progressBarContainer.style.display = '';
                progressBar.style.width = '0%';
                current = 0;
                runNext();
              }

              function runNext() {
                if (current >= rows.length) {
                  progressBar.style.width = '100%';
                  return;
                }
                const row = rows[current];
                row.querySelector('.applied').textContent = '⏳';
                setTimeout(() => {
                  row.querySelector('.applied').textContent = '✅';
                  row.querySelector('.result').textContent = '(demo result)';
                  row.querySelector('.solvedBtn').style.display = '';
                  row.querySelector('.nextBtn').style.display = '';
                  progressBar.style.width = Math.round(((current+1)/rows.length)*100) + '%';
                  // User must click solved or next to continue
                  row.querySelector('.solvedBtn').onclick = () => {
                    row.querySelector('.solvedBtn').style.background = '#388e3c';
                    row.querySelector('.solvedBtn').textContent = '✔️ Solved';
                    row.querySelector('.nextBtn').disabled = true;
                    row.querySelector('.solvedBtn').disabled = true;
                    current++;
                    runNext();
                  };
                  row.querySelector('.nextBtn').onclick = () => {
                    row.querySelector('.solvedBtn').disabled = true;
                    row.querySelector('.nextBtn').disabled = true;
                    current++;
                    runNext();
                  };
                }, 600);
              }

              if (runBtn) {
                runBtn.onclick = runStrategies;
              }
            });
            </script>
      <div style="margin-top: 8px;">
        These strategies combine heuristics, NLP, and context from the ingredient block to identify likely recipe titles.
      </div>
    </div>
    <div id="title-strategies-box">
      <div style="margin-bottom: 8px;">
        <span style="font-weight: bold;">Strategy</span> <span style="font-weight: bold;">Result</span>
      </div>
      {% if strategies %}
        {% for strat, result in strategies.items() %}
          <div><span>{{ strat }}</span>: <span>{{ result }}</span></div>
        {% endfor %}
      {% endif %}
      <div style="margin-top: 16px;"><strong>Best Guess:</strong> {{ best_guess }}</div>
    </div>
  </div>
</div>
{% endblock %}
