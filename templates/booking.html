{% extends "base.html" %}
{% block content %}
<div class="calendar-container">
    <div style="display: flex; flex-direction: column; align-items: center; margin-top: 18px;">
        <h1 style="font-size: 2.3em; margin-bottom: 0;">Booking Calendar</h1>
        <div id="calendar-date-label" style="margin: 8px 0 8px 0; font-size: 1.15em; font-weight: bold;"></div>
    </div>
    <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 18px; margin-top: 8px;">
        <button onclick="previousMonth()">&#8592; Previous</button>
        <button onclick="today()">Today</button>
        <button onclick="nextMonth()">Next &#8594;</button>
    </div>
    <div class="export-options">
        <strong>Export Options:</strong>
        <a href="/booking/export/ical" class="google-cal-btn" download>ðŸ“… Download iCal (.ics)</a>
        <button onclick="syncGoogleCalendar()" class="google-cal-btn">ðŸ”„ Add to Google Calendar</button>
        <p style="margin-top:10px;font-size:0.9em;color:#666;">
            Download the iCal file to import into Google Calendar, Outlook, or Apple Calendar
        </p>
    </div>
    <div class="legend" id="calendar-legend">
        <strong>Legend:</strong>
        <!-- Legend will be generated by JS -->
    </div>
    <!-- calendar-header removed, replaced by new layout above -->
    <div class="calendar-grid" id="calendar">
        <!-- Calendar will be generated by JavaScript -->
    </div>
</div>

<div class="booking-details-panel" id="booking-details-panel">
    <span class="close-btn-panel" onclick="closeDetailsPanel()">&times;</span>
    <div id="details-panel-content"></div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentDate = new Date();
        const bookings = {{ bookings|tojson|safe }};
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendar-date-label').textContent = `${monthNames[month]} ${year}`;
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            // Build calendar grid
            let html = '';
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month"><div class="day-number">${daysInPrevMonth - i}</div></div>`;
            }
            // Current month days
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                const dayBookings = bookings.filter(b => b.date === dateStr);
                html += `<div class="calendar-day ${isToday ? 'today' : ''}">\n                <div class="day-number">${day}</div>`;
                dayBookings.forEach(booking => {
                    // Sanitize staffKey for CSS class
                    const staffKey = (booking.staff_code || booking.staff_name || 'default').replace(/[^a-zA-Z0-9_-]/g, '_');
                    html += `<div class="booking-item staff-color-${staffKey}" title="${booking.recipe_name} (${booking.period})" onclick="showDetails(${booking.id})">${booking.period}: ${booking.recipe_name}</div>`;
                });
                html += '</div>';
            }
            // Next month days
            const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;
            const remainingCells = totalCells - (firstDay + daysInMonth);
            for (let i = 1; i <= remainingCells; i++) {
                html += `<div class="calendar-day other-month"><div class="day-number">${i}</div></div>`;
            }
            document.getElementById('calendar').innerHTML = html;
        }
        function showDetails(bookingId) {
            const booking = bookings.find(b => b.id === bookingId);
            if (!booking) return;
            // Extract period number from "Period 1" format
            const periodNum = parseInt(booking.period.split(' ')[1]);
            const content = `
                <h2>${booking.recipe_name}</h2>
                <p><strong>Date:</strong> ${booking.date}</p>
                <p><strong>Period:</strong> ${booking.period}</p>
                <p><strong>Staff:</strong> ${booking.staff_name}</p>
                <p><strong>Class:</strong> ${booking.class_code}</p>
                <p><strong>Servings:</strong> ${booking.servings}</p>
                <form method="POST" action="/class_ingredients" style="margin-top:15px;">
                    <input type="hidden" name="staff_code" value="${booking.staff_code}">
                    <input type="hidden" name="class_code" value="${booking.class_code}">
                    <input type="hidden" name="date_required" value="${booking.date}">
                    <input type="hidden" name="period" value="${periodNum}">
                    <button type="submit" class="google-cal-btn" style="cursor:pointer;">ðŸ“‹ View & Download Ingredients</button>
                </form>
            `;
            document.getElementById('details-panel-content').innerHTML = content;
            document.getElementById('booking-details-panel').classList.add('active');
        }
        function closeDetailsPanel() {
            document.getElementById('booking-details-panel').classList.remove('active');
        }
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }
        function today() {
            currentDate = new Date();
            renderCalendar();
        }
        function syncGoogleCalendar() {
            window.open('/booking/export/ical', '_blank');
            setTimeout(() => {
                alert('Download the .ics file and:\n\n1. Go to Google Calendar (calendar.google.com)\n2. Click the + next to "Other calendars"\n3. Select "Import"\n4. Choose the downloaded .ics file\n5. Select which calendar to add events to\n6. Click "Import"');
            }, 500);
        }
        // Initialize calendar
        // Generate legend for staff colors
        function renderLegend() {
            // Get unique staff from bookings
            const staffMap = {};
            bookings.forEach(b => {
                // Sanitize key for CSS class usage
                let key = (b.staff_code || b.staff_name || 'default').replace(/[^a-zA-Z0-9_-]/g, '_');
                if (!staffMap[key]) staffMap[key] = b.staff_name || b.staff_code;
            });
            const staffKeys = Object.keys(staffMap);
            // Color palette
            const palette = [
                '#4285f4', '#ea4335', '#fbbc04', '#34a853', '#a142f4', '#ff6d01', '#46bdc6', '#e8710a', '#b31412', '#188038'
            ];
            // Generate CSS for each staff
            let styleBlock = '<style id="staff-color-styles">';
            staffKeys.forEach((key, idx) => {
                const color = palette[idx % palette.length];
                styleBlock += `.staff-color-${key} { background: ${color} !important; color: #fff !important; }\n`;
            });
            styleBlock += '</style>';
            // Insert or update style
            let styleElem = document.getElementById('staff-color-styles');
            if (styleElem) styleElem.outerHTML = styleBlock;
            else document.head.insertAdjacentHTML('beforeend', styleBlock);
            // Build legend HTML
            let legendHtml = '<strong>Legend:</strong> ';
            staffKeys.forEach((key, idx) => {
                const color = palette[idx % palette.length];
                legendHtml += `<span class="legend-item"><span class="legend-color" style="background:${color};border:1px solid #ccc;"></span> ${staffMap[key]}</span> `;
            });
            legendHtml += '<span class="legend-item"><span class="legend-color" style="background:#fffbe6;border:2px solid #fbbc04;"></span> Today</span>';
            document.getElementById('calendar-legend').innerHTML = legendHtml;
        }
        renderCalendar();
        renderLegend();
        // Expose functions to global scope for button onclicks
        window.previousMonth = previousMonth;
        window.nextMonth = nextMonth;
        window.today = today;
        window.showDetails = showDetails;
        window.closeDetailsPanel = closeDetailsPanel;
        window.syncGoogleCalendar = syncGoogleCalendar;
    });
</script>
{% endblock %}
