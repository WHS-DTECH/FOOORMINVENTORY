<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Calendar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-left">
            <a href="/" class="nav-brand">üç≥ Food Room</a> |
            <a href="/recipes">Recipes</a> |
            {% extends "base.html" %}

            {% block title %}Booking Calendar{% endblock %}

            {% block content %}
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    let currentDate = new Date();
                    const bookings = {{ bookings_json|safe }};
                    function renderCalendar() {
                        const year = currentDate.getFullYear();
                        const month = currentDate.getMonth();
                        // Update header
                        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                          'July', 'August', 'September', 'October', 'November', 'December'];
                        document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;
                        // Get first day of month and number of days
                        const firstDay = new Date(year, month, 1).getDay();
                        const daysInMonth = new Date(year, month + 1, 0).getDate();
                        const daysInPrevMonth = new Date(year, month, 0).getDate();
                        // Build calendar grid
                        let html = '';
                        const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                        dayHeaders.forEach(day => {
                            html += `<div class="calendar-day-header">${day}</div>`;
                        });
                        // Previous month days
                        for (let i = firstDay - 1; i >= 0; i--) {
                            html += `<div class="calendar-day other-month"><div class="day-number">${daysInPrevMonth - i}</div></div>`;
                        }
                        // Current month days
                        const today = new Date();
                        for (let day = 1; day <= daysInMonth; day++) {
                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                            const dayBookings = bookings.filter(b => b.date === dateStr);
                            html += `<div class="calendar-day ${isToday ? 'today' : ''}">\n                <div class="day-number">${day}</div>`;
                            dayBookings.forEach(booking => {
                                html += `<div class="booking-item" onclick="showDetails(${booking.id})">\n                    ${booking.period}: ${booking.recipe_name}\n                </div>`;
                            });
                            html += '</div>';
                        }
                        // Next month days
                        const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;
                        const remainingCells = totalCells - (firstDay + daysInMonth);
                        for (let i = 1; i <= remainingCells; i++) {
                            html += `<div class="calendar-day other-month"><div class="day-number">${i}</div></div>`;
                        }
                        document.getElementById('calendar').innerHTML = html;
                    }
                    function showDetails(bookingId) {
                        const booking = bookings.find(b => b.id === bookingId);
                        if (!booking) return;
                        // Extract period number from "Period 1" format
                        const periodNum = parseInt(booking.period.split(' ')[1]);
                        const content = `\n            <h2>${booking.recipe_name}</h2>\n            <p><strong>Date:</strong> ${booking.date}</p>\n            <p><strong>Period:</strong> ${booking.period}</p>\n            <p><strong>Staff:</strong> ${booking.staff_name}</p>\n            <p><strong>Class:</strong> ${booking.class_code}</p>\n            <p><strong>Servings:</strong> ${booking.servings}</p>\n            <form method="POST" action="/class_ingredients" style="margin-top:15px;">\n                <input type="hidden" name="staff_code" value="${booking.staff_code}">\n                <input type="hidden" name="class_code" value="${booking.class_code}">\n                <input type="hidden" name="date_required" value="${booking.date}">\n                <input type="hidden" name="period" value="${periodNum}">\n                <button type="submit" class="google-cal-btn" style="cursor:pointer;">üìã View & Download Ingredients</button>\n            </form>\n        `;
                        document.getElementById('details-content').innerHTML = content;
                        document.getElementById('booking-details').classList.add('active');
                        document.getElementById('overlay').classList.add('active');
                    }
                    function closeDetails() {
                        document.getElementById('booking-details').classList.remove('active');
                        document.getElementById('overlay').classList.remove('active');
                    }
                    function previousMonth() {
                        currentDate.setMonth(currentDate.getMonth() - 1);
                        renderCalendar();
                    }
                    function nextMonth() {
                        currentDate.setMonth(currentDate.getMonth() + 1);
                        renderCalendar();
                    }
                    function today() {
                        currentDate = new Date();
                        renderCalendar();
                    }
                    function syncGoogleCalendar() {
                        window.open('/booking/export/ical', '_blank');
                        setTimeout(() => {
                            alert('Download the .ics file and:\n\n1. Go to Google Calendar (calendar.google.com)\n2. Click the + next to "Other calendars"\n3. Select "Import"\n4. Choose the downloaded .ics file\n5. Select which calendar to add events to\n6. Click "Import"');
                        }, 500);
                    }
                    // Initialize calendar
                    renderCalendar();
                    // Expose functions to global scope for button onclicks
                    window.previousMonth = previousMonth;
                    window.nextMonth = nextMonth;
                    window.today = today;
                    window.showDetails = showDetails;
                    window.closeDetails = closeDetails;
                    window.syncGoogleCalendar = syncGoogleCalendar;
                });
            </script>
                    }
                    document.getElementById('calendar').innerHTML = html;
                }
                function showDetails(bookingId) {
                    const booking = bookings.find(b => b.id === bookingId);
                    if (!booking) return;
                    // Extract period number from "Period 1" format
                    const periodNum = parseInt(booking.period.split(' ')[1]);
                    const content = `\n            <h2>${booking.recipe_name}</h2>\n            <p><strong>Date:</strong> ${booking.date}</p>\n            <p><strong>Period:</strong> ${booking.period}</p>\n            <p><strong>Staff:</strong> ${booking.staff_name}</p>\n            <p><strong>Class:</strong> ${booking.class_code}</p>\n            <p><strong>Servings:</strong> ${booking.servings}</p>\n            <form method="POST" action="/class_ingredients" style="margin-top:15px;">\n                <input type="hidden" name="staff_code" value="${booking.staff_code}">\n                <input type="hidden" name="class_code" value="${booking.class_code}">\n                <input type="hidden" name="date_required" value="${booking.date}">\n                <input type="hidden" name="period" value="${periodNum}">\n                <button type="submit" class="google-cal-btn" style="cursor:pointer;">üìã View & Download Ingredients</button>\n            </form>\n        `;
                    document.getElementById('details-content').innerHTML = content;
                    document.getElementById('booking-details').classList.add('active');
                    document.getElementById('overlay').classList.add('active');
                }
                function closeDetails() {
                    document.getElementById('booking-details').classList.remove('active');
                    document.getElementById('overlay').classList.remove('active');
                }
                function previousMonth() {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                }
                function nextMonth() {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                }
                function today() {
                    currentDate = new Date();
                    renderCalendar();
                }
                function syncGoogleCalendar() {
                    window.open('/booking/export/ical', '_blank');
                    setTimeout(() => {
                        alert('Download the .ics file and:\n\n1. Go to Google Calendar (calendar.google.com)\n2. Click the + next to "Other calendars"\n3. Select "Import"\n4. Choose the downloaded .ics file\n5. Select which calendar to add events to\n6. Click "Import"');
                    }, 500);
                }
                // Initialize calendar
                renderCalendar();
            </script>
            {% endblock %}
        renderCalendar();
    </script>
</body>
</html>
