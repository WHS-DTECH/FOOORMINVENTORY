{% extends "base.html" %}

{% block title %}Manage User Roles{% endblock %}

{% block content %}
<div class="container">
    <h1>User Role Management</h1>
    <p class="recipe-method-desc">Assign additional roles to users beyond their primary staff code role.</p>
    <style>
    .user-role-btn {
        display: inline-block;
        padding: 10px 20px;
        background-color: #6c757d;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        margin-right: 8px;
    }
    .user-role-btn.permissions {
        background-color: #17a2b8;
    }
    .panel {
        margin: 20px 0;
        padding: 20px;
        background: white;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .flash-success {
        margin: 20px 0;
        padding: 15px;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 4px;
        color: #155724;
    }
    .role-badge {
        background-color: #e7f3ff;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
        margin-right: 4px;
    }
    </style>
    
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="flash-success" id="flashMessage" onclick="this.style.display='none';" style="cursor:pointer;">
                {% for message in messages %}
                    {{ message }}<br>
                {% endfor %}
                <span style="float:right; font-weight:bold; color:#155724; cursor:pointer;">[Click to dismiss]</span>
            </div>
        {% endif %}
    {% endwith %}

    <div style="margin: 20px 0;">
        <a href="/admin" class="user-role-btn">‚Üê Back to Admin</a>
        <a href="/admin/permissions" class="user-role-btn permissions">Manage Route Permissions</a>
    </div>

    <!-- Add Role to User Form -->
    <div class="panel">
        <h3>Add Role to User</h3>
        <form method="post" style="display: grid; gap: 12px; max-width: 600px;">
            <div>
                <label for="email" style="display: block; margin-bottom: 4px; font-weight: bold;">User Email:</label>
                <select id="email" name="email" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- Select a user --</option>
                    {% if users is defined %}
                        {% for user in users %}
                            <option value="{{ user.email }}">{{ user.email }}{% if user.name %} ({{ user.name }}){% endif %}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            
            <div>
                <label for="role" style="display: block; margin-bottom: 4px; font-weight: bold;">Role to Add:</label>
                <select id="role" name="role" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- Select a role --</option>
                    {% if roles is defined %}
                        {% for role in roles %}
                            <option value="{{ role }}">
                                {% if role == 'Admin' %}Admin
                                {% elif role == 'Teacher' %}Teacher
                                {% elif role == 'MU' %}Technician
                                {% elif role == 'public' %}Public Access
                                {% elif role == 'Recipe Editor' %}Recipe Editor
                                {% else %}{{ role }}
                                {% endif %}
                            </option>
                        {% endfor %}
                    {% endif %}
                    <option value="Recipe Editor">Recipe Editor</option>
                </select>
            </div>
            
            <input type="hidden" name="action" value="add">
            <button type="submit" class="primary" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Add Role</button>
        </form>
    </div>

    <!-- Filter: Show only users with additional roles -->
    <div style="margin-bottom: 12px;">
        <label style="font-weight: bold;">
            <input type="checkbox" id="filterAdditionalRoles" style="margin-right: 6px;">
            Show only users with additional roles
        </label>
    </div>

    <!-- Current User Roles -->
    <div class="panel">
        <h3>Users with Additional Roles</h3>
        <table id="userRolesTable" style="width: 100%; border-collapse: collapse; margin-top: 12px;">
            <thead>
                <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                    <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Email</th>
                    <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Roles</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; border: 1px solid #dee2e6;">{{ user.email }}</td>
                    <td style="padding: 12px; border: 1px solid #dee2e6;">
                        {% for r in user.roles %}
                            <span class="role-badge">{{ r }}</span>
                        {% endfor %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Remove Role Modal -->
    <div id="removeModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 24px; border-radius: 8px; max-width: 500px; width: 90%;">
            <h3>Remove Role from User</h3>
            <form method="post" id="removeForm">
                <input type="hidden" name="email" id="remove_email">
                <input type="hidden" name="action" value="remove">
                
                <div style="margin: 16px 0;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Select role to remove:</label>
                    <select name="role" id="remove_role" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </select>
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 16px;">
                    <button type="submit" style="flex: 1; padding: 10px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Remove Role</button>
                    <button type="button" onclick="closeRemoveModal()" style="flex: 1; padding: 10px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div style="margin: 30px 0; padding: 20px; background-color: #f8f9fa; border-left: 4px solid #007bff; border-radius: 4px;">
        <h3 style="margin-top: 0;">How It Works</h3>
        <ul style="line-height: 1.8;">
            <li><strong>Primary Role:</strong> Users automatically get their primary role from their staff code in the teachers table</li>
            <li><strong>Additional Roles:</strong> You can assign extra roles here to give users access to more features</li>
            <li><strong>Combined Access:</strong> Users will have access to all routes allowed by any of their roles</li>
            <li><strong>Example:</strong> A teacher can be given Admin role to access admin features without changing their staff code</li>
        </ul>
    </div>
</div>

<script>
// Use custom email if entered
document.getElementById('custom_email').addEventListener('change', function() {
    if (this.value) {
        document.getElementById('email').value = '';
        document.getElementById('email').setAttribute('name', '');
        this.setAttribute('name', 'email');
    }
});

document.getElementById('email').addEventListener('change', function() {
    if (this.value) {
        document.getElementById('custom_email').value = '';
        document.getElementById('custom_email').setAttribute('name', '');
        this.setAttribute('name', 'email');
    }
});

function showRemoveForm(email, rolesStr) {
    document.getElementById('remove_email').value = email;
    const select = document.getElementById('remove_role');
    select.innerHTML = '';
    
    const roles = rolesStr.split(', ');
    roles.forEach(role => {
        const option = document.createElement('option');
        option.value = role.trim();
        option.textContent = role.trim();
        select.appendChild(option);
    });
    
    document.getElementById('removeModal').style.display = 'flex';
}

function closeRemoveModal() {
    document.getElementById('removeModal').style.display = 'none';
}

// Close modal on background click
document.getElementById('removeModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeRemoveModal();
    }
});

// Filter table rows to show only users with additional roles
//@Grapplinks[#PDF]-->
document.addEventListener('DOMContentLoaded', function() {
    var filterBox = document.getElementById('filterAdditionalRoles');
    var table = document.getElementById('userRolesTable');
    if (filterBox && table) {
        //@Grapplinks[#PDF]-->
        filterBox.addEventListener('change', function() {
            var showOnlyAdditional = filterBox.checked;
            var rows = table.querySelectorAll('tbody tr');
            rows.forEach(function(row) {
                var roles = row.getAttribute('data-roles') || '';
                // Show if has more than just 'public' (Public Access)
                var roleList = roles.split(',').map(function(r) { return r.trim(); });
                var hasAdditional = roleList.length > 1 || (roleList.length === 1 && roleList[0] !== 'public');
                if (showOnlyAdditional) {
                    row.style.display = hasAdditional ? '' : 'none';
                } else {
                    row.style.display = '';
                }
            });
        });
    }
});
</script>
{% endblock %}
