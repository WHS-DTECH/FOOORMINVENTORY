<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Recipes</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <nav class="navbar">
    <div class="nav-left">
      <a href="/" class="nav-brand">üç≥ Food Room</a> |
      <a href="/recipes">Recipes</a> |
      <a href="/recbk">Recipe Book</a>
      {% if current_user.is_authenticated %}
        | <a href="/class_ingredients">Class Ingredients</a>
        | <a href="/booking">Booking Calendar</a>
        | <a href="/shoplist">Shopping List</a>
        {% if current_user.is_admin() %}
          | <a href="/admin">Admin</a>
        {% endif %}
      {% endif %}
    </div>
    <div class="nav-right">
      {% if current_user.is_authenticated %}
        <span class="user-info">{{ current_user.name }}<span class="badge badge-{{ current_user.role }}">{{ current_user.role }}</span></span> | <a href="/logout" class="logout-link">Logout</a>
      {% else %}
        <a href="/login" class="login-link">Login</a>
      {% endif %}
    </div>
  </nav>
  
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div style="margin:10px 0;padding:12px;background:#d4edda;border:1px solid #c3e6cb;color:#155724;border-radius:4px;max-width:720px;">
        {% for message in messages %}
          <div>{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  
  <h1>Recipes</h1>
  
  <!-- Advanced Search & Filter -->
  <div style="margin:12px 0; padding:16px; border:1px solid #ddd; background:#f9f9f9; max-width:900px; border-radius:6px;">
    <h3 style="margin-top:0;">üîç Search & Filter</h3>
    <form method="get" action="/recipes" style="display:grid; gap:12px;">
      <!-- Text Search -->
      <div>
        <label style="display:block; margin-bottom:4px; font-weight:bold;">Search by name, ingredient, or instructions:</label>
        <input type="search" name="q" placeholder="e.g., chocolate, pasta, baking..." value="{{ q }}" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;" />
      </div>
      
      <!-- Filters Row -->
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;">
        <!-- Dietary Tags -->
        <div>
          <label style="display:block; margin-bottom:4px; font-weight:bold;">Dietary:</label>
          <select name="dietary" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
            <option value="">All</option>
            {% for tag in all_dietary_tags %}
              <option value="{{ tag }}" {% if dietary == tag %}selected{% endif %}>{{ tag }}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Cuisine -->
        <div>
          <label style="display:block; margin-bottom:4px; font-weight:bold;">Cuisine:</label>
          <select name="cuisine" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
            <option value="">All</option>
            {% for c in all_cuisines %}
              <option value="{{ c }}" {% if cuisine == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Difficulty -->
        <div>
          <label style="display:block; margin-bottom:4px; font-weight:bold;">Difficulty:</label>
          <select name="difficulty" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
            <option value="">All</option>
            <option value="Easy" {% if difficulty == 'Easy' %}selected{% endif %}>Easy</option>
            <option value="Medium" {% if difficulty == 'Medium' %}selected{% endif %}>Medium</option>
            <option value="Hard" {% if difficulty == 'Hard' %}selected{% endif %}>Hard</option>
          </select>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div>
        <button type="submit" style="padding:8px 20px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-size:14px;">Apply Filters</button>
        {% if q or dietary or cuisine or difficulty %}
          <a href="/recipes" style="margin-left:10px; padding:8px 20px; background:#6c757d; color:white; text-decoration:none; border-radius:4px; display:inline-block;">Clear All</a>
        {% endif %}
        <span style="margin-left:15px; color:#666;">{{ rows|length }} recipe(s) found</span>
      </div>
    </form>
  </div>
  
  <div style="margin:8px 0; padding:8px; border:1px solid #eee; max-width:720px;">
    <strong>Upload Recipes</strong>
    <div style="margin-top:6px;">
      <a href="/" style="display:inline-block;margin-right:12px;padding:6px 10px;background:#337ab7;color:#fff;text-decoration:none;border-radius:4px;">Upload recipe (form)</a>
      <form action="/upload" method="post" enctype="multipart/form-data" style="display:inline-block;margin-right:12px;">
        <label style="display:inline-block;margin-right:6px;">
          <input type="file" name="pdfFile" accept="application/pdf" />
        </label>
        <button type="submit" style="padding:6px 10px;border-radius:4px;">Upload PDF</button>
      </form>
      <form id="urlForm" style="display:inline-block;">
        <label style="display:inline-block;margin-right:6px;">
          <input type="url" id="recipeUrl" placeholder="e.g., https://recipes.co.nz/..." style="width:280px;" required />
        </label>
        <button type="submit" style="padding:6px 10px;border-radius:4px;">Load from URL</button>
      </form>
    </div>
    <div id="urlStatus" style="margin-top:8px;"></div>
  </div>

  {% if rows %}
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Tags</th>
        <th>Cuisine</th>
        <th>Difficulty</th>
        <th>Ingredients</th>
        <th>Equipment</th>
        <th>Serving Size</th>
        <th>Method</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td><a href="/recipe/{{ r.id }}">{{ r.name }}</a></td>
        <td>
          {% if r.dietary_tags_list %}
            {% for tag in r.dietary_tags_list %}
              <span class="diet-tag">{{ tag }}</span>
            {% endfor %}
          {% else %}
            <span style="color:#999;">‚Äî</span>
          {% endif %}
        </td>
        <td>{{ r.cuisine or '‚Äî' }}</td>
        <td>
          {% if r.difficulty == 'Easy' %}
            <span style="color:#28a745;">‚óè Easy</span>
          {% elif r.difficulty == 'Medium' %}
            <span style="color:#ffc107;">‚óè Medium</span>
          {% elif r.difficulty == 'Hard' %}
            <span style="color:#dc3545;">‚óè Hard</span>
          {% else %}
            ‚Äî
          {% endif %}
        </td>
        <td>
          {% if r.ingredients %}
            <ul>
              {% for ing in r.ingredients %}
                <li>
                  {% if ing.quantity or ing.unit %}
                    {{ ing.quantity }} {{ ing.unit }}
                  {% endif %}
                  {{ ing.ingredient }}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            ‚Äî
          {% endif %}
        </td>
        <td>
          {% if r.equipment %}
            {{ r.equipment | join(', ') }}
          {% else %}
            ‚Äî
          {% endif %}
        </td>
        <td>{{ r.serving_size or '‚Äî' }}</td>
        <td>
          {% if r.instructions %}
            <details>
              <summary>View method</summary>
              <pre style="white-space: pre-wrap">{{ r.instructions }}</pre>
            </details>
          {% else %}
            ‚Äî
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>No recipes found.</p>
  {% endif %}

  <script>
    document.getElementById('urlForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const url = document.getElementById('recipeUrl').value;
      const statusDiv = document.getElementById('urlStatus');
      
      statusDiv.innerHTML = '<p style="color:#0066cc;">Loading recipe from URL...</p>';
      
      try {
        const formData = new FormData();
        formData.append('url', url);
        
        const response = await fetch('/upload_url', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        console.log('Received recipe data:', data);
        
        if (response.ok && data.success) {
          let ing = data.ingredients || [];
          if (typeof ing === 'string') {
            ing = ing.split('\n').filter(x => x.trim());
          }
          
          // Show preview and offer to open in form
          let html = `<div style="padding:10px;background:#e8f5e9;border:1px solid #4caf50;border-radius:4px;">
            <p><strong>‚úì Recipe extracted!</strong></p>
            <p><strong>Name:</strong> ${data.name}</p>
            <p><strong>Ingredients:</strong> ${ing.length} items found</p>`;
          
          if (data.warning) {
            html += `<p style="color:#f57c00;"><em>${data.warning}</em></p>`;
          }
          
          html += `<p style="margin-top:12px;"><strong>Click below to review and save:</strong></p>
            <button id="loadRecipeBtn" 
                    style="padding:10px 16px;background:#4caf50;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:16px;">
              Open Recipe Form ‚Üí
            </button>
          </div>`;
          
          statusDiv.innerHTML = html;
          document.getElementById('recipeUrl').value = '';
          
          // Store the full data object
          window.lastExtractedRecipe = data;
          
          // Add click handler to the button
          document.getElementById('loadRecipeBtn').addEventListener('click', function() {
            console.log('Button clicked, submitting recipe data...');
            editExtractedRecipeSimple();
          });
        } else {
          statusDiv.innerHTML = `<p style="color:#d32f2f;">Error: ${data.error || 'Unknown error'}</p>`;
        }
      } catch (err) {
        console.error('Fetch error:', err);
        statusDiv.innerHTML = `<p style="color:#d32f2f;">Error: ${err.message}</p>`;
      }
    });
    
    function editExtractedRecipeSimple() {
      // Post extracted recipe data to form
      try {
        if (!window.lastExtractedRecipe) {
          alert('No recipe data available');
          return;
        }
        
        // Create a form and submit the data
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/load_recipe_from_url';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'recipe_data';
        input.value = JSON.stringify(window.lastExtractedRecipe);
        
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
    
    function editExtractedRecipe(jsonData) {
      // Store in sessionStorage and redirect to form
      try {
        sessionStorage.setItem('extractedRecipe', jsonData);
        window.location.href = '/?from_url=1';
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
  </script>
</body>
</html>