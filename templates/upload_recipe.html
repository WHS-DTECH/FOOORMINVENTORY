<!DOCTYPE html> <html> <head> <!-- upload_recipe.html--> 
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Recipe</title>
   <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" /> 
    </head> 
    <body> 
        <nav>
            <a href="/">Dashboard</a> |
            <a href="/recbk">Recipe Book</a> |
            <a href="/class_ingredients">Class Ingredients</a> |
            <a href="/booking">Booking Calendar</a> |
            <a href="/shoplist">Shopping List</a> |
            <a href="/admin">Admin</a>
        </nav>
    <div class="container">
    <!-- PDF Preview Modal -->
    {% include 'preview_pdf_modal.html' %}
    <form id="pdfUploadForm" action="/upload" method="POST" enctype="multipart/form-data">
        <div class="flex-row">
            <div class="left-column">
                <h2>Upload Recipe</h2>
                <label for="pdfFile">Upload Recipe PDF:</label>
                <input type="file" id="pdfFile" name="pdfFile" accept="application/pdf">
                <div style="margin:8px 0;">
                    <label for="pageRange">Page Range (e.g. 1-10 or 3,5,7):</label>
                    <input type="text" id="pageRange" name="pageRange" placeholder="All" style="width:120px;">
                    <span style="font-size:0.9em;color:#666;">(Optional)</span>
                </div>
                <button type="button" onclick="previewPdfRecipes()">Preview PDF Recipes</button>
                {% if from_url %}
                <p style="background:#fff3cd;padding:8px;border:1px solid #ffc107;border-radius:4px;">
                    <strong>⚠️ Recipe loaded from URL</strong> - Please review all fields carefully before saving.
                </p>
                {% endif %}
                <label for="name">Recipe Name:</label>
                <input type="text" id="name" name="name" placeholder="Recipe Name" value="{{ prefilled_name or '' }}" required>
                <br>
                <label for="instructions">Instructions:</label>
                <textarea id="instructions" name="instructions" placeholder="Instructions" required>{{ prefilled_instructions or '' }}</textarea>
                <br>
                <label for="original_serving">Original Serving Size:</label>
                <input type="number" id="original_serving" name="serving_size" value="{{ prefilled_serving or 4 }}" min="1" required>
                <br>
                <h3>Equipment</h3>
                <label for="equipment">List equipment (one per line):</label>
                <textarea id="equipment" name="equipment" placeholder="List equipment (one per line)" rows="4"></textarea>
            </div>
            <div class="right-column">
                <h3>Paste Ingredients</h3>
                <textarea id="ingredient_text" placeholder="Paste ingredients here (one per line)" rows="6" aria-label="Paste ingredients here">{{ prefilled_ingredients or '' }}</textarea>
                <button type="button" onclick="parseIngredients()">Format Ingredients</button>
                <h3>Structured Ingredients</h3>
                <table id="ingredients-table" aria-label="Structured ingredients table">
                    <tr>
                        <th>Quantity</th>
                        <th>Unit</th>
                        <th>Ingredient</th>
                    </tr>
                </table>
                <br>
                <button type="submit">Save Recipe</button>
                <h3>Calculate for Desired Serving Size</h3>
                <label for="desired_serving">Enter desired servings:</label>
                <input type="number" id="desired_serving" placeholder="Enter desired servings" min="1" aria-label="Desired servings input">
                <button type="button" onclick="calculateServing()">Calculate</button>
                <div class="result" id="result" aria-live="polite">
                </div>
                <div class="result" id="equipment_result">
                </div>
            </div>
        </div>
    </form>
</div>
<script>

    // --- PDF Preview Logic ---
    function previewPdfRecipes() {
        const pdfInput = document.getElementById('pdfFile');
        if (!pdfInput.files || pdfInput.files.length === 0) {
            alert('Please select a PDF file first.');
            return;
        }
        const formData = new FormData();
        formData.append('pdfFile', pdfInput.files[0]);
        const pageRange = document.getElementById('pageRange').value.trim();
        if (pageRange) {
            formData.append('pageRange', pageRange);
        }
        fetch('/preview_pdf_recipes', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            showPdfPreviewModal(data.recipes, data.page_count);
        })
        .catch(err => {
            alert('Error previewing PDF: ' + err);
        });
    }

    function showPdfPreviewModal(recipes, pageCount) {
        const modal = document.getElementById('pdfPreviewModal');
        const listDiv = document.getElementById('pdfPreviewList');
        let html = `<p>Detected <b>${recipes.length}</b> recipe(s) in PDF (${pageCount} pages):</p>`;
        if (recipes.length === 0) {
            html += '<p style="color:red;">No recipes detected. Please check your PDF or report missing recipes.</p>';
        } else {
            html += '<ul>';
            recipes.forEach((r, idx) => {
                html += `<li><input type="checkbox" class="pdf-recipe-checkbox" data-title="${r.title}" data-page="${r.page}" checked> <input type="text" class="pdf-recipe-title-input" value="${r.title.replace(/"/g, '&quot;')}" data-idx="${idx}" style="width: 60%; font-weight: bold;"> (Page ${r.page})</li>`;
            });
            html += '</ul>';
            html += '<p style="font-size:0.9em; color:#555;">You can edit recipe titles before confirming upload.</p>';
        }
        listDiv.innerHTML = html;
        modal.style.display = 'block';
    }

    function closePdfPreviewModal() {
        document.getElementById('pdfPreviewModal').style.display = 'none';
    }

    function confirmPdfUpload() {
        // Collect selected recipes and their (possibly edited) titles
        const checkboxes = document.querySelectorAll('.pdf-recipe-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Please select at least one recipe to upload.');
            return;
        }
        // Get edited titles
        const titleInputs = document.querySelectorAll('.pdf-recipe-title-input');
        checkboxes.forEach(cb => {
            const li = cb.closest('li');
            if (li) {
                const input = li.querySelector('.pdf-recipe-title-input');
                if (input) {
                    cb.setAttribute('data-title', input.value);
                }
            }
        });
        // Optionally, pass selected titles/pages to backend for upload (not implemented here)
        // For now, just close modal and submit the form
        closePdfPreviewModal();
        document.getElementById('pdfUploadForm').submit();
    }

    function reportMissingRecipes() {
        const checkboxes = document.querySelectorAll('.pdf-recipe-checkbox');
        let missing = [];
        checkboxes.forEach(cb => {
            if (!cb.checked) {
                missing.push({title: cb.getAttribute('data-title'), page: cb.getAttribute('data-page')});
            }
        });
        // Try to get the PDF filename if available
        const pdfInput = document.getElementById('pdfFile');
        let pdfFilename = pdfInput && pdfInput.files.length > 0 ? pdfInput.files[0].name : '';
        fetch('/report_missing_recipes', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                pdf_filename: pdfFilename,
                missing_recipes: missing
            })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message || 'Feedback submitted.');
            closePdfPreviewModal();
        })
        .catch(err => {
            alert('Error reporting missing recipes: ' + err);
        });
    }
    // Auto-parse ingredients on page load if prefilled
    window.addEventListener('load', function() {
        const ingredientText = document.getElementById('ingredient_text').value;
        if (ingredientText && ingredientText.trim().length > 0) {
            console.log('Auto-parsing ingredients on page load...');
            // Increased timeout to ensure DOM is fully ready
            setTimeout(() => {
                parseIngredients();
                console.log('Ingredients parsed automatically');
            }, 300);
        }
    });
    
    function parseIngredients() {
        const text = document.getElementById('ingredient_text').value.trim();
        const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        const table = document.getElementById('ingredients-table');
        while (table.rows.length > 1) {
            table.deleteRow(1);
        }
        const headers = ["ingredients", "glaze", "to serve", "for garnish", "optional"];
        let combinedLines = [];
        for (let i = 0; i < lines.length; i++) {
            const lowerLine = lines[i].toLowerCase();
            if (headers.includes(lowerLine)){
                continue;
            }
            // Don't combine lines - treat each as a separate ingredient
            // Even "pinch of salt" or "salt and pepper" should be standalone
            combinedLines.push(lines[i]);
        }
        combinedLines.forEach(line => {
            // Updated regex to capture ranges like "½–1", "1-2", "2 - 3", etc.
            // Also handles fractions and decimals
            const match = line.match(/^((?:\d+\s?\d*\/\d+|\d+(?:\.\d+)?|½|¼|¾)(?:\s*[-–—]\s*(?:\d+\s?\d*\/\d+|\d+(?:\.\d+)?|½|¼|¾))?)?\s*(.*)$/);
            let quantity = match && match[1] ? match[1].trim() : '';
            let remainder = match && match[2] ? match[2].trim() : '';
            let rangeNote = '';
            
            // Handle ranges - use the higher value for quantity
            if (quantity && /[-–—]/.test(quantity)) {
                const rangeParts = quantity.split(/\s*[-–—]\s*/);
                if (rangeParts.length === 2) {
                    // Convert both parts and use the average or higher value
                    let val1 = rangeParts[0];
                    let val2 = rangeParts[1];
                    
                    // Convert fractions
                    if (val1 === '½') val1 = '0.5';
                    else if (val1 === '¼') val1 = '0.25';
                    else if (val1 === '¾') val1 = '0.75';
                    
                    if (val2 === '½') val2 = '0.5';
                    else if (val2 === '¼') val2 = '0.25';
                    else if (val2 === '¾') val2 = '0.75';
                    
                    // Use the higher value (or average)
                    const num1 = parseFloat(val1);
                    const num2 = parseFloat(val2);
                    if (!isNaN(num1) && !isNaN(num2)) {
                        quantity = num2.toString(); // Use higher value
                        rangeNote = `(${rangeParts[0]}-${rangeParts[1]} range) `;
                    }
                }
            }
            
            // Convert fractions to decimal
            if (quantity.includes('/')) {
                if (quantity.includes(' ')) {
                    const mixedParts = quantity.split(' ');
                    if (mixedParts.length === 2 && mixedParts[1].includes('/')) {
                        const fractionParts = mixedParts[1].split('/');
                        quantity = (parseFloat(mixedParts[0]) + (parseFloat(fractionParts[0]) / parseFloat(fractionParts[1]))).toFixed(2);
                    }
                    else {
                        const parts = quantity.split('/');
                        if (parts.length === 2) {
                            quantity = (parseFloat(parts[0]) / parseFloat(parts[1])).toFixed(2);
                        }
                    }
                }
                else {
                    const parts = quantity.split('/');
                    if (parts.length === 2) {
                        quantity = (parseFloat(parts[0]) / parseFloat(parts[1])).toFixed(2);
                    }
                }
            }
            else if (quantity === '½') quantity = 0.5;
            else if (quantity === '¼') quantity = 0.25;
            else if (quantity === '¾') quantity = 0.75;
            // Separate unit from remainder (before adding range note)
            const unitsList = ['kg','g','ml','l','tbsp','tsp','cup','cups','oz','lb','no.','no','piece','pieces','whole','clove','cloves','pinch'];
            let unit = '';
            let ingredient = remainder;
            const words = remainder.split(' ');
            if (words.length > 0 && unitsList.includes(words[0].toLowerCase())) {
                unit = words.shift();
                ingredient = words.join(' ');
            }
            // Now add range note to ingredient if it exists
            if (rangeNote) {
                ingredient = rangeNote + ingredient;
            }
            
            // Set defaults for missing values to satisfy form validation
            if (!quantity && unit) {
                // Has unit but no quantity (e.g., "pinch of salt") - default to 1
                quantity = '1';
            }
            if (!quantity && !unit && ingredient) {
                // No quantity or unit (e.g., "salt and pepper") - set both defaults
                quantity = '1';
                unit = 'to taste';
            }
            if (quantity && !unit && ingredient) {
                // Has quantity but no unit (e.g., "2 eggs") - default to appropriate unit
                unit = 'item';
            }
            
            const row = table.insertRow();
            row.innerHTML = `<td><input type="number" step="0.01" name="quantity[]" value="${quantity}" required></td>\n                    <td><input type="text" name="unit[]" value="${unit}" required></td>\n                    <td><input type="text" name="ingredient[]" value="${ingredient}" required></td>`;
        });
    }

    function calculateServing() {
        const originalServing = parseFloat(document.getElementById('original_serving').value);
        const desiredServing = parseFloat(document.getElementById('desired_serving').value);
        if (!desiredServing || desiredServing <= 0) {
            alert("Please enter a valid desired serving size.");
            return;
        }
        const rows = document.querySelectorAll('#ingredients-table tr');
        let resultHTML = `<h4>Ingredients for ${desiredServing} servings:</h4><ul>`;
        for (let i = 1; i < rows.length; i++) {
            const quantity = parseFloat(rows[i].querySelector('input[name="quantity[]"]').value);
            const unit = rows[i].querySelector('input[name="unit[]"]').value;
            const ingredient = rows[i].querySelector('input[name="ingredient[]"]').value;
            if (!isNaN(quantity)) {
                const newQuantity = (quantity / originalServing) * desiredServing;
                resultHTML += `<li>${newQuantity.toFixed(2)} ${unit} ${ingredient}</li>`;
            } else {
                resultHTML += `<li>${ingredient}</li>`;
            }
        }
        resultHTML += "</ul>";
        document.getElementById('result').innerHTML = resultHTML;
    }
</script>
</body> 
</html>