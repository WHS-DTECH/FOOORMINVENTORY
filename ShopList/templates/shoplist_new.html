{% extends "base.html" %}
{% block title %}Book the Shopping{% endblock %}
{% block content %}
<div style="display: flex; flex-direction: column; align-items: center; margin-top: 32px; margin-bottom: 24px;">
  <h1 style="font-size: 2.5em; font-weight: bold; text-align: center;">Book the Shopping</h1>
  <div style="font-size: 1.5em; font-weight: bold; margin-top: 8px; text-align: center;">{{ week_label }}</div>
  <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: center;">
    <a href="?week={{ week_offset - 1 }}" style="text-decoration: none;"><button>&#8592; Previous</button></a>
    <a href="?week=0" style="text-decoration: none;"><button>Today</button></a>
    <a href="?week={{ week_offset + 1 }}" style="text-decoration: none;"><button>Next &#8594;</button></a>
  </div>
</div>

  <!-- 3-column layout for Scheduled Bookings, Calculate Servings, and Calculated/Original Ingredients -->
  <div style="display: flex; flex-direction: row; align-items: flex-start; justify-content: center; margin-top: 36px; margin-bottom: 24px; gap: 32px;">
    <!-- Left Column: Scheduled Bookings (Sorted by Teacher) -->
    <div style="flex: 1 1 400px; max-width: 500px; min-width: 340px; background: #f8fafc; border-radius: 10px; box-shadow: 0 2px 8px #e0e4ea; padding: 18px 18px 14px 18px; text-align: left;">
      <div style="font-weight: bold; font-size: 1.2em; margin-bottom: 8px;">Scheduled Bookings (Sorted by Teacher)</div>
      {% set teacher_map = {} %}
      {# teacher_color_map is built below for the grid, so we need to build it here too if not defined #}
      {% if teacher_color_map is not defined or not teacher_color_map %}
        {% set teacher_colors = ['#1976d2', '#43a047', '#e53935', '#fbc02d', '#8e24aa', '#00838f', '#6d4c41', '#c62828', '#3949ab', '#f57c00'] %}
        {% set teacher_color_map = {} %}
        {% set teacher_idx = 0 %}
        {% for b in selected_bookings %}
          {% set teacher_key = b.teacher|trim|lower %}
          {% if teacher_key and teacher_key not in teacher_color_map %}
            {% set _ = teacher_color_map.update({teacher_key: teacher_colors[teacher_idx % teacher_colors|length]}) %}
            {% set teacher_idx = teacher_idx + 1 %}
          {% endif %}
        {% endfor %}
      {% endif %}
      {% for b in selected_bookings %}
        {% set teacher_key = b.teacher|trim|lower %}
        {% if teacher_key not in teacher_map %}
          {% set _ = teacher_map.update({teacher_key: {'teacher': b.teacher, 'staff_code': b.staff_code, 'bookings': []}}) %}
        {% endif %}
        {% set _ = teacher_map[teacher_key]['bookings'].append({'date': b.date, 'class': b.class, 'recipe': b.recipe, 'recipe_id': b.recipe_id, 'servings': b.get('servings', '')}) %}
      {% endfor %}
      {% for teacher_key, tinfo in teacher_map.items() %}
        <div style="font-weight: bold; margin-top: 8px; display: flex; align-items: center;">
          {% if teacher_color_map[teacher_key] %}<span style="display:inline-block; width:16px; height:16px; border-radius:4px; margin-right:8px; background: {{ teacher_color_map[teacher_key]|default('#ccc') }};"></span>{% endif %}
          {{ tinfo.teacher }} ({{ tinfo.staff_code }})
        </div>
        <ul style="margin: 0 0 8px 18px; padding: 0; list-style: none;">
          {% for booking in tinfo.bookings %}
            <li style="display: flex; align-items: center; margin-bottom: 2px; cursor:pointer;" class="booking-class-item" data-recipe-id="{{ booking.recipe_id }}">
              <input type="checkbox" class="booking-checkbox" style="margin-right: 8px;" 
                data-date="{{ booking.date }}" data-class="{{ booking.class }}" data-recipe="{{ booking.recipe }}" data-recipe-id="{{ booking.recipe_id }}">
              <span>{{ booking.date }} | {{ booking.class }} | 
                {% if booking.recipe_id %}
                  <a href="/recipe/{{ booking.recipe_id }}" target="_blank">{{ booking.recipe }}</a>
                {% else %}
                  {{ booking.recipe }}
                {% endif %}
                {% if booking.servings %} ({{ booking.servings }} servings){% endif %}
              </span>
            </li>
          {% endfor %}
        </ul>
      {% endfor %}
      <div style="display: flex; flex-direction: row; gap: 8px; margin-bottom: 0; margin-top: 8px;">
        <button id="selectAllBookingsBtn" style="flex:1; min-width: 120px; font-size: 1em; padding: 7px 0;">Select All</button>
        <button id="clearAllBookingsBtn" style="flex:1; min-width: 120px; font-size: 1em; padding: 7px 0;">Clear All</button>
        <button id="showScheduledBtn" style="flex:1.5; min-width: 160px; font-size: 1em; padding: 7px 0; background: #2196f3; color: #fff; font-weight: bold; border: none; border-radius: 4px; box-shadow: 0 2px 8px #e0e4ea; cursor: pointer;">Print Scheduled Bookings</button>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var selectAllBtn = document.getElementById('selectAllBookingsBtn');
          if (selectAllBtn) {
            selectAllBtn.onclick = function() {
              document.querySelectorAll('.booking-checkbox').forEach(function(cb) {
                cb.checked = true;
              });
            };
          }
          var clearAllBtn = document.getElementById('clearAllBookingsBtn');
          if (clearAllBtn) {
            clearAllBtn.onclick = function() {
              document.querySelectorAll('.booking-checkbox').forEach(function(cb) {
                cb.checked = false;
              });
            };
          }
        });
      </script>
    </div>
    <!-- Middle Column: Calculate Servings and Original Ingredients -->
    <div style="flex: 1 1 300px; min-width: 220px; max-width: 340px; background: #f8fafc; border-radius: 10px; box-shadow: 0 2px 8px #e0e4ea; padding: 18px 18px 14px 18px; text-align: left;">
      <div style="font-weight: bold; font-size: 1.2em; margin-bottom: 12px;">Calculate servings</div>
      <div class="card mb-3 p-3" style="background: #fff; border-radius: 8px; box-shadow: 0 1px 2px #eee;">
        <div class="mb-2">
          <label for="recipeSelectShopping" style="font-weight: normal;">Choose recipe</label>
          <select id="recipeSelectShopping" class="form-control"></select>
        </div>
        <div class="mb-2">
          <label for="servingsInputShopping" style="font-weight: normal;">Enter desired servings</label>
          <input type="number" id="servingsInputShopping" class="form-control" value="24" min="1">
        </div>
        <button type="button" id="calculateServingsBtnShopping" class="btn btn-primary mt-2 mb-2">Calculate for Desired Serving Size</button>
      </div>
      <div style="margin-top: 18px;">
        <strong id="originalIngredientsHeading">Original Ingredients</strong>
        <ul id="originalIngredientsListShopping" class="mb-2"></ul>
      </div>
    </div>
    <!-- Right Column: Calculated Ingredients (duplicated) -->
    <div style="flex: 1 1 300px; min-width: 220px; max-width: 340px; background: #f8fafc; border-radius: 10px; box-shadow: 0 2px 8px #e0e4ea; padding: 18px 18px 14px 18px; text-align: left;">
      <div>
        <strong>Ingredients (Single Serve)</strong>
        <ul id="calculatedIngredientsShopping" class="mb-0"></ul>
      </div>
      <div style="margin-top: 18px;">
        <strong>Calculated Ingredients (Copy)</strong>
        <ul id="calculatedIngredientsShoppingCopy" class="mb-0"></ul>
      </div>
    </div>
  </div>

  <script>
  // Restore recipe dropdown and calculation logic for Calculate Servings
  const recipesShopping = {{ recipes|default([])|tojson|safe }};

  function renderRecipeOptionsShopping() {
    const select = document.getElementById('recipeSelectShopping');
    if (!select || !recipesShopping) return;
    select.innerHTML = '<option value="">-- Choose a recipe --</option>' +
      recipesShopping.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
  }

  function renderOriginalIngredientsShopping(recipe) {
    const ul = document.getElementById('originalIngredientsListShopping');
    const heading = document.getElementById('originalIngredientsHeading');
    if (!ul) return;
    ul.innerHTML = '';
    if (!recipe) {
      if (heading) heading.textContent = 'Original Ingredients';
      return;
    }
    if (heading) {
      let serv = recipe.serving_size ? ` (Original Serving Size: ${recipe.serving_size})` : '';
      heading.textContent = 'Original Ingredients' + serv;
    }
    if (!recipe.ingredients || recipe.ingredients.length === 0) {
      ul.innerHTML = '<li>No structured ingredients available.</li>';
      return;
    }
    recipe.ingredients.forEach(it => {
      const li = document.createElement('li');
      if (typeof it === 'object') {
        let q = it.quantity || '';
        let u = it.unit || '';
        let name = it.ingredient || '';
        li.textContent = ((q || u) ? ((q !== '' ? q + ' ' : '') + (u ? u + ' ' : '')) : '') + name;
      } else {
        li.textContent = it;
      }
      ul.appendChild(li);
    });
  }

  function calculateIngredientsShopping() {
    const select = document.getElementById('recipeSelectShopping');
    const rid = select ? select.value : null;
    const desiredEl = document.getElementById('servingsInputShopping');
    const desired = desiredEl ? (parseFloat(desiredEl.value) || 24) : 24;
    const rec = recipesShopping.find(r => String(r.id) === String(rid));
    const out = document.getElementById('calculatedIngredientsShopping');
    const outCopy = document.getElementById('calculatedIngredientsShoppingCopy');
    if (!out) return;
    out.innerHTML = '';
    if (outCopy) outCopy.innerHTML = '';
    if (!rec) {
      out.innerHTML = '<li>Select a recipe first.</li>';
      if (outCopy) outCopy.innerHTML = '<li>Select a recipe first.</li>';
      return;
    }
    const origServ = parseInt(rec.serving_size) || 1;
    // Top box: per single serve
    // Use a table for math column and ingredient
    out.innerHTML = '';
    const tbl = document.createElement('table');
    tbl.style.width = '100%';
    rec.ingredients.forEach(it => {
      let name = '';
      let qty = null;
      let unit = '';
      if (typeof it === 'object') {
        name = it.ingredient || '';
        qty = it.quantity !== undefined && it.quantity !== null && it.quantity !== '' ? parseFloat(it.quantity) : null;
        unit = it.unit || '';
      } else {
        name = it;
      }
      const tr = document.createElement('tr');
      const tdMath = document.createElement('td');
      const tdIng = document.createElement('td');
      if (qty !== null && !isNaN(qty) && origServ > 0) {
        let perSingle = qty / origServ;
        let display = Math.round((perSingle + Number.EPSILON) * 100) / 100;
        if (Number.isInteger(display)) display = parseInt(display);
        tdMath.style.color = '#888';
        tdMath.style.fontSize = '0.98em';
        tdMath.style.paddingRight = '10px';
        tdMath.textContent = `${qty} ÷ ${origServ} =`;
        tdIng.textContent = display + (unit ? (' ' + unit) : '') + ' ' + name;
      } else {
        tdMath.textContent = '';
        tdIng.textContent = name;
      }
      tr.appendChild(tdMath);
      tr.appendChild(tdIng);
      tbl.appendChild(tr);
    });
    out.appendChild(tbl);
    // Second box: calculated for desired servings
    if (outCopy) {
      rec.ingredients.forEach(it => {
        let name = '';
        let qty = null;
        let unit = '';
        if (typeof it === 'object') {
          name = it.ingredient || '';
          qty = parseFloat(it.quantity);
          unit = it.unit || '';
        } else {
          name = it;
        }
        let perSingle = null;
        if (qty !== null && !isNaN(qty) && origServ > 0) {
          perSingle = qty / origServ;
        }
        const scaled = (perSingle !== null) ? (perSingle * desired) : null;
        const li = document.createElement('li');
        if (scaled !== null && !isNaN(scaled)) {
          let display = Math.round((scaled + Number.EPSILON) * 100) / 100;
          if (Number.isInteger(display)) display = parseInt(display);
          li.textContent = display + (unit ? (' ' + unit) : '') + ' ' + name;
        } else {
          li.textContent = name;
        }
        outCopy.appendChild(li);
      });
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    renderRecipeOptionsShopping();
    function updateAllIngredientBlocks() {
      const select = document.getElementById('recipeSelectShopping');
      const rec = recipesShopping.find(r => String(r.id) === String(select.value));
      renderOriginalIngredientsShopping(rec);
      calculateIngredientsShopping();
    }
    document.getElementById('recipeSelectShopping').addEventListener('change', updateAllIngredientBlocks);
    document.getElementById('calculateServingsBtnShopping').addEventListener('click', calculateIngredientsShopping);
    // Initial render: show per-serve if a recipe is preselected
    updateAllIngredientBlocks();

    // Prepopulate Choose Recipe when a class is clicked
    document.querySelectorAll('.booking-class-item').forEach(function(item) {
      item.addEventListener('click', function(e) {
        const recipeId = this.getAttribute('data-recipe-id');
        const recipeName = this.querySelector('span').innerText.split('|').pop().trim();
        const recipeSelect = document.getElementById('recipeSelectShopping');
        // Always re-render dropdown before setting value
        renderRecipeOptionsShopping();
        let found = false;
        if (recipeId && recipeSelect.querySelector(`option[value="${recipeId}"]`)) {
          recipeSelect.value = recipeId;
          recipeSelect.dispatchEvent(new Event('change'));
          found = true;
        }
        // Fallback: try to match by recipe name if ID is missing or not found
        if (!found && recipeName) {
          const rec = recipesShopping.find(r => r.name && r.name.trim() === recipeName);
          if (rec) {
            recipeSelect.value = rec.id;
            recipeSelect.dispatchEvent(new Event('change'));
          }
        }
      });
    });
  });
  </script>

  <!-- Scheduled Bookings Popup Modal (Image 4 style) -->
  <div id="scheduledModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#f6fafd; border-radius:8px; box-shadow:0 2px 16px #b0b8c9; padding:24px 18px 18px 18px; min-width:650px; max-width:98vw; margin:40px auto; position:relative;">
      <div style="font-weight:600; color:#1976d2; font-size:1.15em; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
        <span>Scheduled Bookings</span>
        <span>
          <button id="printModalBtn" class="btn btn-success btn-sm" style="margin-right:10px;">Print</button>
          <span onclick="document.getElementById('scheduledModal').style.display='none'" style="font-size:1.3em; color:#888; cursor:pointer;">&times;</span>
        </span>
      </div>
      <div class="text-muted" style="font-size:0.97em; margin-bottom:8px;">Click any booking to edit its details</div>
      <div id="scheduledPrintArea" style="overflow-x:auto;">
        <table id="scheduledTable" style="width:100%; border-collapse:collapse; background:#fff; border-radius:6px;">
          <thead>
            <tr style="background:#f2f4f8; color:#222;">
              <th style="padding:6px 10px; text-align:left;">Date</th>
              <th style="padding:6px 10px; text-align:left;">Period</th>
              <th style="padding:6px 10px; text-align:left;">Staff</th>
              <th style="padding:6px 10px; text-align:left;">Class</th>
              <th style="padding:6px 10px; text-align:left;">Recipe</th>
              <th style="padding:6px 10px; text-align:left;">Servings</th>
            </tr>
          </thead>
          <tbody id="scheduledTableBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
    document.getElementById('showScheduledBtn').onclick = function() {
      document.getElementById('scheduledModal').style.display = 'flex';
      // Fetch and render scheduled bookings
      fetch('/api/scheduled_bookings').then(r => r.json()).then(data => {
        const tbody = document.getElementById('scheduledTableBody');
        tbody.innerHTML = '';
        if (data.success && data.bookings.length > 0) {
          data.bookings.forEach(b => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td style="padding:6px 10px;">${b.date_required}</td>
              <td style="padding:6px 10px;">${b.period}</td>
              <td style="padding:6px 10px;">${b.staff_display}</td>
              <td style="padding:6px 10px;">${b.class_code}</td>
              <td style="padding:6px 10px;">${b.recipe_name || ''}</td>
              <td style="padding:6px 10px;">${b.servings}</td>
              <td style="padding:6px 4px;">
                <button class="btn btn-primary btn-sm btn-edit-booking" type="button">Edit</button>
                <button class="btn btn-danger btn-sm btn-delete-booking" type="button">Delete</button>
              </td>
            `;
            // Store booking data as dataset for easy access
            tr.dataset.booking = JSON.stringify(b);
            // Add event listeners for Edit and Delete
            tr.querySelector('.btn-edit-booking').addEventListener('click', function(e) {
              e.stopPropagation();
              editBookingFromModal(b);
            });
            tr.querySelector('.btn-delete-booking').addEventListener('click', function(e) {
              e.stopPropagation();
              deleteBookingFromModal(b);
            });
            tbody.appendChild(tr);
          });
        } else {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="7" style="padding:8px; text-align:center; color:#888;">No bookings found.</td>';
          tbody.appendChild(tr);
        }
      });
    };

    // Edit booking handler (to be implemented: populate a form for editing)
    function editBookingFromModal(booking) {
      alert('Edit booking not yet implemented.\nBooking details: ' + JSON.stringify(booking, null, 2));
      // TODO: Populate a form for editing and allow update
    }

    // Delete booking handler
    function deleteBookingFromModal(booking) {
      if (!confirm('Are you sure you want to delete this booking?')) return;
      // TODO: Use the correct booking id field if available
      if (!booking.id && !booking.booking_id) {
        alert('Booking ID not found.');
        return;
      }
      const bookingId = booking.id || booking.booking_id;
      fetch(`/class_ingredients/delete/${bookingId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(r => r.json())
      .then(j => {
        if (j.success) {
          alert('Booking deleted');
          document.getElementById('showScheduledBtn').click(); // Refresh modal
        } else {
          alert('Delete failed');
        }
      })
      .catch(e => alert('Error: ' + e.message));
    }
    };
    // Print modal content
    document.getElementById('printModalBtn').onclick = function() {
      var printContents = document.getElementById('scheduledPrintArea').innerHTML;
      var win = window.open('', '', 'height=700,width=900');
      win.document.write('<html><head><title>Scheduled Bookings</title>');
      win.document.write('<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">');
      win.document.write('<style>body{margin:20px;} table{font-size:14px;} th,td{padding:4px 8px;}</style>');
      win.document.write('</head><body>');
      win.document.write('<h3>Scheduled Bookings</h3>');
      win.document.write(printContents);
      win.document.write('</body></html>');
      win.document.close();
      win.focus();
      setTimeout(function(){ win.print(); win.close(); }, 500);
    };
  </script>

  <div style="display: flex; flex-direction: column; align-items: center; margin-top: 40px;">
    <table style="border-collapse: collapse; background: #f8fafc; box-shadow: 0 2px 8px #e0e4ea; min-width: 700px;">
      <thead>
        <tr>
          <th style="border: 1px solid #cfd8dc; background: #f3f6fa; padding: 8px 12px; font-weight: bold;">Period</th>
          {% for date in week_dates %}
            <th style="border: 1px solid #cfd8dc; background: #e3ecf7; padding: 8px 12px; font-weight: bold;">
              {{ date.strftime('%A') }}<br>{{ date.strftime('%d/%m/%y') }}
            </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% set teacher_colors = ['#1976d2', '#43a047', '#e53935', '#fbc02d', '#8e24aa', '#00838f', '#6d4c41', '#c62828', '#3949ab', '#f57c00'] %}
        {% set teacher_color_map = {} %}
        {% set teacher_idx = 0 %}
        {# Build teacher_color_map from scheduled_bookings #}
        {% for b in scheduled_bookings %}
          {% set teacher_key = b.staff|default('')|trim|lower %}
          {% if teacher_key and teacher_key not in teacher_color_map %}
            {% set _ = teacher_color_map.update({teacher_key: teacher_colors[teacher_idx % teacher_colors|length]}) %}
            {% set teacher_idx = teacher_idx + 1 %}
          {% endif %}
        {% endfor %}
        {# Build week_dates_str as a list of date strings #}
        {% set week_dates_str = [] %}
        {% for d in week_dates %}
          {% set _ = week_dates_str.append(d.strftime('%Y-%m-%d')) %}
        {% endfor %}
        {% for period in range(1,6) %}
        <tr>
          <td style="border: 1px solid #cfd8dc; background: #f3f6fa; text-align: center; font-weight: bold;">P{{ period }}</td>
          {% for date in week_dates %}
          <td style="border: 1px solid #cfd8dc; background: #fff; min-width: 120px; height: 70px; text-align: left; vertical-align: top; color: #222;">
            {% set booking = grid[(period, date)] %}
            {% if booking %}
              <div style="background: {{ booking.light_color|default('#fff') }}; color: #222; border: 1px solid {{ booking.color|default('#1976d2') }}; border-radius: 7px; padding: 7px 10px 7px 10px; margin-bottom: 5px; font-size: 1em; font-family: inherit; min-width: 160px; box-shadow: 0 1px 2px #e0e4ea;">
                <div style="font-weight: bold; font-size: 1.08em; margin-bottom: 2px;">{{ booking.recipe }}</div>
                <div style="font-size: 0.98em;">Class: {{ booking.class }}</div>
                <div style="font-size: 0.98em;">Teacher: {{ booking.staff.split(' - ')[1] if ' - ' in booking.staff else booking.staff }}</div>
                <div style="font-size: 0.98em;">Servings: {{ booking.servings }}</div>
                <div style="font-size: 0.98em;">{{ booking.date_display }}</div>
                <div style="font-size: 0.95em; color: #444; margin-top: 2px;">Tap to select</div>
              </div>
            {% else %}
              &mdash;
            {% endif %}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <!-- Generate Shopping List Button moved above -->
  </div>
  <!-- Removed stray unclosed div tag here -->

  <!-- Removed duplicate Selected Bookings block below the grid -->

  <!-- Three-column Shopping List Section -->
  <div style="display: flex; justify-content: center; gap: 32px; align-items: flex-start; margin-bottom: 40px;">
    <!-- Original Recipe Details (Left) -->
    <div id="originalRecipeDetails" style="flex: 1 1 340px; min-width: 280px; max-width: 420px; background: #f8fafc; border-radius: 10px; box-shadow: 0 2px 8px #e0e4ea; padding: 18px 20px;">
      <div style="font-weight: bold; font-size: 1.2em; margin-bottom: 8px;">Original Recipe Details</div>
      <div id="recipeDetailsContent">
        <div style='color:#888;'>Select a class to view recipe details.</div>
      </div>
    </div>
    <script>
    // Listen for booking checkbox changes and fetch recipe details
    document.addEventListener('DOMContentLoaded', function() {
      function getSelectedBookings() {
        return Array.from(document.querySelectorAll('.booking-checkbox:checked')).map(cb => ({
          recipe: cb.getAttribute('data-recipe')
        })).filter(b => b.recipe);
      }

      function renderRecipeDetails(recipes) {
        const container = document.getElementById('recipeDetailsContent');
        if (!recipes || recipes.length === 0) {
          container.innerHTML = "<div style='color:#888;'>Select a class to view recipe details.</div>";
          return;
        }
        container.innerHTML = recipes.map(r => `
          <div style='font-weight:bold; margin-bottom:4px;'>${r.name}</div>
          <div>Original Servings: <span>${r.serving_size || '--'}</span></div>
          <div style='font-weight:bold; margin:8px 0 4px 0;'>Ingredients</div>
          <ul style='margin:0 0 12px 18px; padding:0;'>
            ${(r.ingredients && r.ingredients.length > 0) ? r.ingredients.map(i => `<li>${i}</li>`).join('') : '<li>No ingredients listed.</li>'}
          </ul>
        `).join('<hr style="margin:10px 0;">');
      }

      function fetchAndShowRecipeDetails() {
        const bookings = getSelectedBookings();
        if (bookings.length === 0) {
          renderRecipeDetails([]);
          return;
        }
        fetch('/get_original_recipes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bookings })
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            renderRecipeDetails(data.recipes);
          } else {
            renderRecipeDetails([]);
          }
        })
        .catch(() => renderRecipeDetails([]));
      }

      document.querySelectorAll('.booking-checkbox').forEach(cb => {
        cb.addEventListener('change', fetchAndShowRecipeDetails);
      });

      // Optionally, show details for pre-checked boxes on load
      fetchAndShowRecipeDetails();
    });
    </script>
    <!-- Master Shopping List (Middle) -->
    <div style="flex: 1 1 340px; min-width: 280px; max-width: 420px; background: #f8fafc; border-radius: 10px; box-shadow: 0 2px 8px #e0e4ea; padding: 18px 20px;">
      <div style="font-weight: bold; font-size: 1.2em; margin-bottom: 8px;">Master Shopping List</div>
      <div style="font-weight: bold; margin-bottom: 4px;">Other</div>
      <ul style="margin: 0 0 0 18px; padding: 0;">
        <li>1-2 tblsp fresh breadcrumbs — 0</li>
        <li>apples — 2 no.</li>
        <li>Baking soda — 1 tsp</li>
        <li>Black pepper — 0</li>
        <li>brown or white sugar — 30 g</li>
        <li>Brown sugar — 0.75 cup</li>
        <li>butter — 50 butter</li>
        <li>Butter (softened) — 1 cup</li>
        <li>butter or margarine — 60 g</li>
        <li>cheese — 100 grated</li>
        <li>Chocolate chips — 2 cups</li>
        <li>Don’t forget a container to take your cauliflower cheese home in — 0</li>
        <li>Eggs — 2 whole</li>
        <li>flour — 80 g</li>
        <li>flour — 50 plain</li>
        <li>Flour — 2 cups</li>
        <li>Granulated sugar — 0.5 cup</li>
        <li>milk — 500 milk</li>
        <li>oats — 40 g</li>
        <li>of cauliflower OR 1 head of broccoli OR a mix of both — 1 head</li>
        <li>Salt — 0.5 tsp</li>
        <li>sultanas — 50 g</li>
        <li>Vanilla extract — 1 tsp</li>
      </ul>
    </div>
    <!-- Shopping List by Teacher (Right) -->
    <div style="flex: 1 1 340px; min-width: 280px; max-width: 420px; background: #f8fafc; border-radius: 10px; box-shadow: 0 2px 8px #e0e4ea; padding: 18px 20px;">
      <div style="font-weight: bold; font-size: 1.2em; margin-bottom: 8px;">Shopping List</div>
      <!-- Placeholder for Shopping List by Teacher -->
      <div style="font-weight: bold; color: #1976d2; background: #e3ecf7; border-radius: 6px; padding: 8px 12px; margin-bottom: 6px;">Teacher: Pringle</div>
      <ul style="margin: 0 0 8px 18px; padding: 0;">
        <li>300HOSP | Chocolate Chip Cookies | P3 | 2025-12-16</li>
        <li>SDFOOD | Apple and Sultana Crumble | P4 | 2025-12-18</li>
      </ul>
      <div style="font-weight: bold; margin-bottom: 4px;">Other</div>
      <ul style="margin: 0 0 12px 18px; padding: 0;">
        <li>apples — 2 no.</li>
        <li>Baking soda — 1 tsp</li>
        <li>brown or white sugar — 30 g</li>
        <li>Brown sugar — 0.75 cup</li>
        <li>Butter (softened) — 1 cup</li>
        <li>butter or margarine — 60 g</li>
        <li>Chocolate chips — 2 cups</li>
        <li>Eggs — 2 whole</li>
        <li>flour — 80 g</li>
        <li>Flour — 2 cups</li>
        <li>Granulated sugar — 0.5 cup</li>
        <li>oats — 40 g</li>
        <li>Salt — 0.5 tsp</li>
        <li>sultanas — 50 g</li>
        <li>Vanilla extract — 1 tsp</li>
      </ul>
      <!-- Teacher: Diplock -->
      <div style="font-weight: bold; color: #1976d2; background: #e3ecf7; border-radius: 6px; padding: 8px 12px; margin-bottom: 6px;">Teacher: Diplock</div>
      <ul style="margin: 0 0 8px 18px; padding: 0;">
        <li>300HOSP | Cauliflower Cheese | P4 | 2025-12-19</li>
      </ul>
      <div style="font-weight: bold; margin-bottom: 4px;">Other</div>
      <ul style="margin: 0 0 0 18px; padding: 0;">
        <li>1-2 tblsp fresh breadcrumbs — 0</li>
        <li>Black pepper — 0</li>
        <li>butter — 50 butter</li>
        <li>Don’t forget a container to take your cauliflower cheese home in — 0</li>
        <li>milk — 500 milk</li>
        <li>of cauliflower OR 1 head of broccoli OR a mix of both — 1 head</li>
      </ul>
    </div>
  </div>
{% endblock %}
