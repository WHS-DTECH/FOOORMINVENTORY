{% extends "base.html" %}
{% block content %}
<style>
.parser-debug-container {
  display: flex;
  gap: 32px;
  align-items: flex-start;
  margin-top: 2em;
}
.parser-debug-col {
  flex: 1 1 0;
  min-width: 220px;
}
.debug-btn {
  background: #d32f2f;
  color: #fff;

  border: none;
  padding: 6px 16px;
  border-radius: 4px;
  margin-right: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}
.confirm-btn {
  background: #388e3c;
  color: #fff;
  font-weight: bold;
  border: none;
  padding: 6px 16px;    
  border-radius: 4px; 
}
.grey-btn {
    background: #757575;
    color: #fff;
    font-weight: bold;
    border: none;
    padding: 6px 16px;
    border-radius: 4px;
    margin-right: 8px;
}
@media (max-width: 900px) {
  .parser-debug-container {
    flex-direction: column;
    gap: 16px;
  }
}
</style>

 <body>
    <div class="container-fluid" style="padding:0 32px;">
        <!-- Debug: Show raw JSON of all_confirmed_parser_fields -->
        {# <pre>{{ all_confirmed_parser_fields | tojson(indent=2) }}</pre> #}
        <!-- All Confirmed Parser Fields Table -->
        <div style="margin-top:2em;">
            <h5>Confirmed Values Index</h5>
            <table class="table table-bordered table-sm" style="background:#fff;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Parser Debug ID</th>
                        <th>Parser Test Recipe ID</th>
                        <th>Parser Debug</th>
                        <th>Title</th>
                        <th>Serving Size</th>
                        <th>Source URL</th>
                        <th>Ingredients</th>
                        <th>Instructions</th>
                        <th>Confirmed By</th>
                        <th>Confirmed At</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% if all_confirmed_parser_fields and all_confirmed_parser_fields|length > 0 %}
                        {% for row in all_confirmed_parser_fields %}
                        <tr>
                            <td>{{ row.id }}</td>
                            <td>{{ row.parser_debug_id }}</td>
                            <td>{{ row.parser_parser_debug_id }}</td>
                            <td>{{ row.parser_debug }}</td>
                            <td>{{ row.title }}</td>
                            <td>{{ row.serving_size }}</td>
                            <td>{{ row.source_url }}</td>
                            <td>{{ row.ingredients }}</td>
                            <td>{{ row.instructions }}</td>
                            <td>{{ row.confirmed_by }}</td>
                            <td>{{ row.confirmed_at }}</td>
                            <td>
                                <form method="post" action="/delete_confirmed_parser_field/{{ row.id }}" style="display:inline;">
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this confirmed field record?');">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="9" class="text-center text-muted">No records in confirmed_parser_fields table.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
<div style="width:100%; text-align:center; margin-top:2em;">
    <h1 style="font-size:2.2rem; font-weight:bold; margin-bottom:0.5em;">Parser Debug: Flagged/Test Recipe</h1>
</div>
<div style="width:100%; display:flex; justify-content:center; margin-bottom:2em;">
    <div style="max-width:700px; background:#fafafa; border-radius:6px; box-shadow:0 1px 4px #eee; padding:1em 2em; font-size:1rem; text-align:left;">
        {% if parser_debug %}
            <div><strong>Source Address:</strong> <a href="{{ parser_debug.extracted_title or '' }}" target="_blank">{{ parser_debug.extracted_title or '' }}</a></div>
            <div>Flagged by: {{ parser_debug.user_id or '' }}</div>
            <div>Flagged at: {{ parser_debug.created_at or '' }}</div>
            <div><strong>Notes:</strong> {{ parser_debug.notes or '' }}</div>
            <div><strong>Source Type:</strong> {{ parser_debug.solution or '' }}</div>
            <div><strong>Recipe ID:</strong> {{ parser_debug.recipe_id or 'N/A' }}</div>
        {% else %}
            <div><strong>Source Address:</strong> <a href="{{ test_recipe.upload_source_detail }}" target="_blank">{{ test_recipe.upload_source_detail }}</a></div>
            <div>Flagged by: {{ test_recipe.uploaded_by }}</div>
            <div>Flagged at: {{ test_recipe.upload_date }}</div>
            <div><strong>Notes:</strong> {{ test_recipe.notes }}</div>
            <div><strong>Source Type:</strong> {{ test_recipe.upload_source_type }}</div>
            <div><strong>Recipe ID:</strong> {{ test_recipe.recipe_id or 'N/A' }}</div>
        {% endif %}
        <form method="get" action="/parser_debug_raw/{{ test_recipe.id }}" style="margin-top:0.5em;">
            <button type="submit" class="btn btn-outline-dark btn-sm">View Raw Data</button>
        </form>
        <!-- Confirmed Parser Fields Table (with delete) -->
        
    </div>
</div>
<div class="parser-debug-container">
    <!-- Event Details (Full Record) card removed as requested -->
    <div class="parser-debug-col">
        <div class="card mb-3">
            <div class="card-header bg-secondary text-white">Source URL</div>
            <div class="card-body"><a href="{{ test_recipe.upload_source_detail }}" target="_blank">{{ test_recipe.upload_source_detail }}</a></div>
        </div>
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">Title</div>
            <div class="card-body">
                {% if confirmed.title %}
                    <span style="color: #388e3c; font-weight: bold;">{{ confirmed.title }}</span>
                    <span class="text-muted" style="font-size:0.95em;">(confirmed)</span>
                {% else %}
                    {{ test_recipe.upload_source_detail }}
                {% endif %}
            </div>
        </div>
        <div class="card mb-3">
            <div class="card-header bg-secondary text-white">Serving Size</div>
            <div class="card-body">{{ test_recipe.serving_size or 'N/A' }}</div>
        </div>
        <div class="card mb-3">
            <div class="card-header bg-success text-white">Ingredients</div>
            <div class="card-body">{{ test_recipe.ingredients or 'No ingredients found.' }}</div>
        </div>
        <div class="card mb-3">
            <div class="card-header bg-warning text-dark">Instructions</div>
            <div class="card-body">{{ test_recipe.instructions or 'No instructions found.' }}</div>
        </div>
    </div>
    <div class="parser-debug-col">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">Actions</div>
            <div class="card-body">
                <form method="get" action="/debug_source_url/{{ test_recipe.id }}" style="display:inline-block;">
                    <button type="submit" class="grey-btn">URL DEBUG</button>
                </form>
                <form method="post" action="/confirm_field" style="display:inline-block; margin-left: 0.5em;">
                    <input type="hidden" name="field" value="source_url">
                    <input type="hidden" name="parser_debug_id" value="{{ parser_debug_id }}">
                    <button type="submit" class="grey-btn bg-secondary text-white">CONFIRM</button>
                </form>
                <hr>
                <form method="get" action="/debug_title/{{ parser_debug_id }}" style="display:inline-block;">
                                <!-- Debug Info Block: Show all IDs being used -->
                                <div class="mb-2" style="font-size:0.95em; color:#333; background:#f8f9fa; border:1px solid #ccc; padding:6px;">
                                    <b>Debug Info:</b><br>
                                    parser_debug_id: <span style="color:#1976d2; font-weight:bold;">{{ parser_debug_id }}</span><br>
                                    test_recipe.id: <span style="color:#388e3c; font-weight:bold;">{{ test_recipe.id }}</span><br>
                                    upload_source_detail: <span style="color:#8e24aa; font-weight:bold;">{{ test_recipe.upload_source_detail }}</span><br>
                                </div>
                {% if parser_debug_id %}
                    <form method="get" action="/debug_title/{{ parser_debug_id }}" style="display:inline-block;">
                        <button type="submit" class="debug-btn" style="background:#1976d2; color:#fff;">Title DEBUG</button>
                    </form>
                {% else %}
                    {% set fallback_debug_id = None %}
                    {% set max_debug_id = 0 %}
                    {% for row in all_confirmed_parser_fields %}
                        {% if row.parser_debug_id and row.parser_debug_id > max_debug_id %}
                            {% set max_debug_id = row.parser_debug_id %}
                        {% endif %}
                        {% if fallback_debug_id is none and row.parser_debug_id %}
                            {% set fallback_debug_id = row.parser_debug_id %}
                        {% endif %}
                    {% endfor %}
                    {% set next_debug_id = max_debug_id + 1 %}
                    <form method="get" action="/debug_title/{{ fallback_debug_id if fallback_debug_id else next_debug_id }}" style="display:inline-block;">
                        <button type="submit" class="debug-btn" style="background:#1976d2; color:#fff;">Title DEBUG ({{ 'ID from confirmed' if fallback_debug_id else 'Predicted ID: ' ~ next_debug_id }})</button>
                    </form>
                {% endif %}
                </form>
                <!-- DEBUG 2 button removed -->
                </form>
                <form method="post" action="/confirm_field" style="display:inline-block; margin-left: 0.5em;">
                    <input type="hidden" name="field" value="title">
                    <input type="hidden" name="parser_debug_id" value="{{ parser_debug_id }}">
                    <button type="submit" class="debug-btn" style="background:#1976d2; color:#fff;">CONFIRM</button>
                </form>
                <hr>
                <form method="get" action="/debug_serving_size/{{ test_recipe.id }}" style="display:inline-block;">
                                    <!-- Debug Info Block: Show all IDs being used for Serving Size DEBUG -->
                                    <div class="mb-2" style="font-size:0.95em; color:#333; background:#f8f9fa; border:1px solid #ccc; padding:6px;">
                                        <b>Debug Info:</b><br>
                                        parser_debug_id: <span style="color:#1976d2; font-weight:bold;">{{ parser_debug_id }}</span><br>
                                        test_recipe.id: <span style="color:#388e3c; font-weight:bold;">{{ test_recipe.id }}</span><br>
                                        upload_source_detail: <span style="color:#8e24aa; font-weight:bold;">{{ test_recipe.upload_source_detail }}</span><br>
                                    </div>
                    <button type="submit" class="debug-btn" style="background:#8e24aa; color:#fff;">Serves DEBUG</button>
                </form>
                <form method="post" action="/confirm_field" style="display:inline-block; margin-left: 0.5em;">
                    <input type="hidden" name="field" value="serving_size">
                    <input type="hidden" name="parser_debug_id" value="{{ parser_debug_id }}">
                    <button type="submit" class="confirm-btn" style="background:#8e24aa; color:#fff;">CONFIRM</button>
                </form>
                <hr>
                <form method="get" action="/debug_ingredients/{{ test_recipe.id }}" style="display:inline-block;">
                    <button type="submit" class="debug-btn">Ingredients DEBUG</button>
                </form>
                <form method="post" action="/confirm_field" style="display:inline-block; margin-left: 0.5em;">
                    <input type="hidden" name="field" value="ingredients">
                    <input type="hidden" name="parser_debug_id" value="{{ parser_debug_id }}">
                    <button type="submit" class="confirm-btn bg-success text-white">CONFIRM</button>
                </form>
                <hr>
                <form method="get" action="/debug_instructions/{{ test_recipe.id }}" style="display:inline-block;">
                    <button type="submit" class="debug-btn" style="background:#ffc107; color:#222;">Instructions DEBUG</button>
                </form>
                <form method="post" action="/confirm_field" style="display:inline-block; margin-left: 0.5em;">
                    <input type="hidden" name="field" value="instructions">
                    <input type="hidden" name="parser_debug_id" value="{{ parser_debug_id }}">
                    <button type="submit" class="confirm-btn bg-warning text-dark">CONFIRM</button>
                </form>
            </div>
        </div>
    </div>
    <!-- Confirmed Values block removed as requested -->
</div>
</div>
{% endblock %}
