{% extends "base.html" %}
{% block content %}
<style>
.nav-btn-wide {
        min-width: 170px;
        min-height: 48px;
        font-size: 1em;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 18px;
        white-space: pre-line;
        text-align: center;
}
</style>
<div style="display: flex; flex-direction: row; gap: 32px; align-items: flex-start;">
    <div style="flex: 1; min-width: 400px;">
        <div style="display: flex; justify-content: flex-end; margin-bottom: 1em; gap: 18px;">
            <a href="/parser_debug_raw/{{ test_recipe_id }}" class="btn btn-outline-secondary nav-btn-wide">View\nRaw\nData2</a>
            <a href="{{ url_for('admin_task.admin_recipe_book_setup') }}" class="btn btn-secondary nav-btn-wide" style="margin-left:8px;">Back to\nRecipe Index</a>
            <a href="{{ url_for('debug_parser.parser_debug', test_recipe_id=test_recipe_id) }}" class="btn btn-secondary nav-btn-wide" style="margin-left:8px; background:#607d8b; color:#fff;">Back to\nParser DEBUG</a>
            <div style="display: flex; gap: 12px;">
                <div style="min-width: 180px;">
                    <div id="instructionsBlockHeader" style="background: #1976d2; color: #fff; font-weight: bold; padding: 8px 12px; border-radius: 6px 6px 0 0; margin-bottom: 0;">Instructions</div>
                    <div id="instructionsBlockBox" style="border: 1px solid #1976d2; border-top: none; border-radius: 0 0 6px 6px; padding: 10px 12px 10px 12px; margin-bottom: 18px; font-size: 1em; background: #fff; color: #222; min-height: 48px; display: flex; align-items: center;">
                        <span id="instructionsBlockText">{{ best_guess or raw_instructions or '(No instructions found)' }}</span>
                    </div>
                </div>
                <div style="min-width: 180px;">
                    <div style="background: #8e24aa; color: #fff; font-weight: bold; padding: 8px 12px; border-radius: 6px 6px 0 0; margin-bottom: 0;">Solution</div>
                    <div id="solutionBox" style="border: 1px solid #8e24aa; border-top: none; border-radius: 0 0 6px 6px; padding: 10px 12px 10px 12px; margin-bottom: 18px; font-size: 1em; background: #fff; color: #222; min-height: 48px;">
                        <textarea id="solutionInput" style="width: 100%; min-height: 40px; resize: vertical; font-size: 1em;"></textarea>
                        <button id="sendSolutionBtn" style="margin-top: 10px; background: #8e24aa; color: #fff; border: none; border-radius: 4px; padding: 6px 16px; font-weight: bold; cursor: pointer;">SEND SOLUTION</button>
                    </div>
                </div>
            </div>
        </div>
                </div>
</div>

<div style="max-width: 800px; margin: 32px auto 0 auto;">
        <div style="font-weight: bold; margin-bottom: 8px;">Instructions Extraction Strategies</div>
        <button id="runStrategiesBtn" style="margin-bottom: 10px; background: #8e24aa; color: #fff; border: none; border-radius: 4px; padding: 6px 16px; font-weight: bold; cursor: pointer;">Run Strategies</button>
        <table id="strategiesTable" style="border-collapse: collapse; width: 100%; margin-top: 8px;">
                <thead>
                        <tr style="background: #e3eafc;">
                                <th style="border: 1px solid #b0b0b0; padding: 4px 8px;">Strategy</th>
                                <th style="border: 1px solid #b0b0b0; padding: 4px 8px;">Applied</th>
                                <th style="border: 1px solid #b0b0b0; padding: 4px 8px;">Result</th>
                                <th style="border: 1px solid #b0b0b0; padding: 4px 8px;">Solved</th>
                        </tr>
                </thead>
                <tbody>
                        {% for strat in test_recipe.strategies %}
                        <tr>
                                <td>{{ strat.name }}</td>
                                <td>{{ '✔' if strat.applied else '—' }}</td>
                                <td>{{ strat.result }}</td>
                                <td>{{ '✔' if strat.solved else '' }}</td>
                        </tr>
                        {% endfor %}
                </tbody>
        </table>
</div>
{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
        const solutionInput = document.getElementById('solutionInput');
        const sendSolutionBtn = document.getElementById('sendSolutionBtn');
        sendSolutionBtn.addEventListener('click', function() {
                const solution = solutionInput.value.trim();
                if (!solution) {
                        alert('Please enter a solution before sending.');
                        return;
                }
                sendSolutionBtn.disabled = true;
                sendSolutionBtn.textContent = 'Sending...';
                const parserDebugId = window.location.pathname.match(/\d+$/)[0];
                fetch(`/api/save_instructions_solution/${parserDebugId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ solution: solution })
                })
                .then(response => response.json())
                .then(data => {
                        if (data.success) {
                                sendSolutionBtn.textContent = 'Sent!';
                                setTimeout(() => window.location.reload(), 800);
                        } else {
                                sendSolutionBtn.disabled = false;
                                sendSolutionBtn.textContent = 'SEND SOLUTION';
                                alert(data.error || 'Failed to save solution.');
                        }
                })
                .catch(() => {
                        sendSolutionBtn.disabled = false;
                        sendSolutionBtn.textContent = 'SEND SOLUTION';
                        alert('Failed to send solution.');
                });
        });

        // Stepwise runner for Instructions strategies
        const runBtn = document.getElementById('runStrategiesBtn');
        const table = document.getElementById('strategiesTable');
        const rows = table.querySelectorAll('tbody tr');
        let current = 0;

        // Add solved/next buttons to each row
        rows.forEach((row, i) => {
                if (!row.querySelector('.solvedBtn')) {
                        const td = row.querySelector('td:last-child');
                        if (td) {
                                const solvedBtn = document.createElement('button');
                                solvedBtn.className = 'solvedBtn';
                                solvedBtn.style.display = 'none';
                                solvedBtn.style.background = '#43a047';
                                solvedBtn.style.color = '#fff';
                                solvedBtn.style.border = 'none';
                                solvedBtn.style.borderRadius = '4px';
                                solvedBtn.style.padding = '2px 10px';
                                solvedBtn.style.fontSize = '0.95em';
                                solvedBtn.style.cursor = 'pointer';
                                solvedBtn.textContent = '✔️';
                                td.appendChild(solvedBtn);
                                const nextBtn = document.createElement('button');
                                nextBtn.className = 'nextBtn';
                                nextBtn.style.display = 'none';
                                nextBtn.style.background = '#8e24aa';
                                nextBtn.style.color = '#fff';
                                nextBtn.style.border = 'none';
                                nextBtn.style.borderRadius = '4px';
                                nextBtn.style.padding = '2px 10px';
                                nextBtn.style.fontSize = '0.95em';
                                nextBtn.style.cursor = 'pointer';
                                nextBtn.textContent = '➡️';
                                td.appendChild(nextBtn);
                        }
                }
        });

        function resetTable() {
                rows.forEach(row => {
                        row.cells[1].textContent = '—'; // Applied
                        row.cells[2].textContent = '—'; // Result
                        const solvedBtn = row.querySelector('.solvedBtn');
                        const nextBtn = row.querySelector('.nextBtn');
                        if (solvedBtn) {
                                solvedBtn.style.display = 'none';
                                solvedBtn.disabled = false;
                                solvedBtn.style.background = '#43a047';
                                solvedBtn.textContent = '✔️';
                        }
                        if (nextBtn) {
                                nextBtn.style.display = 'none';
                                nextBtn.disabled = false;
                        }
                });
        }

        function runStrategies() {
                resetTable();
                current = 0;
                runNext();
        }

        function runNext() {
                if (current >= rows.length) {
                        return;
                }
                const row = rows[current];
                row.cells[1].textContent = '⏳'; // Applied
                // Call backend for each strategy step
                const testRecipeId = window.location.pathname.match(/\d+$/);
                fetch(`/run_instructions_strategy/${testRecipeId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ current_step: current })
                })
                .then(resp => resp.json())
                .then(data => {
                        row.cells[1].textContent = '✅'; // Applied
                        row.cells[2].textContent = data.result || '(no result)'; // Result
                        const solvedBtn = row.querySelector('.solvedBtn');
                        const nextBtn = row.querySelector('.nextBtn');
                        if (solvedBtn) solvedBtn.style.display = '';
                        if (nextBtn) nextBtn.style.display = '';
                        if (solvedBtn) {
                                solvedBtn.onclick = () => {
                                        solvedBtn.style.background = '#388e3c';
                                        solvedBtn.textContent = '✔️ Solved';
                                        solvedBtn.disabled = true;
                                        // Auto-fill solution box with result if not empty
                                        if (data.result && data.result !== '(No match found)' && data.result !== 'N/A') {
                                                solutionInput.value = data.result;
                                        }
                                };
                        }
                        if (nextBtn) {
                                nextBtn.onclick = () => {
                                        if (solvedBtn) solvedBtn.disabled = true;
                                        nextBtn.disabled = true;
                                        current++;
                                        runNext();
                                };
                        }
                })
                .catch(() => {
                        row.cells[1].textContent = '❌';
                        row.cells[2].textContent = 'API error';
                        const solvedBtn = row.querySelector('.solvedBtn');
                        const nextBtn = row.querySelector('.nextBtn');
                        if (solvedBtn) solvedBtn.style.display = '';
                        if (nextBtn) nextBtn.style.display = '';
                });
        }

        if (runBtn) {
                runBtn.onclick = runStrategies;
        }
});
</script>
{% endblock %}
